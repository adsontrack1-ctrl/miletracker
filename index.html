<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MileTracker">
<meta name="theme-color" content="#0a0a1a">
<link rel="manifest" href="manifest.json">
<title>MileTracker - Smart Mileage Tracking</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, deleteDoc, writeBatch, onSnapshot }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // =============================================
  // ðŸ”§ PASTE YOUR FIREBASE CONFIG HERE
  // Get this from: Firebase Console â†’ Project Settings â†’ Your apps â†’ SDK setup
  // =============================================
  const firebaseConfig = {
    apiKey: "AIzaSyCOmth_ROgpSK54nIUoszVf9kBO0Mf1oPM",
    authDomain: "mile-tracker-71aee.firebaseapp.com",
    projectId: "mile-tracker-71aee",
    storageBucket: "mile-tracker-71aee.firebasestorage.app",
    messagingSenderId: "704629301384",
    appId: "1:704629301384:web:ba4842eff8654bc1d2bf3d",
    measurementId: "G-THHCMF6K7S"
  };
  // =============================================

  // Check if config has been filled in
  const isConfigured = firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY";

  if (!isConfigured) {
    // Show config needed screen instead of login
    const showConfigScreen = () => {
      const ls = document.getElementById('login-screen');
      const cs = document.getElementById('config-screen');
      if (ls) ls.classList.remove('show');
      if (cs) cs.style.display = 'flex';
    };
    if (document.readyState === 'loading') {
      window.addEventListener('DOMContentLoaded', showConfigScreen);
    } else {
      showConfigScreen();
      // Also try after a short delay in case DOM isn't fully ready
      setTimeout(showConfigScreen, 100);
    }
    window._signIn = () => alert('Please add your Firebase config first. See the setup guide.');
    window._signOut = () => {};
    window._saveTrip = () => {};
    window._deleteTrip = () => {};
    window._saveSettings = () => {};
    window._clearAllFirestore = () => {};
  } else {
    // Firebase is configured â€” initialize normally
    let unsubscribeFirestore = null;

    try {
      const firebaseApp = initializeApp(firebaseConfig);
      const auth = getAuth(firebaseApp);
      const db = getFirestore(firebaseApp);
      const provider = new GoogleAuthProvider();
      provider.setCustomParameters({ prompt: 'select_account' });

      window._fb = { auth, db, provider };

      // Auth state listener
      onAuthStateChanged(auth, (user) => {
        window._currentUser = user;
        if (user) {
          if (typeof showApp === 'function') showApp(user);
          loadFromFirestore(user.uid);
        } else {
          if (typeof showLogin === 'function') showLogin();
        }
      });

      window._signIn = async () => {
        const btn = document.getElementById('signin-btn');
        const original = btn.innerHTML;
        try {
          btn.innerHTML = '<span style="opacity:0.7">Signing in...</span>';
          btn.disabled = true;
          await signInWithPopup(auth, provider);
        } catch(e) {
          console.error('Sign-in error:', e.code, e.message);
          btn.innerHTML = original;
          btn.disabled = false;
          if (e.code === 'auth/popup-blocked') {
            if (typeof showToast === 'function') showToast('Popup blocked! Allow popups for this site.');
            else alert('Popup blocked! Please allow popups for this site in your browser settings.');
          } else if (e.code === 'auth/unauthorized-domain') {
            if (typeof showToast === 'function') showToast('Domain not authorized. Check Firebase settings.');
            else alert('This domain is not authorized in Firebase.\nGo to Firebase Console â†’ Authentication â†’ Settings â†’ Authorized domains\nand add: ' + window.location.hostname);
          } else if (e.code === 'auth/cancelled-popup-request' || e.code === 'auth/popup-closed-by-user') {
            btn.innerHTML = original; // user closed popup, no error needed
          } else {
            if (typeof showToast === 'function') showToast('Sign-in failed: ' + (e.code || e.message));
            else alert('Sign-in error: ' + e.message);
          }
        }
      };

      window._signOut = async () => {
        if (!confirm('Sign out of MileTracker?')) return;
        if (unsubscribeFirestore) { unsubscribeFirestore(); unsubscribeFirestore = null; }
        await signOut(auth);
      };

      async function loadFromFirestore(uid) {
        try {
          const settingsDoc = await getDoc(doc(db, 'users', uid, 'data', 'settings'));
          if (settingsDoc.exists()) {
            app.settings = { ...app.settings, ...settingsDoc.data() };
          }
          const addrDoc = await getDoc(doc(db, 'users', uid, 'data', 'addresses'));
          if (addrDoc.exists()) {
            app.savedAddresses = addrDoc.data().addresses || {};
          }
          const tripsRef = collection(db, 'users', uid, 'trips');
          if (unsubscribeFirestore) unsubscribeFirestore();
          unsubscribeFirestore = onSnapshot(tripsRef, (snapshot) => {
            app.trips = [];
            snapshot.forEach(d => app.trips.push({ id: d.id, ...d.data() }));
            app.trips.sort((a,b) => new Date(b.date) - new Date(a.date));
            if (typeof updateHomeStats === 'function') updateHomeStats();
            if (typeof updateNotifBadge === 'function') updateNotifBadge();
            const tp = document.getElementById('page-trips');
            const dp = document.getElementById('page-dashboard');
            if (tp && tp.classList.contains('active') && typeof renderTrips === 'function') renderTrips();
            if (dp && dp.classList.contains('active') && typeof renderDashboard === 'function') renderDashboard();
          }, (err) => {
            console.error('Firestore snapshot error:', err);
          });
          if (typeof updateHomeStats === 'function') updateHomeStats();
          if (typeof renderSettings === 'function') renderSettings();
        } catch(e) {
          console.error('Firestore load error:', e);
          if (typeof showToast === 'function') showToast('Cloud sync error. Working offline.');
        }
      }

      window._saveTrip = async (trip) => {
        if (!window._currentUser) return;
        try {
          const tripData = { ...trip };
          delete tripData.id;
          await setDoc(doc(db, 'users', window._currentUser.uid, 'trips', trip.id), tripData);
        } catch(e) { console.error('Save trip error:', e); }
      };

      window._deleteTrip = async (tripId) => {
        if (!window._currentUser) return;
        try {
          await deleteDoc(doc(db, 'users', window._currentUser.uid, 'trips', tripId));
        } catch(e) { console.error('Delete trip error:', e); }
      };

      window._saveSettings = async () => {
        if (!window._currentUser) return;
        try {
          const uid = window._currentUser.uid;
          await setDoc(doc(db, 'users', uid, 'data', 'settings'), app.settings);
          await setDoc(doc(db, 'users', uid, 'data', 'addresses'), { addresses: app.savedAddresses });
        } catch(e) { console.error('Save settings error:', e); }
      };

      window._clearAllFirestore = async () => {
        if (!window._currentUser) return;
        try {
          const uid = window._currentUser.uid;
          const tripsRef = collection(db, 'users', uid, 'trips');
          const snap = await getDoc(doc(db, 'users', uid, 'trips', '_placeholder')); // check access
          const { getDocs } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
          const allTrips = await getDocs(tripsRef);
          const batch = writeBatch(db);
          allTrips.forEach(d => batch.delete(d.ref));
          await batch.commit();
          await setDoc(doc(db, 'users', uid, 'data', 'addresses'), { addresses: {} });
        } catch(e) { console.error('Clear error:', e); }
      };

    } catch(initError) {
      console.error('Firebase init error:', initError);
      window._signIn = () => {
        alert('Firebase initialization failed.\n\nError: ' + initError.message + '\n\nCheck that your firebaseConfig values are correct in index.html');
      };
      window._signOut = window._saveTrip = window._deleteTrip = window._saveSettings = window._clearAllFirestore = () => {};
    }
  }
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

:root {
  --bg: #0a0a1a;
  --bg-secondary: #12122a;
  --card: rgba(255, 255, 255, 0.06);
  --card-border: rgba(255, 255, 255, 0.08);
  --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  --blue: #4F8EF7;
  --blue-light: rgba(79, 142, 247, 0.15);
  --teal: #00D4AA;
  --teal-light: rgba(0, 212, 170, 0.15);
  --pink: #FF6B9D;
  --pink-light: rgba(255, 107, 157, 0.15);
  --green: #00E676;
  --green-light: rgba(0, 230, 118, 0.15);
  --orange: #FFB74D;
  --red: #FF5252;
  --purple: #6C63FF;
  --text: #FFFFFF;
  --text2: rgba(255, 255, 255, 0.6);
  --text3: rgba(255, 255, 255, 0.3);
  --safe-top: env(safe-area-inset-top, 20px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(135deg, var(--bg) 0%, var(--bg-secondary) 100%);
  color: var(--text);
  min-height: 100vh;
  min-height: 100dvh;
  overflow-x: hidden;
}

/* ===== LOGIN SCREEN ===== */
#login-screen {
  display: none;
  position: fixed;
  inset: 0;
  background: linear-gradient(135deg, #0a0a1a 0%, #12122a 50%, #1a0a2e 100%);
  z-index: 1000;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 24px;
  text-align: center;
}
#login-screen.show { display: flex; }

.login-logo {
  width: 80px;
  height: 80px;
  background: linear-gradient(135deg, #4F8EF7 0%, #6C63FF 100%);
  border-radius: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 24px;
  box-shadow: 0 20px 60px rgba(79, 142, 247, 0.4);
}
.login-logo svg { width: 48px; height: 48px; fill: white; }

.login-title {
  font-size: 36px;
  font-weight: 800;
  letter-spacing: -1px;
  margin-bottom: 8px;
  background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.7) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.login-sub {
  font-size: 16px;
  color: var(--text2);
  margin-bottom: 60px;
  line-height: 1.5;
}

.login-features {
  display: flex;
  flex-direction: column;
  gap: 14px;
  margin-bottom: 52px;
  width: 100%;
  max-width: 320px;
}
.login-feature {
  display: flex;
  align-items: center;
  gap: 14px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 14px;
  padding: 14px 18px;
  text-align: left;
}
.login-feature .feat-icon { font-size: 24px; flex-shrink: 0; }
.login-feature .feat-text h4 { font-size: 14px; font-weight: 600; }
.login-feature .feat-text p { font-size: 12px; color: var(--text2); margin-top: 2px; }

#signin-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  width: 100%;
  max-width: 320px;
  padding: 16px 24px;
  background: white;
  color: #1a1a2e;
  border: none;
  border-radius: 14px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
  box-shadow: 0 8px 32px rgba(79, 142, 247, 0.3);
  transition: all 0.3s ease;
}
#signin-btn:active { transform: scale(0.97); }
#signin-btn svg { width: 22px; height: 22px; }

.login-privacy {
  font-size: 11px;
  color: var(--text3);
  margin-top: 16px;
  max-width: 280px;
  line-height: 1.5;
}

/* ===== APP SHELL ===== */
#app-shell { display: none; }
#app-shell.show { display: block; }

/* HEADER */
.app-header {
  background: #0a0a1a;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  padding: calc(var(--safe-top) + 12px) 20px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
}
.header-left { display: flex; align-items: center; gap: 12px; }
.header-logo {
  width: 40px; height: 40px;
  background: linear-gradient(135deg, #4F8EF7 0%, #6C63FF 100%);
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 8px 24px rgba(79, 142, 247, 0.3);
}
.header-logo svg { width: 24px; height: 24px; fill: white; }
.header-title { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
.header-right { display: flex; align-items: center; gap: 10px; }
.header-btn {
  width: 40px; height: 40px; border-radius: 12px;
  background: rgba(255,255,255,0.08); border: 1px solid var(--card-border);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: var(--text2); font-size: 18px; transition: all 0.3s ease;
}
.header-btn:hover { background: rgba(255,255,255,0.12); color: var(--blue); }

/* User avatar */
.user-avatar {
  width: 36px; height: 36px; border-radius: 50%;
  background: linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%);
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 700; color: white; cursor: pointer;
  border: 2px solid rgba(79,142,247,0.4); overflow: hidden;
  flex-shrink: 0;
}
.user-avatar img { width: 100%; height: 100%; object-fit: cover; }

/* Sync status dot */
.sync-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--green);
  animation: glow-pulse 3s infinite;
  flex-shrink: 0;
}
.sync-dot.syncing { background: var(--orange); animation: blink 0.8s infinite; }
.sync-dot.offline { background: var(--red); animation: none; }

/* STATUS BAR */
.status-bar {
  background: #0d0d20;
  border-bottom: 1px solid rgba(255,255,255,0.06);
  padding: 12px 20px;
  display: flex; align-items: center; gap: 10px;
}
.status-dot { width:10px; height:10px; border-radius:50%; background:var(--text3); flex-shrink:0; }
.status-dot.active { background:var(--green); animation:glow-pulse 2s infinite; }
.status-dot.searching { background:var(--orange); animation:blink 1.2s infinite; }
.status-dot.error { background:var(--red); }
.status-text { font-size:13px; color:var(--text2); }

/* BOTTOM NAV */
.bottom-nav {
  position: fixed; bottom:0; left:0; right:0;
  background: #0a0a1a; border-top: 1px solid rgba(255,255,255,0.08);
  display: flex; padding: 8px 0 calc(8px + var(--safe-bottom)); z-index:100;
}
.nav-item {
  flex:1; display:flex; flex-direction:column; align-items:center; gap:4px;
  padding:8px 0; border:none; background:none; cursor:pointer; font-family:inherit;
  position:relative; transition:all 0.3s ease;
}
.nav-item svg { width:24px; height:24px; fill:var(--text3); transition:all 0.3s ease; }
.nav-item span { font-size:10px; font-weight:500; color:var(--text3); transition:all 0.3s ease; }
.nav-item.active svg { fill:var(--blue); }
.nav-item.active span { color:var(--blue); }
.nav-item.active::before {
  content:''; position:absolute; top:0; left:50%; transform:translateX(-50%);
  width:20px; height:3px;
  background:linear-gradient(90deg, var(--blue) 0%, var(--teal) 100%); border-radius:2px;
}

/* PAGES */
.page { display:none; padding:0 0 100px; }
.page.active { display:block; }

/* ANIMATIONS */
@keyframes glow-pulse { 0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(79,142,247,0.7);}50%{opacity:0.8;box-shadow:0 0 0 10px rgba(79,142,247,0);} }
@keyframes blink { 0%,100%{opacity:1;}50%{opacity:0.2;} }
@keyframes record-pulse { 0%,100%{box-shadow:0 0 0 0 rgba(255,82,82,0.7);}50%{box-shadow:0 0 0 15px rgba(255,82,82,0);} }
@keyframes slide-up { from{transform:translateY(100%);opacity:0;}to{transform:translateY(0);opacity:1;} }
@keyframes fade-in { from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);} }

/* DRIVE PAGE */
.drive-hero { background:#0d0d20; border-bottom:1px solid rgba(255,255,255,0.06); padding:32px 20px 24px; text-align:center; }
.drive-circle { width:140px; height:140px; border-radius:50%; margin:0 auto 20px; position:relative; display:flex; align-items:center; justify-content:center; transition:all 0.3s ease; }
.drive-circle.monitoring { background:rgba(0,230,118,0.15); border:3px solid var(--green); box-shadow:0 0 30px rgba(0,230,118,0.3); }
.drive-circle.recording { background:rgba(255,82,82,0.15); border:3px solid var(--red); animation:record-pulse 2s infinite; box-shadow:0 0 30px rgba(255,82,82,0.4); }
.drive-circle.inactive { background:rgba(255,255,255,0.04); border:3px solid var(--text3); }
.drive-circle-inner { font-size:48px; line-height:1; }
.drive-label { font-size:24px; font-weight:700; margin-bottom:6px; }
.drive-sublabel { font-size:14px; color:var(--text2); margin-bottom:20px; line-height:1.5; }
.drive-speed { display:inline-flex; align-items:baseline; gap:6px; background:rgba(79,142,247,0.15); padding:12px 28px; border-radius:24px; margin-bottom:10px; border:1px solid rgba(79,142,247,0.3); }
.drive-speed .num { font-size:40px; font-weight:300; color:var(--blue); }
.drive-speed .unit { font-size:14px; color:var(--text2); font-weight:500; }
.drive-accuracy { font-size:12px; color:var(--text3); margin-top:8px; }
.live-panel { display:none; background:#0d0d20; border-bottom:1px solid rgba(255,255,255,0.06); padding:24px 20px; text-align:center; animation:slide-up 0.4s ease; }
.live-panel.show { display:block; }
.live-stats { display:flex; justify-content:center; gap:60px; margin:10px 0; }
.live-stat .val { font-size:44px; font-weight:300; color:var(--blue); }
.live-stat .lbl { font-size:12px; color:var(--text2); text-transform:uppercase; letter-spacing:1px; font-weight:600; margin-top:4px; }
.live-speed-inline { font-size:18px; font-weight:600; color:var(--blue); margin-top:12px; }
.gps-activate-wrap { display:none; padding:0 20px 16px; }
.gps-activate-btn { width:100%; padding:16px; border-radius:14px; border:2px solid var(--blue); background:linear-gradient(135deg,rgba(79,142,247,0.2),rgba(108,99,255,0.2)); color:var(--blue); font-size:16px; font-weight:600; cursor:pointer; font-family:inherit; transition:all 0.3s ease; }
.map-btn-wrap { padding:16px; }
.map-btn { width:100%; padding:14px; border-radius:14px; background:rgba(255,255,255,0.06); border:1px solid var(--card-border); color:var(--text); font-size:15px; font-weight:600; cursor:pointer; font-family:inherit; display:flex; align-items:center; justify-content:center; gap:8px; box-shadow:0 4px 15px rgba(0,0,0,0.2); transition:all 0.3s ease; }
.map-btn:hover { background:rgba(255,255,255,0.1); }
.quick-stats { display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:20px 16px 0; }
.quick-stat { background:rgba(255,255,255,0.06); backdrop-filter:blur(20px); border:1px solid var(--card-border); border-radius:16px; padding:20px; box-shadow:0 4px 15px rgba(0,0,0,0.2); transition:all 0.3s ease; }
.quick-stat:hover { background:rgba(255,255,255,0.08); transform:translateY(-2px); }
.quick-stat .icon { font-size:24px; margin-bottom:8px; }
.quick-stat .val { font-size:24px; font-weight:700; line-height:1.1; }
.quick-stat .val.biz { color:var(--blue); }
.quick-stat .val.pers { color:var(--pink); }
.quick-stat .val.ded { color:var(--green); }
.quick-stat .val.trips { color:var(--blue); }
.quick-stat .lbl { font-size:12px; color:var(--text2); margin-top:6px; font-weight:500; }
.uncl-banner { margin:16px 16px 0; background:rgba(255,183,77,0.15); border:1px solid rgba(255,183,77,0.3); border-radius:14px; padding:16px; display:none; }
.uncl-banner.show { display:flex; align-items:center; gap:12px; animation:slide-up 0.3s ease; }
.uncl-banner .icon { font-size:24px; flex-shrink:0; }
.uncl-banner .info h4 { font-size:14px; font-weight:600; color:var(--orange); }
.uncl-banner .info p { font-size:12px; color:var(--text2); margin-top:2px; }
.manual-btn-wrap { padding:12px 16px 0; }
.manual-btn { width:100%; padding:14px; border:2px dashed var(--card-border); border-radius:14px; background:rgba(255,255,255,0.03); color:var(--text2); font-size:14px; font-weight:500; cursor:pointer; font-family:inherit; display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.3s ease; }
.manual-btn:hover { border-color:var(--card-border); background:rgba(255,255,255,0.06); color:var(--text); }
.debug-log { margin:16px; font-size:10px; color:var(--text3); text-align:left; max-height:80px; overflow-y:auto; background:rgba(255,255,255,0.04); border-radius:10px; padding:10px; font-family:'SF Mono',monospace; }

/* MAP OVERLAY */
.map-overlay { position:fixed; inset:0; z-index:200; background:#f5f5f5; display:none; flex-direction:column; }
.map-overlay.show { display:flex; }
.map-header { background:#ffffff; padding:calc(var(--safe-top)+8px) 16px 12px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #e0e0e0; z-index:201; }
.map-header h3 { font-size:18px; font-weight:700; color:#1a1a2e; }
.map-close { background:#f0f0f0; border:none; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; cursor:pointer; color:#333; transition:all 0.3s ease; }
.map-trip-count { font-size:11px; font-weight:600; padding:3px 10px; border-radius:12px; background:#e8f0fe; color:#1a73e8; }
.map-filter-bar { display:flex; gap:6px; padding:10px 16px; background:#ffffff; border-bottom:1px solid #e0e0e0; z-index:202; overflow-x:auto; }
.map-filter-pill { padding:6px 16px; border-radius:20px; border:1px solid #ddd; background:#fff; color:#666; font-size:12px; font-weight:600; cursor:pointer; font-family:inherit; white-space:nowrap; transition:all 0.3s ease; }
.map-filter-pill.active { background:#1a73e8; border-color:#1a73e8; color:white; }
.map-legend { display:flex; gap:14px; padding:8px 16px; background:rgba(255,255,255,0.95); position:absolute; bottom:180px; left:12px; border-radius:12px; z-index:203; border:1px solid #e0e0e0; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.map-legend-item { display:flex; align-items:center; gap:5px; font-size:11px; color:#555; font-weight:500; }
.map-legend-dot { width:8px; height:8px; border-radius:50%; }
.map-trips-panel { position:absolute; bottom:0; left:0; right:0; max-height:55vh; background:rgba(255,255,255,0.97); border-top:1px solid #e0e0e0; border-radius:20px 20px 0 0; z-index:204; overflow-y:auto; transition:max-height 0.3s ease; box-shadow:0 -4px 20px rgba(0,0,0,0.1); }
.map-trips-panel.collapsed { max-height:70px; overflow:hidden; }
.map-trips-handle { display:flex; justify-content:center; padding:10px; cursor:pointer; }
.map-trips-handle-bar { width:40px; height:4px; border-radius:2px; background:#ccc; }
.map-trips-summary { display:flex; gap:10px; padding:0 16px 12px; border-bottom:1px solid #eee; }
.map-sum-card { flex:1; text-align:center; padding:10px 6px; border-radius:12px; background:#f8f9fa; border:1px solid #eee; }
.map-sum-card .val { font-size:20px; font-weight:700; line-height:1; color:#1a1a2e; }
.map-sum-card .lbl { font-size:10px; color:#888; margin-top:3px; text-transform:uppercase; letter-spacing:0.5px; }
.map-trips-list { padding:8px 12px 20px; }
.map-trip-item { display:flex; align-items:center; gap:10px; padding:12px; margin-bottom:6px; border-radius:12px; background:#fff; border:1px solid #eee; cursor:pointer; transition:all 0.2s ease; }
.map-trip-item:active { transform:scale(0.98); }
.map-trip-item.selected { border-color:#1a73e8; background:#e8f0fe; }
.map-trip-dot { width:12px; height:12px; border-radius:50%; flex-shrink:0; }
.map-trip-dot.business { background:#00D4AA; }
.map-trip-dot.personal { background:#FF6B9D; }
.map-trip-dot.unclassified { background:#FFB74D; }
.map-trip-info { flex:1; min-width:0; }
.map-trip-info .route { font-size:13px; font-weight:600; color:#1a1a2e; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.map-trip-info .meta { font-size:11px; color:#888; margin-top:2px; }
.map-trip-miles { text-align:right; flex-shrink:0; }
.map-trip-miles .mi { font-size:16px; font-weight:700; color:#1a1a2e; }
.map-trip-miles .unit { font-size:10px; color:#aaa; }
#map-container { flex:1; }

/* TRIPS */
.trips-header { background:#0d0d20; border-bottom:1px solid rgba(255,255,255,0.06); padding:20px 20px 0; }
.trips-header h2 { font-size:28px; font-weight:700; margin-bottom:16px; }
.filter-row { display:flex; gap:0; }
.filter-tab { flex:1; padding:12px 0; text-align:center; font-size:14px; font-weight:500; color:var(--text3); border:none; background:none; cursor:pointer; font-family:inherit; position:relative; transition:all 0.3s ease; }
.filter-tab:hover { color:var(--text2); }
.filter-tab.active { color:var(--blue); font-weight:600; }
.filter-tab.active::after { content:''; position:absolute; bottom:-1px; left:10%; right:10%; height:3px; background:linear-gradient(90deg,var(--blue),var(--teal)); border-radius:2px; }
.trips-list { padding:16px; }
.trip-date-header { font-size:12px; font-weight:600; color:var(--text2); padding:12px 4px 8px; text-transform:uppercase; letter-spacing:0.5px; }
.trip-card { background:rgba(255,255,255,0.06); border:1px solid var(--card-border); border-radius:16px; margin-bottom:12px; box-shadow:0 4px 15px rgba(0,0,0,0.2); overflow:hidden; transition:all 0.3s ease; }
.trip-card:hover { background:rgba(255,255,255,0.08); border-color:rgba(255,255,255,0.12); }
.trip-card:active { transform:scale(0.98); }
.trip-mini-map { width:100%; height:90px; background:#1a1a2e; position:relative; overflow:hidden; }
.map-category-badge { position:absolute; top:8px; right:8px; padding:4px 10px; border-radius:8px; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; }
.map-category-badge.business { background:rgba(0,212,170,0.25); color:#00D4AA; border:1px solid rgba(0,212,170,0.3); }
.map-category-badge.personal { background:rgba(255,107,157,0.25); color:#FF6B9D; border:1px solid rgba(255,107,157,0.3); }
.map-category-badge.unclassified { background:rgba(255,183,77,0.25); color:#FFB74D; border:1px solid rgba(255,183,77,0.3); }
.trip-route-section { padding:14px 16px 10px; }
.trip-route-row { display:flex; align-items:flex-start; gap:10px; }
.trip-route-dots { display:flex; flex-direction:column; align-items:center; padding-top:2px; flex-shrink:0; }
.route-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.route-dot.start { background:#00E676; border:2px solid rgba(0,230,118,0.3); }
.route-dot.end { background:#FF5252; border:2px solid rgba(255,82,82,0.3); }
.route-line { width:2px; height:20px; background:rgba(255,255,255,0.15); margin:3px 0; }
.trip-route-addrs { flex:1; min-width:0; }
.trip-addr { font-size:14px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:1.2; }
.trip-addr.to { margin-top:16px; }
.trip-miles-badge { flex-shrink:0; text-align:right; padding-top:8px; }
.trip-miles-badge .mi-val { font-size:24px; font-weight:800; line-height:1; }
.trip-miles-badge .mi-unit { font-size:11px; color:var(--text3); font-weight:500; }
.trip-meta-row { display:flex; align-items:center; justify-content:space-between; padding:8px 16px 12px; font-size:12px; color:var(--text2); }
.trip-meta-left { display:flex; align-items:center; gap:12px; }
.trip-deduction { font-weight:700; color:var(--teal); }
.trip-classify { display:flex; border-top:1px solid var(--card-border); }
.classify-btn { flex:1; padding:12px; border:none; background:none; cursor:pointer; font-family:inherit; font-size:13px; font-weight:600; display:flex; align-items:center; justify-content:center; gap:6px; color:var(--text2); transition:all 0.2s; }
.classify-btn:first-child { border-right:1px solid var(--card-border); }
.classify-btn:active { background:rgba(255,255,255,0.06); }
.classify-btn.sel-biz { color:var(--blue); background:rgba(79,142,247,0.15); }
.classify-btn.sel-pers { color:var(--pink); background:rgba(255,107,157,0.15); }
.classify-btn .dot { width:8px; height:8px; border-radius:50%; border:2px solid currentColor; }
.classify-btn.sel-biz .dot, .classify-btn.sel-pers .dot { background:currentColor; }
.empty-state { text-align:center; padding:80px 20px; color:var(--text3); }
.empty-state .icon { font-size:52px; margin-bottom:16px; opacity:0.5; }
.empty-state h3 { font-size:18px; color:var(--text2); margin-bottom:8px; }
.empty-state p { font-size:14px; }

/* DASHBOARD */
.dash-header { background:#0d0d20; border-bottom:1px solid rgba(255,255,255,0.06); padding:20px; }
.dash-header h2 { font-size:28px; font-weight:700; margin-bottom:16px; }
.period-pills { display:flex; gap:8px; flex-wrap:wrap; }
.period-pill { padding:8px 16px; border-radius:20px; border:1px solid var(--card-border); background:rgba(255,255,255,0.05); color:var(--text2); font-size:13px; font-weight:500; cursor:pointer; font-family:inherit; transition:all 0.3s ease; }
.period-pill.active { background:linear-gradient(135deg,var(--blue),var(--teal)); border-color:transparent; color:white; box-shadow:0 4px 15px rgba(79,142,247,0.3); }
.dash-content { padding:16px; }
.dash-card { background:rgba(255,255,255,0.06); border:1px solid var(--card-border); border-radius:16px; padding:20px; margin-bottom:12px; box-shadow:0 4px 15px rgba(0,0,0,0.2); transition:all 0.3s ease; }
.dash-card:hover { background:rgba(255,255,255,0.08); }
.dash-card-title { font-size:12px; font-weight:700; color:var(--text2); text-transform:uppercase; letter-spacing:1px; margin-bottom:16px; }
.summary-row { display:flex; text-align:center; }
.summary-item { flex:1; padding:12px 0; }
.summary-item:not(:last-child) { border-right:1px solid var(--card-border); }
.summary-item .val { font-size:32px; font-weight:700; line-height:1; }
.summary-item .val.biz { color:var(--blue); }
.summary-item .val.pers { color:var(--pink); }
.summary-item .val.total { color:var(--text); }
.summary-item .lbl { font-size:11px; color:var(--text2); margin-top:6px; font-weight:600; }
.breakdown-bar { height:14px; border-radius:7px; overflow:hidden; display:flex; margin-bottom:14px; background:rgba(255,255,255,0.05); }
.breakdown-bar .seg { height:100%; transition:width 0.5s ease; border-radius:2px 2px 0 0; }
.breakdown-bar .seg.biz { background:linear-gradient(90deg,var(--blue),#5a9dff); }
.breakdown-bar .seg.pers { background:linear-gradient(90deg,var(--pink),#ff8fb5); }
.breakdown-bar .seg.uncl { background:linear-gradient(90deg,var(--orange),#ffc97a); }
.breakdown-legend { display:flex; gap:16px; flex-wrap:wrap; }
.legend-item { display:flex; align-items:center; gap:8px; font-size:12px; color:var(--text2); }
.legend-dot { width:10px; height:10px; border-radius:50%; }
.tax-card { background:linear-gradient(135deg,rgba(0,212,170,0.15),rgba(0,230,118,0.15)); border:1px solid rgba(0,230,118,0.3); }
.tax-card h4 { font-size:14px; font-weight:600; color:var(--green); display:flex; align-items:center; gap:8px; margin-bottom:12px; }
.tax-amount { font-size:42px; font-weight:700; color:var(--green); }
.tax-detail { font-size:12px; color:var(--text2); margin-top:6px; }
.chart-area { height:180px; display:flex; align-items:flex-end; justify-content:space-around; padding:0 4px; margin-bottom:8px; border-bottom:1px solid var(--card-border); }
.chart-col { display:flex; flex-direction:column; align-items:center; gap:2px; flex:1; max-width:40px; }
.chart-stack { display:flex; flex-direction:column-reverse; width:80%; gap:1px; }
.chart-seg { min-height:0; transition:height 0.5s ease; border-radius:2px 2px 0 0; }
.chart-seg.biz { background:linear-gradient(90deg,var(--blue),#5a9dff); }
.chart-seg.pers { background:linear-gradient(90deg,var(--pink),#ff8fb5); }
.export-btns { display:flex; gap:10px; }
.btn-exp { flex:1; padding:12px; border-radius:12px; border:1px solid var(--card-border); background:rgba(255,255,255,0.05); color:var(--text); font-size:14px; font-weight:600; cursor:pointer; font-family:inherit; display:flex; align-items:center; justify-content:center; gap:6px; transition:all 0.3s ease; }
.btn-exp:active { transform:scale(0.96); }

/* Day view */
.add-trip-form { background:rgba(255,255,255,0.06); border:1px solid var(--card-border); border-radius:16px; padding:20px; margin-bottom:16px; }
.add-trip-form h4 { font-size:15px; font-weight:600; margin-bottom:16px; }
.form-row { margin-bottom:14px; }
.form-row label { display:block; font-size:11px; color:var(--text2); margin-bottom:6px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
.form-row input,.form-row select { width:100%; padding:12px; border:1px solid var(--card-border); border-radius:10px; font-size:15px; font-family:inherit; background:rgba(255,255,255,0.05); color:var(--text); -webkit-appearance:none; transition:all 0.3s ease; }
.form-row input:focus,.form-row select:focus { outline:none; background:rgba(255,255,255,0.08); border-color:var(--blue); }
.form-row-inline { display:flex; gap:12px; }
.form-row-inline .form-row { flex:1; }
.calc-distance { display:flex; align-items:center; gap:10px; padding:10px 14px; background:rgba(79,142,247,0.15); border-radius:10px; margin-bottom:14px; font-size:13px; color:var(--blue); font-weight:500; border:1px solid rgba(79,142,247,0.3); }
.form-btns { display:flex; gap:10px; margin-top:16px; }
.form-btns button { flex:1; padding:12px; border-radius:10px; border:none; font-size:15px; font-weight:600; cursor:pointer; font-family:inherit; transition:all 0.3s ease; }
.fbtn-cancel { background:rgba(255,255,255,0.06); color:var(--text); border:1px solid var(--card-border); }
.fbtn-save { background:linear-gradient(135deg,var(--blue),var(--teal)); color:white; box-shadow:0 4px 15px rgba(79,142,247,0.3); }
.fbtn-save:active { transform:scale(0.96); }
.day-trip-row { background:rgba(255,255,255,0.06); border:1px solid var(--card-border); border-radius:14px; padding:14px; margin-bottom:10px; display:flex; align-items:center; gap:12px; transition:all 0.3s ease; }
.day-trip-row .cat-dot { width:12px; height:12px; border-radius:50%; flex-shrink:0; }
.day-trip-row .cat-dot.biz { background:var(--blue); }
.day-trip-row .cat-dot.pers { background:var(--pink); }
.day-trip-row .cat-dot.uncl { background:var(--orange); }
.day-trip-row .route-info { flex:1; }
.day-trip-row .route-info .addr { font-size:14px; font-weight:600; }
.day-trip-row .route-info .meta { font-size:12px; color:var(--text2); margin-top:2px; }
.day-trip-row .miles-col { text-align:right; }
.day-trip-row .miles-col .mi { font-size:18px; font-weight:700; }
.day-trip-row .miles-col .lbl { font-size:10px; color:var(--text2); }

/* NOTIFICATIONS */
.notif-header { background:#0d0d20; border-bottom:1px solid rgba(255,255,255,0.06); padding:20px; }
.notif-header h2 { font-size:28px; font-weight:700; }
.notif-list { padding:16px; }
.notif-card { background:rgba(255,255,255,0.06); border:1px solid var(--card-border); border-radius:16px; padding:16px; margin-bottom:10px; display:flex; align-items:flex-start; gap:12px; transition:all 0.3s ease; }
.notif-icon { width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px; flex-shrink:0; }
.notif-icon.trip { background:rgba(0,230,118,0.2); }
.notif-icon.classify { background:rgba(255,183,77,0.2); }
.notif-icon.report { background:rgba(79,142,247,0.2); }
.notif-icon.alert { background:rgba(255,82,82,0.2); }
.notif-body { flex:1; }
.notif-body h4 { font-size:14px; font-weight:600; }
.notif-body p { font-size:13px; color:var(--text2); margin-top:4px; line-height:1.4; }
.notif-body .time { font-size:11px; color:var(--text3); margin-top:6px; }
.notif-action { padding:6px 14px; border-radius:8px; border:none; background:linear-gradient(135deg,var(--blue),var(--teal)); color:white; font-size:12px; font-weight:600; cursor:pointer; font-family:inherit; margin-top:10px; transition:all 0.3s ease; }
.notif-badge { position:absolute; top:-4px; right:-4px; min-width:18px; height:18px; border-radius:9px; background:linear-gradient(135deg,var(--red),#ff7070); color:white; font-size:10px; font-weight:700; display:flex; align-items:center; justify-content:center; padding:0 4px; box-shadow:0 2px 8px rgba(255,82,82,0.3); }

/* SETTINGS */
.settings-header { background:#0d0d20; border-bottom:1px solid rgba(255,255,255,0.06); padding:16px 20px; display:flex; align-items:center; gap:12px; }
.settings-header h2 { font-size:28px; font-weight:700; }
.settings-back { background:none; border:none; font-size:24px; color:var(--blue); cursor:pointer; padding:4px; }
.settings-content { padding:16px; }
.settings-section-title { font-size:11px; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--text2); padding:12px 4px 8px; }
.settings-card { background:rgba(255,255,255,0.06); border:1px solid var(--card-border); border-radius:14px; margin-bottom:12px; overflow:hidden; }
.setting-row { display:flex; align-items:center; justify-content:space-between; padding:16px; border-bottom:1px solid var(--card-border); }
.setting-row:last-child { border-bottom:none; }
.setting-row .info h4 { font-size:15px; font-weight:500; }
.setting-row .info p { font-size:12px; color:var(--text2); margin-top:4px; }
.toggle { width:54px; height:32px; background:rgba(255,255,255,0.1); border-radius:18px; position:relative; cursor:pointer; border:1px solid var(--card-border); flex-shrink:0; transition:all 0.3s ease; }
.toggle.on { background:linear-gradient(135deg,var(--green),#00e67e); border-color:transparent; box-shadow:0 4px 12px rgba(0,230,118,0.3); }
.toggle::after { content:''; width:28px; height:28px; background:white; border-radius:50%; position:absolute; top:2px; left:2px; transition:transform 0.3s ease; box-shadow:0 2px 6px rgba(0,0,0,0.3); }
.toggle.on::after { transform:translateX(22px); }
.setting-input { padding:8px 12px; border-radius:8px; border:1px solid var(--card-border); background:rgba(255,255,255,0.05); color:var(--text); font-family:inherit; font-size:14px; text-align:center; transition:all 0.3s ease; }
.setting-input:focus { outline:none; background:rgba(255,255,255,0.08); border-color:var(--blue); }
.btn-danger { padding:8px 16px; border-radius:8px; border:none; background:rgba(255,82,82,0.15); color:var(--red); font-size:14px; font-weight:500; cursor:pointer; font-family:inherit; transition:all 0.3s ease; }
.btn-danger:hover { background:rgba(255,82,82,0.25); }
.btn-signout { padding:8px 16px; border-radius:8px; border:1px solid rgba(255,82,82,0.3); background:rgba(255,82,82,0.1); color:var(--red); font-size:14px; font-weight:600; cursor:pointer; font-family:inherit; display:flex; align-items:center; gap:6px; transition:all 0.3s ease; }
.btn-signout:hover { background:rgba(255,82,82,0.2); }

/* User profile card in settings */
.user-profile-card {
  background: linear-gradient(135deg, rgba(79,142,247,0.15), rgba(108,99,255,0.15));
  border: 1px solid rgba(79,142,247,0.3);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 16px;
}
.user-profile-avatar {
  width: 56px; height: 56px; border-radius: 50%;
  background: linear-gradient(135deg,var(--blue),var(--purple));
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; font-weight: 700; color: white;
  overflow: hidden; flex-shrink: 0;
  border: 2px solid rgba(79,142,247,0.4);
}
.user-profile-avatar img { width:100%; height:100%; object-fit:cover; }
.user-profile-info h4 { font-size:16px; font-weight:700; }
.user-profile-info p { font-size:13px; color:var(--text2); margin-top:3px; }
.user-profile-info .sync-badge { display:inline-flex; align-items:center; gap:5px; margin-top:6px; font-size:11px; color:var(--green); font-weight:500; }
.user-profile-info .sync-badge::before { content:''; width:6px; height:6px; border-radius:50%; background:var(--green); }

/* MODALS */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:300; display:none; align-items:flex-end; justify-content:center; backdrop-filter:blur(8px); }
.modal-overlay.show { display:flex; }
.modal { background:linear-gradient(135deg,rgba(255,255,255,0.1),rgba(255,255,255,0.08)); backdrop-filter:blur(20px); border:1px solid var(--card-border); border-radius:24px 24px 0 0; width:100%; max-width:500px; padding:20px; padding-bottom:calc(24px+var(--safe-bottom)); transform:translateY(100%); transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1); max-height:90vh; overflow-y:auto; }
.modal-overlay.show .modal { transform:translateY(0); }
.modal-handle { width:40px; height:5px; background:rgba(255,255,255,0.2); border-radius:3px; margin:0 auto 20px; }
.modal h3 { font-size:22px; font-weight:700; margin-bottom:20px; }
.modal-field { margin-bottom:16px; }
.modal-field label { display:block; font-size:12px; color:var(--text2); margin-bottom:8px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
.modal-field input,.modal-field textarea,.modal-field select { width:100%; padding:12px; border:1px solid var(--card-border); border-radius:12px; font-size:16px; font-family:inherit; background:rgba(255,255,255,0.05); color:var(--text); -webkit-appearance:none; transition:all 0.3s ease; }
.modal-field input:focus,.modal-field textarea:focus,.modal-field select:focus { outline:none; background:rgba(255,255,255,0.08); border-color:var(--blue); }
.modal-field textarea { resize:vertical; min-height:80px; }
.modal-btns { display:flex; gap:10px; margin-top:20px; }
.modal-btns button { flex:1; padding:14px; border-radius:12px; border:none; font-size:16px; font-weight:600; cursor:pointer; font-family:inherit; transition:all 0.3s ease; }
.mbtn-cancel { background:rgba(255,255,255,0.06); color:var(--text); border:1px solid var(--card-border); }
.mbtn-cancel:active { transform:scale(0.96); }
.mbtn-delete { background:rgba(255,82,82,0.15); color:var(--red); border:1px solid rgba(255,82,82,0.3); }
.mbtn-delete:active { transform:scale(0.96); }
.mbtn-save { background:linear-gradient(135deg,var(--blue),var(--teal)); color:white; box-shadow:0 4px 15px rgba(79,142,247,0.3); }
.mbtn-save:active { transform:scale(0.96); }
.trip-summary-card { background:rgba(255,255,255,0.04); border-radius:14px; padding:20px; margin-bottom:20px; }
.trip-summary-card .row { display:flex; justify-content:space-between; padding:8px 0; }
.trip-summary-card .row .label { font-size:13px; color:var(--text2); }
.trip-summary-card .row .value { font-size:14px; font-weight:600; }
.trip-summary-card .miles-big { font-size:48px; font-weight:700; text-align:center; color:var(--blue); margin:16px 0; }
.trip-summary-card .miles-lbl { text-align:center; font-size:13px; color:var(--text2); }
.addr-classify { background:rgba(255,255,255,0.04); border-radius:14px; padding:16px; margin-bottom:16px; }
.addr-classify h4 { font-size:15px; font-weight:600; margin-bottom:12px; }
.addr-classify .addr-row { display:flex; align-items:center; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.08); }
.addr-classify .addr-row:last-child { border-bottom:none; }
.addr-classify .addr-name { font-size:14px; font-weight:500; }
.addr-classify .addr-btns { display:flex; gap:8px; }
.addr-classify .addr-btn { padding:6px 12px; border-radius:8px; border:1px solid var(--card-border); background:rgba(255,255,255,0.05); font-size:12px; font-weight:600; cursor:pointer; font-family:inherit; color:var(--text2); transition:all 0.3s ease; }
.addr-classify .addr-btn.sel { border-color:var(--blue); color:var(--blue); background:rgba(79,142,247,0.2); }
.addr-classify .addr-btn.sel-p { border-color:var(--pink); color:var(--pink); background:rgba(255,107,157,0.2); }

/* TOAST */
.toast { position:fixed; top:calc(var(--safe-top)+70px); left:50%; transform:translateX(-50%) translateY(-100px); background:rgba(30,30,50,0.95); backdrop-filter:blur(10px); color:white; padding:14px 28px; border-radius:28px; font-size:14px; font-weight:500; z-index:400; transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1); box-shadow:0 8px 32px rgba(0,0,0,0.4); border:1px solid rgba(255,255,255,0.1); }
.toast.show { transform:translateX(-50%) translateY(0); }

/* NOTIF BANNER */
.notif-banner { position:fixed; top:calc(var(--safe-top)+60px); left:12px; right:12px; background:linear-gradient(135deg,rgba(255,255,255,0.1),rgba(255,255,255,0.08)); backdrop-filter:blur(20px); border:1px solid var(--card-border); border-radius:16px; padding:16px; box-shadow:0 8px 32px rgba(0,0,0,0.4); z-index:500; display:flex; align-items:center; gap:14px; transform:translateY(-200px); transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1); }
.notif-banner.show { transform:translateY(0); }
.notif-banner .n-icon { font-size:32px; flex-shrink:0; }
.notif-banner .n-body { flex:1; }
.notif-banner .n-body h5 { font-size:14px; font-weight:600; }
.notif-banner .n-body p { font-size:12px; color:var(--text2); margin-top:2px; }
.notif-banner .n-close { background:none; border:none; color:var(--text3); font-size:20px; cursor:pointer; padding:4px; }

::-webkit-scrollbar { width:0; }
</style>
</head>
<body>

<!-- ===== CONFIG NEEDED SCREEN ===== -->
<div id="config-screen" style="display:none;position:fixed;inset:0;background:linear-gradient(135deg,#0a0a1a 0%,#12122a 50%,#1a0a2e 100%);z-index:2000;flex-direction:column;align-items:center;justify-content:center;padding:32px 24px;text-align:center;overflow-y:auto;">
  <div style="font-size:52px;margin-bottom:20px">ðŸ”§</div>
  <div style="font-size:26px;font-weight:800;margin-bottom:10px;color:white">Firebase Setup Required</div>
  <div style="font-size:15px;color:rgba(255,255,255,0.6);margin-bottom:32px;line-height:1.6;max-width:340px">
    To enable Google Sign-In and cloud sync, you need to add your Firebase config to <code style="background:rgba(255,255,255,0.1);padding:2px 8px;border-radius:6px;font-size:13px">index.html</code>
  </div>
  <div style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:16px;padding:20px 24px;text-align:left;width:100%;max-width:400px;margin-bottom:24px">
    <div style="font-size:12px;font-weight:700;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:1px;margin-bottom:14px">Quick Steps</div>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,#4F8EF7,#6C63FF);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0">1</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.8)">Go to <strong style="color:#4F8EF7">console.firebase.google.com</strong> and create a project</div>
      </div>
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,#4F8EF7,#6C63FF);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0">2</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.8)">Enable <strong>Google Sign-In</strong> and create a <strong>Firestore Database</strong></div>
      </div>
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,#4F8EF7,#6C63FF);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0">3</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.8)">Copy your <strong>firebaseConfig</strong> and paste it into <code style="background:rgba(255,255,255,0.1);padding:1px 6px;border-radius:4px">index.html</code> where it says <code style="background:rgba(255,255,255,0.1);padding:1px 6px;border-radius:4px">YOUR_API_KEY</code></div>
      </div>
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,#4F8EF7,#6C63FF);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0">4</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.8)">Add your domain to Firebase â†’ Authentication â†’ <strong>Authorized domains</strong> (e.g. <span id="cfg-hostname" style="color:#4F8EF7;font-weight:600">your domain</span>)</div>
      </div>
    </div>
  </div>
  <a href="https://console.firebase.google.com" target="_blank" style="display:flex;align-items:center;gap:10px;width:100%;max-width:400px;padding:16px 24px;background:linear-gradient(135deg,#4F8EF7,#6C63FF);color:white;border-radius:14px;font-size:16px;font-weight:700;text-decoration:none;justify-content:center;box-shadow:0 8px 32px rgba(79,142,247,0.4)">
    ðŸ”¥ Open Firebase Console
  </a>
  <div style="margin-top:16px;font-size:12px;color:rgba(255,255,255,0.3)">See SETUP_GUIDE.md for full instructions</div>
</div>

<!-- ===== LOGIN SCREEN ===== -->
<div id="login-screen">
  <div class="login-logo">
    <svg viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>
  </div>
  <div class="login-title">MileTracker</div>
  <div class="login-sub">Smart mileage tracking for<br>business & tax deductions</div>

  <div class="login-features">
    <div class="login-feature">
      <div class="feat-icon">ðŸ›°ï¸</div>
      <div class="feat-text">
        <h4>Auto-detect trips</h4>
        <p>GPS starts recording when you drive</p>
      </div>
    </div>
    <div class="login-feature">
      <div class="feat-icon">â˜ï¸</div>
      <div class="feat-text">
        <h4>Cloud sync</h4>
        <p>Your trips sync across all devices</p>
      </div>
    </div>
    <div class="login-feature">
      <div class="feat-icon">ðŸ’°</div>
      <div class="feat-text">
        <h4>Tax deductions</h4>
        <p>IRS-ready reports & CSV export</p>
      </div>
    </div>
  </div>

  <button id="signin-btn" onclick="window._signIn()">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
      <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
      <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
      <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
    </svg>
    Sign in with Google
  </button>
  <div class="login-privacy">Your data is private and secure. Trips are stored in your personal cloud account and never shared.</div>
</div>

<!-- ===== APP SHELL ===== -->
<div id="app-shell">

<div class="toast" id="toast"></div>
<div class="notif-banner" id="notif-banner">
  <div class="n-icon" id="nb-icon"></div>
  <div class="n-body"><h5 id="nb-title"></h5><p id="nb-msg"></p></div>
  <button class="n-close" onclick="hideNotifBanner()">&times;</button>
</div>

<!-- HEADER -->
<div class="app-header">
  <div class="header-left">
    <div class="header-logo"><svg viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg></div>
    <div class="header-title">MileTracker</div>
  </div>
  <div class="header-right">
    <div class="sync-dot" id="sync-dot" title="Synced to cloud"></div>
    <div class="user-avatar" id="user-avatar" onclick="openSettings()" title="Account">?</div>
    <button class="header-btn" onclick="openSettings()" title="Settings">&#9881;</button>
  </div>
</div>

<!-- STATUS BAR -->
<div class="status-bar" id="status-bar">
  <span class="status-dot" id="gps-dot"></span>
  <span class="status-text" id="gps-text">Starting GPS...</span>
</div>

<!-- MAP OVERLAY -->
<div class="map-overlay" id="map-overlay">
  <div class="map-header">
    <div style="display:flex;align-items:center;gap:10px">
      <h3>My Trips</h3>
      <span class="map-trip-count" id="map-trip-count">0 trips</span>
    </div>
    <button class="map-close" onclick="closeMap()">&times;</button>
  </div>
  <div class="map-filter-bar" id="map-filter-bar">
    <button class="map-filter-pill active" onclick="setMapFilter('today',this)">Today</button>
    <button class="map-filter-pill" onclick="setMapFilter('week',this)">This Week</button>
    <button class="map-filter-pill" onclick="setMapFilter('month',this)">This Month</button>
    <button class="map-filter-pill" onclick="setMapFilter('all',this)">All</button>
  </div>
  <div class="map-legend">
    <span class="map-legend-item"><span class="map-legend-dot" style="background:#00D4AA"></span>Business</span>
    <span class="map-legend-item"><span class="map-legend-dot" style="background:#FF6B9D"></span>Personal</span>
    <span class="map-legend-item"><span class="map-legend-dot" style="background:#FFB74D"></span>Unclassified</span>
  </div>
  <div id="map-container"></div>
  <div class="map-trips-panel" id="map-trips-panel">
    <div class="map-trips-handle" onclick="toggleMapTripsPanel()"><div class="map-trips-handle-bar"></div></div>
    <div class="map-trips-summary" id="map-trips-summary"></div>
    <div class="map-trips-list" id="map-trips-list"></div>
  </div>
</div>

<!-- DRIVE PAGE -->
<div class="page active" id="page-drive">
  <div class="drive-hero" id="drive-hero">
    <div class="drive-circle monitoring" id="drive-circle">
      <div class="drive-circle-inner" id="drive-icon">&#x1F7E2;</div>
    </div>
    <div class="drive-label" id="drive-label">Always On</div>
    <div class="drive-sublabel" id="drive-sublabel">GPS monitoring active. Trips auto-detect when you drive.</div>
    <div class="drive-speed" id="idle-speed-wrap">
      <span class="num" id="idle-speed">0</span><span class="unit">mph</span>
    </div>
    <div class="drive-accuracy" id="idle-accuracy">GPS accuracy: --</div>
  </div>
  <div class="live-panel" id="live-panel">
    <div class="live-stats">
      <div class="live-stat"><div class="val" id="live-miles">0.0</div><div class="lbl">Miles</div></div>
      <div class="live-stat"><div class="val" id="live-duration">0m</div><div class="lbl">Duration</div></div>
    </div>
    <div class="live-speed-inline" id="live-speed">0 mph</div>
  </div>
  <div class="gps-activate-wrap" id="gps-activate">
    <button class="gps-activate-btn" onclick="activateGPS()">Tap to Activate GPS</button>
    <div style="font-size:11px;color:var(--text3);margin-top:6px;text-align:center">Some browsers need a tap to start location</div>
  </div>
  <div class="map-btn-wrap">
    <button class="map-btn" onclick="switchPage('trips',document.getElementById('nav-trips'))">&#x1F5FA; View My Trips</button>
    <button class="map-btn" onclick="openMap()" style="margin-top:8px">&#127760; Open Full Map</button>
  </div>
  <div class="quick-stats">
    <div class="quick-stat"><div class="icon">&#128188;</div><div class="val biz" id="s-biz">0 mi</div><div class="lbl">Business Miles</div></div>
    <div class="quick-stat"><div class="icon">&#128100;</div><div class="val pers" id="s-pers">0 mi</div><div class="lbl">Personal Miles</div></div>
    <div class="quick-stat"><div class="icon">$</div><div class="val ded" id="s-ded">$0.00</div><div class="lbl">Tax Deduction</div></div>
    <div class="quick-stat"><div class="icon">&#128663;</div><div class="val trips" id="s-trips">0</div><div class="lbl">Total Trips</div></div>
  </div>
  <div class="uncl-banner" id="uncl-banner"><div class="icon">&#9888;&#65039;</div><div class="info"><h4>Unclassified Trips</h4><p id="uncl-text">Tap to classify</p></div></div>
  <div class="manual-btn-wrap"><button class="manual-btn" onclick="openManualTrip()">+ Add Trip Manually</button></div>
  <div class="debug-log" id="gps-debug"></div>
</div>

<!-- TRIPS PAGE -->
<div class="page" id="page-trips">
  <div class="trips-header">
    <h2>Your Trips</h2>
    <div class="filter-row">
      <button class="filter-tab active" onclick="filterTrips('all',this)">All</button>
      <button class="filter-tab" onclick="filterTrips('business',this)">Business</button>
      <button class="filter-tab" onclick="filterTrips('personal',this)">Personal</button>
      <button class="filter-tab" onclick="filterTrips('unclassified',this)">Unclassified</button>
    </div>
  </div>
  <div class="trips-list" id="trips-list"></div>
  <div class="empty-state" id="trips-empty"><div class="icon">&#128663;</div><h3>No trips yet</h3><p>Start driving to see trips here</p></div>
</div>

<!-- DASHBOARD PAGE -->
<div class="page" id="page-dashboard">
  <div class="dash-header">
    <h2>Dashboard</h2>
    <div class="period-pills">
      <button class="period-pill" onclick="setDashPeriod('day',this)">Day</button>
      <button class="period-pill" onclick="setDashPeriod('week',this)">Week</button>
      <button class="period-pill active" onclick="setDashPeriod('month',this)">Month</button>
      <button class="period-pill" onclick="setDashPeriod('year',this)">Year</button>
    </div>
  </div>
  <div class="dash-content" id="dash-content"></div>
</div>

<!-- NOTIFICATIONS -->
<div class="page" id="page-notifs">
  <div class="notif-header"><h2>Notifications</h2></div>
  <div class="notif-list" id="notif-list"></div>
</div>

<!-- SETTINGS -->
<div class="page" id="page-settings">
  <div class="settings-header">
    <button class="settings-back" onclick="goBack()">&larr;</button>
    <h2>Settings</h2>
  </div>
  <div class="settings-content">
    <div id="user-profile-section"></div>
    <div class="settings-section-title">Tracking</div>
    <div class="settings-card">
      <div class="setting-row"><div class="info"><h4>Auto-detect trips</h4><p>Start recording when driving</p></div><button class="toggle on" id="tog-auto" onclick="toggleSetting('autoDetect')"></button></div>
      <div class="setting-row"><div class="info"><h4>Default category</h4><p>New trips default to this</p></div><select class="setting-input" id="set-defcat" onchange="updateSetting('defaultCat')" style="width:120px"><option value="unclassified">Unclassified</option><option value="business">Business</option><option value="personal">Personal</option></select></div>
      <div class="setting-row"><div class="info"><h4>Speed threshold</h4><p>Min mph to count as driving</p></div><input type="number" class="setting-input" id="set-speed" value="5" min="1" max="25" style="width:60px" onchange="updateSetting('speed')"></div>
    </div>
    <div class="settings-section-title">Notifications</div>
    <div class="settings-card">
      <div class="setting-row"><div class="info"><h4>Trip alerts</h4><p>Notify when trips saved</p></div><button class="toggle on" id="tog-tripalert" onclick="toggleSetting('tripAlerts')"></button></div>
      <div class="setting-row"><div class="info"><h4>Classification reminders</h4><p>Remind to classify trips</p></div><button class="toggle on" id="tog-classify" onclick="toggleSetting('classifyReminders')"></button></div>
      <div class="setting-row"><div class="info"><h4>Weekly summary</h4><p>Show weekly mileage summary</p></div><button class="toggle on" id="tog-weekly" onclick="toggleSetting('weeklySummary')"></button></div>
    </div>
    <div class="settings-section-title">IRS Rate</div>
    <div class="settings-card">
      <div class="setting-row"><div class="info"><h4>Business rate per mile</h4><p>2026 IRS standard mileage rate</p></div><div style="display:flex;align-items:center;gap:4px"><span>$</span><input type="number" class="setting-input" id="set-irs" value="0.70" step="0.01" min="0" style="width:70px" onchange="updateSetting('irs')"></div></div>
    </div>
    <div class="settings-section-title">Saved Addresses</div>
    <div class="settings-card" id="saved-addresses-list"></div>
    <div class="settings-section-title">Data</div>
    <div class="settings-card">
      <div class="setting-row"><div class="info"><h4>Total recorded</h4><p id="set-count">0 trips</p></div></div>
      <div class="setting-row"><div class="info"><h4>Clear all data</h4><p>Remove all trip records</p></div><button class="btn-danger" onclick="clearAllData()">Clear</button></div>
    </div>
    <div style="text-align:center;color:var(--text3);font-size:12px;padding:20px">MileTracker v4.1 Â· Cloud Sync Edition</div>
  </div>
</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <button class="nav-item active" onclick="switchPage('drive',this)" id="nav-drive">
    <svg viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg><span>Drive</span>
  </button>
  <button class="nav-item" onclick="switchPage('trips',this)" id="nav-trips">
    <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg><span>Trips</span>
  </button>
  <button class="nav-item" onclick="switchPage('dashboard',this)" id="nav-dashboard">
    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg><span>Dashboard</span>
  </button>
  <button class="nav-item" onclick="switchPage('notifs',this)" id="nav-notifs" style="position:relative">
    <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg><span>Alerts</span>
    <span class="notif-badge" id="notif-badge" style="display:none">0</span>
  </button>
</div>

<!-- MANUAL TRIP MODAL -->
<div class="modal-overlay" id="manual-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3>Add Trip</h3>
    <div class="modal-field"><label>From Address</label><input type="text" id="man-from" placeholder="e.g. 123 Main St or Home"></div>
    <div class="modal-field"><label>To Address</label><input type="text" id="man-to" placeholder="e.g. 456 Oak Ave or Office"></div>
    <div id="man-calc-dist" style="display:none" class="calc-distance"><span>&#x1F4CD;</span><span id="man-calc-text">Calculating distance...</span></div>
    <div class="modal-field"><label>Miles (auto-calculated or manual)</label><input type="number" id="man-miles" step="0.1" min="0" placeholder="Miles"></div>
    <div class="modal-field"><label>Category</label><select id="man-cat"><option value="business">Business</option><option value="personal">Personal</option><option value="unclassified">Unclassified</option></select></div>
    <div class="modal-field"><label>Date</label><input type="date" id="man-date"></div>
    <div class="modal-field"><label>Notes (optional)</label><textarea id="man-notes" placeholder="Meeting with client..."></textarea></div>
    <div class="modal-btns">
      <button class="mbtn-cancel" onclick="closeManualModal()">Cancel</button>
      <button class="mbtn-save" onclick="saveManualTrip()">Save Trip</button>
    </div>
  </div>
</div>

<!-- EDIT TRIP MODAL -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3>Edit Trip</h3>
    <div class="modal-field"><label>Trip Name</label><input type="text" id="ed-name" placeholder="Home to Office"></div>
    <div class="modal-field"><label>Category</label><select id="ed-cat"><option value="business">Business</option><option value="personal">Personal</option><option value="unclassified">Unclassified</option></select></div>
    <div class="modal-field"><label>Miles</label><input type="number" id="ed-miles" step="0.1" min="0"></div>
    <div class="modal-field"><label>Notes</label><textarea id="ed-notes" placeholder="Optional notes..."></textarea></div>
    <div class="modal-btns">
      <button class="mbtn-cancel" onclick="closeModal()">Cancel</button>
      <button class="mbtn-delete" onclick="deleteTrip()">Delete</button>
      <button class="mbtn-save" onclick="saveEditTrip()">Save</button>
    </div>
  </div>
</div>

<!-- TRIP SUMMARY MODAL -->
<div class="modal-overlay" id="summary-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3>Trip Complete!</h3>
    <div class="trip-summary-card">
      <div class="miles-big" id="sum-miles">0.0</div>
      <div class="miles-lbl">miles driven</div>
      <div class="row"><span class="label">From</span><span class="value" id="sum-from">--</span></div>
      <div class="row"><span class="label">To</span><span class="value" id="sum-to">--</span></div>
      <div class="row"><span class="label">Duration</span><span class="value" id="sum-dur">--</span></div>
      <div class="row"><span class="label">Avg Speed</span><span class="value" id="sum-speed">--</span></div>
    </div>
    <div class="addr-classify" id="sum-addr-section">
      <h4>Classify these addresses</h4>
      <div id="sum-addr-rows"></div>
    </div>
    <div class="modal-field"><label>Trip Category</label>
      <select id="sum-cat">
        <option value="business">Business</option>
        <option value="personal">Personal</option>
        <option value="unclassified">Decide Later</option>
      </select>
    </div>
    <div class="modal-btns">
      <button class="mbtn-save" onclick="saveTripSummary()" style="flex:1">Save Trip</button>
    </div>
  </div>
</div>

</div><!-- end app-shell -->

<script>
// ===================== STATE =====================
const IRS_RATE_2026 = 0.70;
let app = {
  trips: [], tracking: false, notifications: [],
  savedAddresses: {},
  settings: {
    autoDetect:true, defaultCat:'unclassified', speedThreshold:5,
    irsRate:IRS_RATE_2026, tripAlerts:true, classifyReminders:true, weeklySummary:true
  },
  dashPeriod:'month', tripFilter:'all', editId:null, lastPage:'drive'
};
let watchId=null, positions=[], trackStart=null, trackTimer=null;
let leafletMap=null, userMarker=null, trackPolyline=null;
let pendingSummaryTrip = null;

// ===================== AUTH UI =====================
function showLogin() {
  document.getElementById('login-screen').classList.add('show');
  document.getElementById('app-shell').classList.remove('show');
  // Hide config screen if shown
  const cs = document.getElementById('config-screen');
  if (cs) cs.style.display = 'none';
}
function showApp(user) {
  document.getElementById('login-screen').classList.remove('show');
  document.getElementById('app-shell').classList.add('show');
  const cs = document.getElementById('config-screen');
  if (cs) cs.style.display = 'none';
  // Set user avatar
  const av = document.getElementById('user-avatar');
  if (user.photoURL) {
    av.innerHTML = `<img src="${user.photoURL}" alt="${user.displayName}">`;
  } else {
    av.textContent = (user.displayName||user.email||'?')[0].toUpperCase();
  }
  load();
  updateHomeStats();
  updateNotifBadge();
  startAlwaysOnMonitor();
  if (!app.notifications.length) {
    addNotification('alert','Welcome to MileTracker!','Trips auto-detect when you drive. Your data syncs to the cloud.',null);
  }
}

// ===================== STORAGE (localStorage fallback + Firestore) =====================
function save() {
  try { localStorage.setItem('mt4', JSON.stringify({
    settings:app.settings, notifications:app.notifications,
    savedAddresses:app.savedAddresses
  })); } catch(e) {}
  // Sync settings/addresses to Firestore
  if (window._saveSettings) window._saveSettings();
}
function load() {
  try {
    const d = JSON.parse(localStorage.getItem('mt4'));
    if (d) {
      app.settings = {...app.settings,...(d.settings||{})};
      app.notifications = d.notifications||[];
      app.savedAddresses = d.savedAddresses||{};
    }
  } catch(e) {}
}

// ===================== SYNC DOT =====================
function setSyncing(syncing) {
  const dot = document.getElementById('sync-dot');
  if (!dot) return;
  dot.className = 'sync-dot' + (syncing ? ' syncing' : '');
  dot.title = syncing ? 'Syncing...' : 'Synced to cloud';
}

// ===================== NAV =====================
function switchPage(p, btn) {
  if (p!=='settings') app.lastPage=p;
  document.querySelectorAll('.page').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
  document.getElementById('page-'+p).classList.add('active');
  if (btn) btn.classList.add('active');
  else { const n=document.getElementById('nav-'+p); if(n) n.classList.add('active'); }
  if (p==='trips') renderTrips();
  if (p==='dashboard') renderDashboard();
  if (p==='settings') renderSettings();
  if (p==='notifs') { renderNotifs(); updateNotifBadge(); }
}
function openSettings() { switchPage('settings'); }
function goBack() { switchPage(app.lastPage||'drive'); }
function showToast(msg) {
  const t=document.getElementById('toast'); t.textContent=msg;
  t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500);
}

// ===================== MAP =====================
let mapFilter = 'today';
let mapTripMarkers = [];
let mapTripLines = [];
let lastMonitorPos = null;

function openMap() {
  document.getElementById('map-overlay').classList.add('show');
  setTimeout(()=>{
    if (!leafletMap) {
      const defaultLat = lastMonitorPos ? lastMonitorPos.lat : 49.8951;
      const defaultLng = lastMonitorPos ? lastMonitorPos.lng : -97.1384;
      leafletMap = L.map('map-container', { zoomControl: false }).setView([defaultLat, defaultLng], 13);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{
        attribution:'&copy; OpenStreetMap &copy; CartoDB', maxZoom:19
      }).addTo(leafletMap);
      L.control.zoom({ position: 'topright' }).addTo(leafletMap);
    }
    leafletMap.invalidateSize();
    if (lastMonitorPos) {
      leafletMap.setView([lastMonitorPos.lat, lastMonitorPos.lng], 13);
      if (userMarker) userMarker.setLatLng([lastMonitorPos.lat, lastMonitorPos.lng]);
      else userMarker = L.circleMarker([lastMonitorPos.lat, lastMonitorPos.lng],{radius:8,fillColor:'#4F8EF7',fillOpacity:1,color:'white',weight:3}).addTo(leafletMap);
    }
    renderMapTrips();
  },150);
}
function closeMap() {
  document.getElementById('map-overlay').classList.remove('show');
  clearMapTripMarkers();
}
function setMapFilter(filter, btn) {
  mapFilter = filter;
  document.querySelectorAll('.map-filter-pill').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  renderMapTrips();
}
function getMapFilteredTrips() {
  const now = new Date();
  if (mapFilter==='today') return app.trips.filter(t=>new Date(t.date).toDateString()===now.toDateString());
  if (mapFilter==='week') { const w=new Date(now); w.setDate(w.getDate()-7); return app.trips.filter(t=>new Date(t.date)>=w); }
  if (mapFilter==='month') return app.trips.filter(t=>{const d=new Date(t.date);return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();});
  return [...app.trips];
}
function clearMapTripMarkers() {
  mapTripMarkers.forEach(m=>{if(leafletMap)leafletMap.removeLayer(m);});
  mapTripLines.forEach(l=>{if(leafletMap)leafletMap.removeLayer(l);});
  mapTripMarkers=[];mapTripLines=[];
}
function getCatColor(cat) { return cat==='business'?'#00D4AA':cat==='personal'?'#FF6B9D':'#FFB74D'; }
function renderMapTrips() {
  clearMapTripMarkers();
  const trips = getMapFilteredTrips();
  const bizMiles=trips.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0);
  const persMiles=trips.filter(t=>t.category==='personal').reduce((s,t)=>s+t.miles,0);
  const totalMiles=trips.reduce((s,t)=>s+t.miles,0);
  document.getElementById('map-trip-count').textContent=trips.length+' trip'+(trips.length!==1?'s':'');
  document.getElementById('map-trips-summary').innerHTML=`
    <div class="map-sum-card"><div class="val" style="color:#00D4AA">${bizMiles.toFixed(1)}</div><div class="lbl">Business mi</div></div>
    <div class="map-sum-card"><div class="val" style="color:#FF6B9D">${persMiles.toFixed(1)}</div><div class="lbl">Personal mi</div></div>
    <div class="map-sum-card"><div class="val">${totalMiles.toFixed(1)}</div><div class="lbl">Total mi</div></div>
    <div class="map-sum-card"><div class="val" style="color:var(--blue)">${trips.length}</div><div class="lbl">Trips</div></div>`;
  const listEl=document.getElementById('map-trips-list');
  if(!trips.length){listEl.innerHTML='<div style="text-align:center;padding:20px;color:#999;font-size:14px">No trips for this period</div>';return;}
  listEl.innerHTML=trips.map((t,i)=>{
    const time=new Date(t.date).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
    const dur=t.duration?Math.round(t.duration/60000):0;
    return `<div class="map-trip-item" id="map-trip-${i}" onclick="focusMapTrip(${i})">
      <div class="map-trip-dot ${t.category}"></div>
      <div class="map-trip-info"><div class="route">${esc(t.startName||'Start')} &rarr; ${esc(t.endName||'Dest')}</div><div class="meta">${time} &middot; ${t.category} &middot; ${dur}min</div></div>
      <div class="map-trip-miles"><div class="mi">${t.miles.toFixed(1)}</div><div class="unit">mi</div></div>
    </div>`;
  }).join('');
  const bounds=[];
  trips.forEach((t,i)=>{
    const color=getCatColor(t.category);
    if(t.startCoord){const m=L.circleMarker([t.startCoord.lat,t.startCoord.lng],{radius:6,fillColor:color,fillOpacity:0.8,color:'white',weight:2}).addTo(leafletMap);m.bindPopup(`<b>Start:</b> ${esc(t.startName||'Unknown')}<br><b>${t.category}</b> - ${t.miles.toFixed(1)} mi`);mapTripMarkers.push(m);bounds.push([t.startCoord.lat,t.startCoord.lng]);}
    if(t.endCoord){const m=L.circleMarker([t.endCoord.lat,t.endCoord.lng],{radius:9,fillColor:color,fillOpacity:1,color:'white',weight:3}).addTo(leafletMap);m.bindPopup(`<b>Dest:</b> ${esc(t.endName||'Unknown')}<br><b>${t.category}</b> - ${t.miles.toFixed(1)} mi`);mapTripMarkers.push(m);bounds.push([t.endCoord.lat,t.endCoord.lng]);}
    if(t.startCoord&&t.endCoord){const l=L.polyline([[t.startCoord.lat,t.startCoord.lng],[t.endCoord.lat,t.endCoord.lng]],{color,weight:4,opacity:0.8,dashArray:'8,5'}).addTo(leafletMap);mapTripLines.push(l);}
  });
  if(bounds.length>1)leafletMap.fitBounds(bounds,{padding:[40,40],maxZoom:13,animate:true});
  else if(bounds.length===1)leafletMap.setView(bounds[0],13);
  else if(lastMonitorPos)leafletMap.setView([lastMonitorPos.lat,lastMonitorPos.lng],13);
}
function focusMapTrip(index) {
  const trips=getMapFilteredTrips();const t=trips[index];if(!t)return;
  document.querySelectorAll('.map-trip-item').forEach(el=>el.classList.remove('selected'));
  const card=document.getElementById('map-trip-'+index);if(card)card.classList.add('selected');
  if(t.endCoord)leafletMap.flyTo([t.endCoord.lat,t.endCoord.lng],15,{duration:0.8});
  else if(t.startCoord)leafletMap.flyTo([t.startCoord.lat,t.startCoord.lng],15,{duration:0.8});
}
function toggleMapTripsPanel(){document.getElementById('map-trips-panel').classList.toggle('collapsed');}
function updateMapPosition(lat,lng){
  if(!leafletMap)return;
  if(userMarker)userMarker.setLatLng([lat,lng]);
  else userMarker=L.circleMarker([lat,lng],{radius:8,fillColor:'#4F8EF7',fillOpacity:1,color:'white',weight:3}).addTo(leafletMap);
  if(app.tracking&&trackPolyline)trackPolyline.addLatLng([lat,lng]);
}

// ===================== NOTIFICATIONS =====================
function addNotification(type,title,message,action){
  const n={id:Date.now().toString(),type,title,message,action:action||null,time:new Date().toISOString(),read:false};
  app.notifications.unshift(n);
  if(app.notifications.length>50)app.notifications=app.notifications.slice(0,50);
  save();updateNotifBadge();showNotifBanner(type,title,message);
}
function showNotifBanner(type,title,message){
  const icons={trip:'&#x1F697;',classify:'&#9888;&#65039;',report:'&#128202;',alert:'&#128276;'};
  document.getElementById('nb-icon').innerHTML=icons[type]||'&#128276;';
  document.getElementById('nb-title').textContent=title;
  document.getElementById('nb-msg').textContent=message;
  const b=document.getElementById('notif-banner');
  b.classList.add('show');setTimeout(()=>b.classList.remove('show'),5000);
}
function hideNotifBanner(){document.getElementById('notif-banner').classList.remove('show');}
function updateNotifBadge(){
  const u=app.notifications.filter(n=>!n.read).length;
  const b=document.getElementById('notif-badge');
  if(u>0){b.style.display='flex';b.textContent=u>9?'9+':u;}else{b.style.display='none';}
}
function renderNotifs(){
  app.notifications.forEach(n=>n.read=true);save();
  const list=document.getElementById('notif-list');
  if(!app.notifications.length){list.innerHTML='<div class="empty-state"><div class="icon">&#128276;</div><h3>No notifications</h3><p>Trip alerts will appear here</p></div>';return;}
  list.innerHTML=app.notifications.map(n=>{
    const icons={trip:'&#x1F697;',classify:'&#9888;&#65039;',report:'&#128202;',alert:'&#128276;'};
    const ago=timeAgo(new Date(n.time));
    let ab='';
    if(n.action==='classify')ab=`<button class="notif-action" onclick="switchPage('trips')">Classify Now</button>`;
    else if(n.action==='dashboard')ab=`<button class="notif-action" onclick="switchPage('dashboard')">View Dashboard</button>`;
    return `<div class="notif-card"><div class="notif-icon ${n.type}">${icons[n.type]||'&#128276;'}</div><div class="notif-body"><h4>${esc(n.title)}</h4><p>${esc(n.message)}</p><div class="time">${ago}</div>${ab}</div></div>`;
  }).join('');
}
function timeAgo(d){const s=Math.floor((Date.now()-d.getTime())/1000);if(s<60)return'Just now';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';}

// ===================== SAVED ADDRESSES =====================
function normalizeAddr(addr){return(addr||'').toLowerCase().trim().replace(/[^a-z0-9 ]/g,'');}
function getAddrCategory(addr){const key=normalizeAddr(addr);return app.savedAddresses[key]?app.savedAddresses[key].category:null;}
function saveAddrCategory(addr,category){
  const key=normalizeAddr(addr);if(!key)return;
  if(!app.savedAddresses[key])app.savedAddresses[key]={name:addr,category,count:1};
  else{app.savedAddresses[key].category=category;app.savedAddresses[key].count++;}
  save();
}
function autoClassifyTrip(trip){return getAddrCategory(trip.endName)||getAddrCategory(trip.startName)||null;}

// ===================== DISTANCE =====================
let calcTimeout=null;
function setupDistanceCalc(){
  const fromEl=document.getElementById('man-from');const toEl=document.getElementById('man-to');
  const handler=()=>{clearTimeout(calcTimeout);calcTimeout=setTimeout(()=>calcDistanceBetween(fromEl.value,toEl.value),800);};
  fromEl.addEventListener('input',handler);toEl.addEventListener('input',handler);
}
function calcDistanceBetween(from,to){
  if(!from||!to||from.length<3||to.length<3){document.getElementById('man-calc-dist').style.display='none';return;}
  document.getElementById('man-calc-dist').style.display='flex';
  document.getElementById('man-calc-text').textContent='Calculating distance...';
  Promise.all([geocodeAddress(from),geocodeAddress(to)]).then(([fc,tc])=>{
    if(fc&&tc){const dist=Math.round(haversine(fc.lat,fc.lon,tc.lat,tc.lon)*1.3*10)/10;document.getElementById('man-calc-text').textContent=`Estimated: ${dist} miles`;document.getElementById('man-miles').value=dist;}
    else document.getElementById('man-calc-text').textContent='Could not find address. Enter miles manually.';
  }).catch(()=>document.getElementById('man-calc-text').textContent='Distance lookup failed.');
}
function geocodeAddress(addr){
  return fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}&limit=1`)
    .then(r=>r.json()).then(d=>d.length?{lat:parseFloat(d[0].lat),lon:parseFloat(d[0].lon)}:null).catch(()=>null);
}

// ===================== GPS =====================
function onPos(p){
  const{latitude,longitude,speed,accuracy}=p.coords;const now=Date.now();
  if(accuracy<150)positions.push({lat:latitude,lng:longitude,time:now,speed,accuracy});
  const dist=calcDistance();
  document.getElementById('live-miles').textContent=dist<1?dist.toFixed(2):dist.toFixed(1);
}
function calcDistance(){if(positions.length<2)return 0;let t=0;for(let i=1;i<positions.length;i++)t+=haversine(positions[i-1].lat,positions[i-1].lng,positions[i].lat,positions[i].lng);return t;}
function haversine(lat1,lon1,lat2,lon2){const R=3959,dLat=rad(lat2-lat1),dLon=rad(lon2-lon1);const a=Math.sin(dLat/2)**2+Math.cos(rad(lat1))*Math.cos(rad(lat2))*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}
function rad(d){return d*Math.PI/180;}
function updateDuration(){if(!trackStart)return;const e=Date.now()-trackStart;const h=Math.floor(e/3600000),m=Math.floor((e%3600000)/60000);document.getElementById('live-duration').textContent=h>0?`${h}h${m}m`:`${m}m`;}
function reverseGeocode(lat,lng,cb){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
    .then(r=>r.json()).then(d=>{const a=d.address||{};const parts=[];if(a.house_number&&a.road)parts.push(a.house_number+' '+a.road);else if(a.road)parts.push(a.road);else if(a.building||a.amenity)parts.push(a.building||a.amenity);if(a.suburb||a.neighbourhood)parts.push(a.suburb||a.neighbourhood);if(a.city||a.town||a.village)parts.push(a.city||a.town||a.village);cb(parts.join(', ')||'Unknown Location');}).catch(()=>cb('Unknown Location'));
}
function updateHomeStats(){
  const now=new Date();
  const mTrips=app.trips.filter(t=>{const d=new Date(t.date);return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();});
  const biz=mTrips.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0);
  const pers=mTrips.filter(t=>t.category==='personal').reduce((s,t)=>s+t.miles,0);
  document.getElementById('s-biz').textContent=biz.toFixed(1)+' mi';
  document.getElementById('s-pers').textContent=pers.toFixed(1)+' mi';
  document.getElementById('s-ded').textContent='$'+(biz*app.settings.irsRate).toFixed(2);
  document.getElementById('s-trips').textContent=mTrips.length;
  const uncl=app.trips.filter(t=>t.category==='unclassified').length;
  const banner=document.getElementById('uncl-banner');
  if(uncl>0){banner.classList.add('show');document.getElementById('uncl-text').textContent=`${uncl} trip${uncl!==1?'s':''} to classify.`;}
  else{banner.classList.remove('show');}
}

// ===================== TRIPS =====================
function filterTrips(f,btn){
  app.tripFilter=f;
  document.querySelectorAll('.filter-tab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  renderTrips();
}
function renderTrips(){
  let trips=[...app.trips];
  if(app.tripFilter!=='all')trips=trips.filter(t=>t.category===app.tripFilter);
  const list=document.getElementById('trips-list');const empty=document.getElementById('trips-empty');
  if(!trips.length){list.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  const groups={};
  trips.forEach(t=>{const d=new Date(t.date);const key=d.toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'});if(!groups[key])groups[key]=[];groups[key].push(t);});
  let html='';
  for(const[date,dayTrips]of Object.entries(groups)){
    const dayTotal=dayTrips.reduce((s,x)=>s+x.miles,0);
    html+=`<div class="trip-date-header">${date} <span style="float:right;color:var(--text3);font-weight:400">${dayTrips.length} trip${dayTrips.length!==1?'s':''} &middot; ${dayTotal.toFixed(1)} mi</span></div>`;
    dayTrips.forEach(t=>{
      const d=new Date(t.date);const timeStr=d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
      const dur=t.duration?Math.round(t.duration/60000):0;
      const fromAddr=t.startName||'Start';const toAddr=t.endName||'Destination';
      const deduction=t.category==='business'?(t.miles*app.settings.irsRate).toFixed(2):'0.00';
      const bizSel=t.category==='business'?' sel-biz':'';const persSel=t.category==='personal'?' sel-pers':'';
      const catLabel=t.category==='business'?'Business':t.category==='personal'?'Personal':'Classify';
      const catColorSolid=t.category==='business'?'#00D4AA':t.category==='personal'?'#FF6B9D':'#FFB74D';
      const catColorAlpha=t.category==='business'?'rgba(0,212,170,':'rgba(255,107,157,';
      const seed=(t.id?parseInt(t.id)%100:50)/100;const curveY=30+seed*40;
      const miniMapHtml=`<div class="trip-mini-map" style="background:linear-gradient(135deg,${catColorAlpha}0.06) 0%,rgba(10,10,26,0.95) 100%)">
        <svg width="100%" height="100%" viewBox="0 0 400 100" preserveAspectRatio="none" style="position:absolute;inset:0">
          <defs><linearGradient id="rg${t.id}" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#00E676;stop-opacity:0.6"/><stop offset="100%" style="stop-color:${catColorSolid};stop-opacity:0.6"/></linearGradient></defs>
          <path d="M 30 70 Q 120 ${curveY} 200 50 Q 280 ${100-curveY} 370 30" fill="none" stroke="url(#rg${t.id})" stroke-width="2.5" stroke-dasharray="6,4" opacity="0.7"/>
          <circle cx="30" cy="70" r="5" fill="#00E676" opacity="0.9"/>
          <circle cx="370" cy="30" r="5" fill="#FF5252" opacity="0.9"/>
        </svg>
        <div style="position:absolute;bottom:8px;left:12px;font-size:10px;color:var(--text3);font-weight:500">${t.miles.toFixed(1)} miles</div>
        <div class="map-category-badge ${t.category}">${catLabel}</div>
      </div>`;
      html+=`<div class="trip-card" onclick="editTrip('${t.id}')">
        ${miniMapHtml}
        <div class="trip-route-section">
          <div class="trip-route-row">
            <div class="trip-route-dots"><div class="route-dot start"></div><div class="route-line"></div><div class="route-dot end"></div></div>
            <div class="trip-route-addrs"><div class="trip-addr from">${esc(fromAddr)}</div><div class="trip-addr to">${esc(toAddr)}</div></div>
            <div class="trip-miles-badge"><div class="mi-val">${t.miles.toFixed(1)}</div><div class="mi-unit">miles</div></div>
          </div>
        </div>
        <div class="trip-meta-row">
          <div class="trip-meta-left">
            <span>${timeStr}</span><span>${dur}min</span>
            ${t.category==='business'?`<span class="trip-deduction">+$${deduction}</span>`:''}
          </div>
        </div>
        <div class="trip-classify" onclick="event.stopPropagation()">
          <button class="classify-btn${bizSel}" onclick="setCat('${t.id}','business')"><span class="dot"></span> Business</button>
          <button class="classify-btn${persSel}" onclick="setCat('${t.id}','personal')"><span class="dot"></span> Personal</button>
        </div>
      </div>`;
    });
  }
  list.innerHTML=html;
}
function setCat(id,cat){
  const t=app.trips.find(x=>x.id===id);if(!t)return;
  t.category=cat;
  setSyncing(true);
  if(window._saveTrip){window._saveTrip(t).then(()=>setSyncing(false));}
  save();renderTrips();updateHomeStats();
}
function editTrip(id){
  const t=app.trips.find(x=>x.id===id);if(!t)return;
  app.editId=id;
  document.getElementById('ed-name').value=t.name||`${t.startName||'Start'} \u2192 ${t.endName||'Destination'}`;
  document.getElementById('ed-cat').value=t.category;
  document.getElementById('ed-miles').value=t.miles;
  document.getElementById('ed-notes').value=t.notes||'';
  document.getElementById('edit-modal').classList.add('show');
}
function closeModal(){document.getElementById('edit-modal').classList.remove('show');}
function openManualTrip(){
  document.getElementById('man-from').value='';document.getElementById('man-to').value='';
  document.getElementById('man-miles').value='';
  document.getElementById('man-cat').value=app.settings.defaultCat||'business';
  document.getElementById('man-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('man-notes').value='';
  document.getElementById('man-calc-dist').style.display='none';
  document.getElementById('manual-modal').classList.add('show');
}
function closeManualModal(){document.getElementById('manual-modal').classList.remove('show');}
function saveManualTrip(){
  const miles=parseFloat(document.getElementById('man-miles').value);
  if(!miles||miles<=0){showToast('Please enter miles');return;}
  const from=document.getElementById('man-from').value||'Start';
  const to=document.getElementById('man-to').value||'Destination';
  const dateVal=document.getElementById('man-date').value;
  const d=dateVal?new Date(dateVal+'T12:00:00'):new Date();
  const dur=Math.round(miles*2.5*60000);
  let cat=document.getElementById('man-cat').value;
  const savedCat=getAddrCategory(to)||getAddrCategory(from);
  if(savedCat&&cat==='unclassified')cat=savedCat;
  const trip={id:Date.now().toString(),category:cat,miles,date:d.toISOString(),duration:dur,startTime:d.toISOString(),endTime:new Date(d.getTime()+dur).toISOString(),startName:from,endName:to,name:'',notes:document.getElementById('man-notes').value,startCoord:null,endCoord:null};
  app.trips.unshift(trip);
  setSyncing(true);
  if(window._saveTrip)window._saveTrip(trip).then(()=>setSyncing(false));
  save();closeManualModal();updateHomeStats();
  showToast(`Trip added: ${miles} miles`);
  if(app.settings.tripAlerts)addNotification('trip','Trip Added',`${from} \u2192 ${to}: ${miles} miles`,null);
}
function saveEditTrip(){
  const t=app.trips.find(x=>x.id===app.editId);if(!t)return;
  t.name=document.getElementById('ed-name').value;t.category=document.getElementById('ed-cat').value;
  t.miles=parseFloat(document.getElementById('ed-miles').value)||t.miles;t.notes=document.getElementById('ed-notes').value;
  setSyncing(true);
  if(window._saveTrip)window._saveTrip(t).then(()=>setSyncing(false));
  save();closeModal();renderTrips();updateHomeStats();showToast('Trip updated');
}
function deleteTrip(){
  if(!confirm('Delete this trip?'))return;
  const id=app.editId;
  app.trips=app.trips.filter(x=>x.id!==id);
  setSyncing(true);
  if(window._deleteTrip)window._deleteTrip(id).then(()=>setSyncing(false));
  save();closeModal();renderTrips();updateHomeStats();showToast('Trip deleted');
}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}

// ===================== DASHBOARD =====================
function setDashPeriod(p,btn){
  app.dashPeriod=p;document.querySelectorAll('.period-pill').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');renderDashboard();
}
function renderDashboard(){
  const now=new Date();const dc=document.getElementById('dash-content');let filtered=[];
  if(app.dashPeriod==='day'){filtered=app.trips.filter(t=>new Date(t.date).toDateString()===now.toDateString());renderDayView(dc,filtered,now);return;}
  else if(app.dashPeriod==='week'){const wa=new Date(now);wa.setDate(wa.getDate()-7);filtered=app.trips.filter(t=>new Date(t.date)>=wa);}
  else if(app.dashPeriod==='month')filtered=app.trips.filter(t=>{const d=new Date(t.date);return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();});
  else filtered=app.trips.filter(t=>new Date(t.date).getFullYear()===now.getFullYear());
  const biz=filtered.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0);
  const pers=filtered.filter(t=>t.category==='personal').reduce((s,t)=>s+t.miles,0);
  const uncl=filtered.filter(t=>t.category==='unclassified').reduce((s,t)=>s+t.miles,0);
  const total=biz+pers+uncl;
  const periodLabel=app.dashPeriod==='week'?'This Week':app.dashPeriod==='month'?now.toLocaleDateString('en-US',{month:'long',year:'numeric'}):'Year '+now.getFullYear();
  let html=`<div class="dash-card"><div class="dash-card-title">${periodLabel} Summary</div><div class="summary-row"><div class="summary-item"><div class="val biz">${Math.round(biz)}</div><div class="lbl">Business mi</div></div><div class="summary-item"><div class="val pers">${Math.round(pers)}</div><div class="lbl">Personal mi</div></div><div class="summary-item"><div class="val total">${Math.round(total)}</div><div class="lbl">Total mi</div></div></div></div>`;
  html+=`<div class="dash-card"><div class="dash-card-title">Breakdown</div><div class="breakdown-bar">${total>0?`<div class="seg biz" style="width:${(biz/total*100).toFixed(0)}%"></div><div class="seg pers" style="width:${(pers/total*100).toFixed(0)}%"></div><div class="seg uncl" style="width:${(uncl/total*100).toFixed(0)}%"></div>`:'<div class="seg" style="width:100%;background:var(--bg)"></div>'}</div><div class="breakdown-legend">${total>0?`<div class="legend-item"><span class="legend-dot" style="background:var(--blue)"></span>Business ${(biz/total*100).toFixed(0)}%</div><div class="legend-item"><span class="legend-dot" style="background:var(--purple)"></span>Personal ${(pers/total*100).toFixed(0)}%</div>`:'<div class="legend-item" style="color:var(--text3)">No data</div>'}</div></div>`;
  html+=`<div class="dash-card tax-card"><h4>&#x1F4B0; Estimated Tax Deduction</h4><div class="tax-amount">$${(biz*app.settings.irsRate).toFixed(2)}</div><div class="tax-detail">${biz.toFixed(1)} business miles at $${app.settings.irsRate.toFixed(2)}/mile</div></div>`;
  // Top destinations
  const destCounts={};
  filtered.forEach(t=>{const dest=t.endName||'Unknown';if(!destCounts[dest])destCounts[dest]={count:0,miles:0,cat:t.category};destCounts[dest].count++;destCounts[dest].miles+=t.miles;});
  const topDests=Object.entries(destCounts).sort((a,b)=>b[1].count-a[1].count).slice(0,5);
  if(topDests.length){html+=`<div class="dash-card"><div class="dash-card-title">Top Destinations</div>`;topDests.forEach(([dest,info])=>{const cc=info.cat==='business'?'var(--blue)':info.cat==='personal'?'var(--purple)':'var(--orange)';html+=`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--card-border)"><div style="width:8px;height:8px;border-radius:50%;background:${cc};flex-shrink:0"></div><div style="flex:1"><div style="font-size:14px;font-weight:500">${esc(dest)}</div><div style="font-size:11px;color:var(--text2)">${info.count} trips &middot; ${info.miles.toFixed(1)} mi</div></div></div>`;});html+=`</div>`;}
  html+=`<div class="dash-card"><div class="dash-card-title">${app.dashPeriod==='year'?'Monthly Breakdown':'Mileage Chart'}</div><div class="chart-area" id="chart-area"></div><div style="display:flex;justify-content:space-around;margin-top:4px" id="chart-xlabels"></div><div style="display:flex;justify-content:center;gap:16px;margin-top:10px;font-size:12px;color:var(--text2)"><span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--blue);margin-right:4px"></span>Business</span><span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--purple);margin-right:4px"></span>Personal</span></div></div>`;
  html+=`<div class="dash-card"><div class="dash-card-title">Export Report</div><div class="export-btns"><button class="btn-exp" onclick="exportCSV()">&#128196; CSV</button><button class="btn-exp" onclick="exportPDF()">&#128462; PDF</button></div></div>`;
  dc.innerHTML=html;renderChart(filtered);
}
function renderDayView(dc,trips,date){
  const biz=trips.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0);
  const pers=trips.filter(t=>t.category==='personal').reduce((s,t)=>s+t.miles,0);
  const total=biz+pers+trips.filter(t=>t.category==='unclassified').reduce((s,t)=>s+t.miles,0);
  let html=`<div class="dash-card"><div class="dash-card-title">${date.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'})}</div><div class="summary-row"><div class="summary-item"><div class="val biz">${biz.toFixed(1)}</div><div class="lbl">Business</div></div><div class="summary-item"><div class="val pers">${pers.toFixed(1)}</div><div class="lbl">Personal</div></div><div class="summary-item"><div class="val total">${total.toFixed(1)}</div><div class="lbl">Total mi</div></div></div></div>`;
  html+=`<div class="add-trip-form"><h4>&#x2795; Quick Add Trip</h4><div class="form-row"><label>From</label><input type="text" id="day-from" placeholder="From address"></div><div class="form-row"><label>To</label><input type="text" id="day-to" placeholder="To address"></div><div id="day-calc-dist" style="display:none" class="calc-distance"><span>&#x1F4CD;</span><span id="day-calc-text">Calculating...</span></div><div class="form-row-inline"><div class="form-row"><label>Miles</label><input type="number" id="day-miles" step="0.1" placeholder="Auto or manual"></div><div class="form-row"><label>Category</label><select id="day-cat"><option value="business">Business</option><option value="personal">Personal</option></select></div></div><div class="form-btns"><button class="fbtn-save" onclick="addDayTrip()">Add Trip</button></div></div>`;
  if(trips.length){html+=`<div class="dash-card-title" style="padding:8px 4px">Today's Trips (${trips.length})</div>`;trips.forEach(t=>{const timeStr=new Date(t.date).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});const cc=t.category==='business'?'biz':t.category==='personal'?'pers':'uncl';html+=`<div class="day-trip-row"><div class="cat-dot ${cc}"></div><div class="route-info"><div class="addr">${esc(t.startName||'Start')} &rarr; ${esc(t.endName||'Dest')}</div><div class="meta">${timeStr} &middot; ${t.category} &middot; ${t.duration?Math.round(t.duration/60000)+'min':'--'}</div></div><div class="miles-col"><div class="mi">${t.miles.toFixed(1)}</div><div class="lbl">miles</div></div></div>`;});}
  else html+=`<div class="empty-state" style="padding:30px"><div class="icon">&#128663;</div><h3>No trips today</h3><p>Add a trip above or start driving</p></div>`;
  dc.innerHTML=html;
  setTimeout(()=>{const fe=document.getElementById('day-from');const te=document.getElementById('day-to');if(fe&&te){let dt=null;const h=()=>{clearTimeout(dt);dt=setTimeout(()=>calcDayDist(fe.value,te.value),800);};fe.addEventListener('input',h);te.addEventListener('input',h);}},100);
}
function calcDayDist(from,to){
  if(!from||!to||from.length<3||to.length<3){document.getElementById('day-calc-dist').style.display='none';return;}
  document.getElementById('day-calc-dist').style.display='flex';document.getElementById('day-calc-text').textContent='Calculating distance...';
  Promise.all([geocodeAddress(from),geocodeAddress(to)]).then(([fc,tc])=>{if(fc&&tc){const dist=Math.round(haversine(fc.lat,fc.lon,tc.lat,tc.lon)*1.3*10)/10;document.getElementById('day-calc-text').textContent=`Estimated: ${dist} miles`;document.getElementById('day-miles').value=dist;}else document.getElementById('day-calc-text').textContent='Address not found.';}).catch(()=>document.getElementById('day-calc-text').textContent='Lookup failed.');
}
function addDayTrip(){
  const miles=parseFloat(document.getElementById('day-miles').value);if(!miles||miles<=0){showToast('Enter miles');return;}
  const from=document.getElementById('day-from').value||'Start';const to=document.getElementById('day-to').value||'Destination';
  let cat=document.getElementById('day-cat').value;const savedCat=getAddrCategory(to)||getAddrCategory(from);if(savedCat)cat=savedCat;
  const now=new Date();
  const trip={id:Date.now().toString(),category:cat,miles,date:now.toISOString(),duration:Math.round(miles*2.5*60000),startTime:now.toISOString(),endTime:new Date(now.getTime()+Math.round(miles*2.5*60000)).toISOString(),startName:from,endName:to,name:'',notes:'',startCoord:null,endCoord:null};
  app.trips.unshift(trip);
  setSyncing(true);if(window._saveTrip)window._saveTrip(trip).then(()=>setSyncing(false));
  save();updateHomeStats();showToast(`Added: ${from} \u2192 ${to} (${miles} mi)`);renderDashboard();
}
function renderChart(trips){
  const chart=document.getElementById('chart-area');const labels=document.getElementById('chart-xlabels');if(!chart)return;
  let buckets=[];
  if(app.dashPeriod==='week'){const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const dt=trips.filter(t=>new Date(t.date).toDateString()===d.toDateString());buckets.push({label:days[d.getDay()],biz:dt.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0),pers:dt.filter(t=>t.category!=='business').reduce((s,t)=>s+t.miles,0)});}}
  else if(app.dashPeriod==='month'){const now=new Date();const weeks=Math.ceil(new Date(now.getFullYear(),now.getMonth()+1,0).getDate()/7);for(let w=0;w<weeks;w++){const wt=trips.filter(t=>Math.floor((new Date(t.date).getDate()-1)/7)===w);buckets.push({label:'W'+(w+1),biz:wt.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0),pers:wt.filter(t=>t.category!=='business').reduce((s,t)=>s+t.miles,0)});}}
  else{const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];for(let m=0;m<12;m++){const mt=trips.filter(t=>new Date(t.date).getMonth()===m);buckets.push({label:months[m],biz:mt.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0),pers:mt.filter(t=>t.category!=='business').reduce((s,t)=>s+t.miles,0)});}}
  const maxH=150,maxVal=Math.max(...buckets.map(b=>b.biz+b.pers),1);
  chart.innerHTML=buckets.map(b=>`<div class="chart-col"><div class="chart-stack"><div class="chart-seg pers" style="height:${(b.pers/maxVal)*maxH}px"></div><div class="chart-seg biz" style="height:${(b.biz/maxVal)*maxH}px"></div></div></div>`).join('');
  labels.innerHTML=buckets.map(b=>`<span style="flex:1;text-align:center;font-size:9px;color:var(--text3)">${b.label}</span>`).join('');
}

// ===================== EXPORT =====================
function exportCSV(){
  if(!app.trips.length){showToast('No trips');return;}
  const h='Date,Start Time,End Time,Category,Miles,Duration (min),From,To,Notes';
  const rows=app.trips.map(t=>{const d=new Date(t.date);return[d.toLocaleDateString(),t.startTime?new Date(t.startTime).toLocaleTimeString():'',t.endTime?new Date(t.endTime).toLocaleTimeString():'',t.category,t.miles.toFixed(2),t.duration?Math.round(t.duration/60000):'',`"${(t.startName||'').replace(/"/g,'""')}"`,`"${(t.endName||'').replace(/"/g,'""')}"`,`"${(t.notes||'').replace(/"/g,'""')}"`].join(',');});
  dl('MileTracker_Export.csv',h+'\n'+rows.join('\n'),'text/csv');showToast('CSV exported');
}
function exportPDF(){
  if(!app.trips.length){showToast('No trips');return;}
  const biz=app.trips.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0);
  const pers=app.trips.filter(t=>t.category==='personal').reduce((s,t)=>s+t.miles,0);
  const ded=biz*app.settings.irsRate;
  let html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>MileTracker Report</title><style>body{font-family:-apple-system,sans-serif;padding:40px;color:#1a1a2e;max-width:800px;margin:0 auto}h1{color:#007AFF;border-bottom:3px solid #007AFF;padding-bottom:10px}.sum{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin:24px 0;padding:24px;background:#f0f4ff;border-radius:12px}.si{text-align:center}.sv{font-size:32px;font-weight:800}.sl{font-size:12px;color:#666;text-transform:uppercase;margin-top:4px}table{width:100%;border-collapse:collapse;margin:20px 0}th{background:#007AFF;color:white;padding:10px;text-align:left;font-size:12px}td{padding:8px 10px;border-bottom:1px solid #eee;font-size:13px}tr:nth-child(even){background:#f8f9ff}</style></head><body><h1>MileTracker Report</h1><p>Generated: ${new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}</p><div class="sum"><div class="si"><div class="sv" style="color:#007AFF">${biz.toFixed(1)}</div><div class="sl">Business Miles</div></div><div class="si"><div class="sv" style="color:#AF52DE">${pers.toFixed(1)}</div><div class="sl">Personal Miles</div></div><div class="si"><div class="sv" style="color:#34C759">$${ded.toFixed(2)}</div><div class="sl">Tax Deduction</div></div></div><table><thead><tr><th>Date</th><th>Category</th><th>From</th><th>To</th><th>Miles</th><th>Duration</th></tr></thead><tbody>`;
  app.trips.forEach(t=>{const d=new Date(t.date);html+=`<tr><td>${d.toLocaleDateString()}</td><td>${t.category}</td><td>${esc(t.startName||'')}</td><td>${esc(t.endName||'')}</td><td>${t.miles.toFixed(2)}</td><td>${t.duration?Math.round(t.duration/60000)+'m':'--'}</td></tr>`;});
  html+='</tbody></table></body></html>';
  const w=window.open('','_blank');w.document.write(html);w.document.close();setTimeout(()=>w.print(),500);
}
function dl(name,content,type){const b=new Blob([content],{type});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;a.click();URL.revokeObjectURL(u);}

// ===================== SETTINGS =====================
function renderSettings(){
  // User profile section
  const user = window._currentUser;
  const profileSection = document.getElementById('user-profile-section');
  if (user) {
    const initials = (user.displayName||user.email||'?').split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
    const avatarHtml = user.photoURL ? `<img src="${user.photoURL}" alt="${user.displayName}">` : initials;
    profileSection.innerHTML = `
      <div class="user-profile-card">
        <div class="user-profile-avatar">${avatarHtml}</div>
        <div class="user-profile-info" style="flex:1">
          <h4>${esc(user.displayName||'User')}</h4>
          <p>${esc(user.email||'')}</p>
          <div class="sync-badge">Synced to cloud</div>
        </div>
        <button class="btn-signout" onclick="window._signOut()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
          Sign Out
        </button>
      </div>`;
  }
  document.getElementById('tog-auto').className='toggle'+(app.settings.autoDetect?' on':'');
  document.getElementById('tog-tripalert').className='toggle'+(app.settings.tripAlerts?' on':'');
  document.getElementById('tog-classify').className='toggle'+(app.settings.classifyReminders?' on':'');
  document.getElementById('tog-weekly').className='toggle'+(app.settings.weeklySummary?' on':'');
  document.getElementById('set-defcat').value=app.settings.defaultCat;
  document.getElementById('set-speed').value=app.settings.speedThreshold;
  document.getElementById('set-irs').value=app.settings.irsRate.toFixed(2);
  document.getElementById('set-count').textContent=app.trips.length+' trips';
  const sal=document.getElementById('saved-addresses-list');
  const addrs=Object.entries(app.savedAddresses);
  if(!addrs.length)sal.innerHTML='<div class="setting-row"><div class="info"><h4>No saved addresses</h4><p>Addresses are learned from your trips</p></div></div>';
  else sal.innerHTML=addrs.map(([k,v])=>`<div class="setting-row"><div class="info"><h4>${esc(v.name)}</h4><p>${v.category} &middot; ${v.count} trips</p></div><button class="btn-danger" onclick="deleteAddr('${k}')" style="padding:4px 10px;font-size:12px">Remove</button></div>`).join('');
}
function deleteAddr(key){delete app.savedAddresses[key];save();renderSettings();}
function toggleSetting(key){app.settings[key]=!app.settings[key];save();renderSettings();}
function updateSetting(type){
  if(type==='defaultCat')app.settings.defaultCat=document.getElementById('set-defcat').value;
  if(type==='speed')app.settings.speedThreshold=parseInt(document.getElementById('set-speed').value)||5;
  if(type==='irs')app.settings.irsRate=parseFloat(document.getElementById('set-irs').value)||IRS_RATE_2026;
  save();
}
function clearAllData(){
  if(!confirm('Delete ALL trips?'))return;
  app.trips=[];app.notifications=[];app.savedAddresses={};
  if(window._clearAllFirestore)window._clearAllFirestore();
  save();updateHomeStats();renderSettings();showToast('All data cleared');
}

// ===================== ALWAYS-ON GPS MONITOR =====================
let monitorWatchId=null,pollTimer=null,speedHistory=[],stopCounter=0;
let lastMonitorTime=null,gpsReady=false,positionCount=0;
const DRIVE_DETECT_COUNT=2,STOP_DETECT_COUNT=12;

function debugLog(msg){const el=document.getElementById('gps-debug');if(!el)return;const t=new Date().toLocaleTimeString();el.innerHTML=`[${t}] ${msg}<br>`+el.innerHTML;if(el.children.length>20)el.innerHTML=el.innerHTML.split('<br>').slice(0,15).join('<br>');}
function calcSpeedBetween(lat1,lon1,t1,lat2,lon2,t2){const d=haversine(lat1,lon1,lat2,lon2);const h=(t2-t1)/3600000;return h<=0?0:d/h;}
function setGPS(status){
  const dot=document.getElementById('gps-dot'),text=document.getElementById('gps-text');
  dot.className='status-dot';dot.style.background='';
  if(status==='monitoring'){dot.classList.add('active');text.textContent='GPS Active \u2022 Always On';}
  else if(status==='recording'){dot.style.background='var(--red)';text.textContent='Recording Trip...';}
  else if(status==='searching'){dot.classList.add('searching');text.textContent='Acquiring GPS...';}
  else if(status==='error'){dot.classList.add('error');text.textContent='GPS Error';}
}
function startAlwaysOnMonitor(){
  if(!navigator.geolocation){setGPS('error');debugLog('No Geolocation API');return;}
  debugLog('Starting GPS...');setGPS('searching');
  document.getElementById('drive-sublabel').textContent='Requesting GPS access...';
  try{monitorWatchId=navigator.geolocation.watchPosition(handlePosition,handleError,{enableHighAccuracy:true,maximumAge:2000,timeout:10000});debugLog('watchPosition ID:'+monitorWatchId);}catch(e){debugLog('watchPosition failed:'+e.message);}
  startPolling();
  setTimeout(()=>{if(!gpsReady){debugLog('No GPS 5s - show button');document.getElementById('gps-activate').style.display='block';document.getElementById('drive-sublabel').textContent='Tap button below to activate GPS.';}},5000);
}
function startPolling(){if(pollTimer)clearInterval(pollTimer);pollTimer=setInterval(()=>{navigator.geolocation.getCurrentPosition(handlePosition,(e)=>{debugLog('Poll:'+e.message);},{enableHighAccuracy:true,maximumAge:1000,timeout:8000});},3000);debugLog('Polling started');}
function activateGPS(){
  debugLog('Manual activate');document.getElementById('gps-activate').style.display='none';
  document.getElementById('drive-sublabel').textContent='Activating GPS...';
  if(monitorWatchId!==null)navigator.geolocation.clearWatch(monitorWatchId);
  if(pollTimer)clearInterval(pollTimer);
  navigator.geolocation.getCurrentPosition(
    (pos)=>{debugLog('Manual OK');handlePosition(pos);monitorWatchId=navigator.geolocation.watchPosition(handlePosition,handleError,{enableHighAccuracy:true,maximumAge:2000,timeout:10000});startPolling();},
    (err)=>{debugLog('Manual FAIL:'+err.message);if(err.code===1)updateDriveUI('denied');else{document.getElementById('drive-sublabel').textContent='GPS error. Try again.';document.getElementById('gps-activate').style.display='block';}},
    {enableHighAccuracy:true,maximumAge:0,timeout:15000}
  );
}
function updateDriveUI(state){
  const circle=document.getElementById('drive-circle'),icon=document.getElementById('drive-icon'),label=document.getElementById('drive-label'),sub=document.getElementById('drive-sublabel');
  circle.className='drive-circle';
  if(state==='monitoring'){circle.classList.add('monitoring');icon.innerHTML='&#x1F7E2;';label.textContent='Always On';label.style.color='var(--green)';sub.textContent='GPS monitoring active. Trips auto-detect when you drive.';}
  else if(state==='recording'){circle.classList.add('recording');icon.innerHTML='&#x1F534;';label.textContent='Recording Trip';label.style.color='var(--red)';sub.textContent='Driving detected. Will auto-save when you stop.';}
  else if(state==='saved'){circle.classList.add('monitoring');icon.innerHTML='&#x2705;';label.textContent='Trip Saved!';label.style.color='var(--green)';}
  else if(state==='denied'){circle.classList.add('inactive');icon.innerHTML='&#x274C;';label.textContent='Location Denied';label.style.color='var(--red)';sub.textContent='Allow location in browser settings and refresh.';}
}
function handlePosition(pos){
  const{latitude,longitude,speed,accuracy}=pos.coords;const now=Date.now();positionCount++;
  if(!gpsReady){gpsReady=true;document.getElementById('gps-activate').style.display='none';debugLog('GPS READY');updateDriveUI('monitoring');}
  let gpsSpeed=(speed!==null&&speed>=0)?speed*2.237:0;let calcSpeed=0;
  if(lastMonitorPos&&lastMonitorTime&&(now-lastMonitorTime)>500){calcSpeed=calcSpeedBetween(lastMonitorPos.lat,lastMonitorPos.lng,lastMonitorTime,latitude,longitude,now);if(calcSpeed>200)calcSpeed=0;}
  const mph=Math.max(gpsSpeed,calcSpeed);
  if(accuracy>300){debugLog('Skip acc:'+Math.round(accuracy));return;}
  lastMonitorPos={lat:latitude,lng:longitude};lastMonitorTime=now;
  document.getElementById('idle-speed').textContent=Math.round(mph);
  document.getElementById('idle-accuracy').textContent=`GPS: \u00B1${Math.round(accuracy)}m | #${positionCount}`;
  updateMapPosition(latitude,longitude);
  if(!app.tracking){
    setGPS('monitoring');
    if(mph>app.settings.speedThreshold){speedHistory.push(mph);if(speedHistory.length>=DRIVE_DETECT_COUNT){speedHistory=[];stopCounter=0;showToast('Driving detected!');debugLog('=== TRIP START ===');autoStartTracking(pos);}}
    else{if(mph<app.settings.speedThreshold*0.5)speedHistory=[];}
  } else {
    onPos(pos);document.getElementById('live-speed').textContent=Math.round(mph)+' mph';
    if(mph<3){stopCounter++;if(stopCounter>=STOP_DETECT_COUNT){stopCounter=0;debugLog('=== TRIP END ===');stopTracking();}}else{stopCounter=0;}
  }
}
function handleError(err){
  debugLog('GPS Error:'+err.code+' '+err.message);
  if(err.code===1){setGPS('error');updateDriveUI('denied');}
  else{document.getElementById('drive-sublabel').textContent='GPS unavailable. Try again.';document.getElementById('gps-activate').style.display='block';}
}
function autoStartTracking(initialPos){
  app.tracking=true;positions=[];trackStart=Date.now();
  const{latitude,longitude,speed,accuracy}=initialPos.coords;
  if(accuracy<150)positions.push({lat:latitude,lng:longitude,time:Date.now(),speed,accuracy});
  updateDriveUI('recording');setGPS('recording');
  document.getElementById('idle-speed-wrap').style.display='none';document.getElementById('idle-accuracy').style.display='none';
  document.getElementById('live-panel').classList.add('show');
  document.getElementById('live-miles').textContent='0.0';document.getElementById('live-duration').textContent='0m';
  trackTimer=setInterval(updateDuration,1000);
  if(leafletMap){trackPolyline=L.polyline([],{color:'#FF5252',weight:4}).addTo(leafletMap);trackPolyline.addLatLng([latitude,longitude]);}
  if(app.settings.tripAlerts)addNotification('trip','Trip Started','Driving detected. Auto-recording.',null);
}
function stopTracking(){
  app.tracking=false;
  if(watchId!==null){navigator.geolocation.clearWatch(watchId);watchId=null;}
  if(trackTimer){clearInterval(trackTimer);trackTimer=null;}
  const miles=calcDistance();const dur=Date.now()-trackStart;
  const startPt=positions.length>0?positions[0]:null;const endPt=positions.length>1?positions[positions.length-1]:null;
  const saveMiles=miles>0?Math.round(miles*100)/100:0;
  const trip={id:Date.now().toString(),category:'unclassified',miles:saveMiles,date:new Date().toISOString(),duration:dur,startTime:new Date(trackStart).toISOString(),endTime:new Date().toISOString(),startName:'Locating...',endName:'Locating...',name:'',notes:'',startCoord:startPt?{lat:startPt.lat,lng:startPt.lng}:null,endCoord:endPt?{lat:endPt.lat,lng:endPt.lng}:null};
  if(saveMiles<0.1){debugLog('Trip too short, discarding');document.getElementById('live-panel').classList.remove('show');document.getElementById('idle-speed-wrap').style.display='';document.getElementById('idle-accuracy').style.display='';updateDriveUI('monitoring');setGPS('monitoring');stopCounter=0;speedHistory=[];return;}
  closeMap();
  let resolved=0;
  const checkReady=()=>{resolved++;if(resolved>=2)showTripSummary(trip);};
  if(startPt)reverseGeocode(startPt.lat,startPt.lng,name=>{trip.startName=name;checkReady();});else{trip.startName='Unknown';checkReady();}
  if(endPt)reverseGeocode(endPt.lat,endPt.lng,name=>{trip.endName=name;checkReady();});else{trip.endName='Unknown';checkReady();}
  document.getElementById('live-panel').classList.remove('show');document.getElementById('idle-speed-wrap').style.display='';document.getElementById('idle-accuracy').style.display='';
  updateDriveUI('saved');document.getElementById('drive-sublabel').textContent=`${saveMiles.toFixed(1)} miles recorded.`;
  setTimeout(()=>updateDriveUI('monitoring'),3000);setGPS('monitoring');stopCounter=0;speedHistory=[];
}

// ===================== TRIP SUMMARY =====================
function showTripSummary(trip){
  pendingSummaryTrip=trip;
  document.getElementById('sum-miles').textContent=trip.miles.toFixed(1);
  document.getElementById('sum-from').textContent=trip.startName;
  document.getElementById('sum-to').textContent=trip.endName;
  const durMin=trip.duration?Math.round(trip.duration/60000):0;
  document.getElementById('sum-dur').textContent=durMin>60?Math.floor(durMin/60)+'h '+durMin%60+'m':durMin+'min';
  document.getElementById('sum-speed').textContent=(trip.duration>0?(trip.miles/(trip.duration/3600000)).toFixed(0):'0')+' mph';
  const autoCat=autoClassifyTrip(trip);document.getElementById('sum-cat').value=autoCat||'unclassified';
  const addrRows=document.getElementById('sum-addr-rows');let addrHtml='';
  [trip.startName,trip.endName].forEach((addr,i)=>{
    if(!addr||addr==='Unknown'||addr==='Locating...')return;
    const saved=getAddrCategory(addr);const bizSel=saved==='business'?' sel':'';const persSel=saved==='personal'?' sel-p':'';
    addrHtml+=`<div class="addr-row"><div class="addr-name">${esc(addr.length>30?addr.substring(0,30)+'...':addr)}</div><div class="addr-btns"><button class="addr-btn${bizSel}" onclick="classifyAddr(this,'${i}','business')">&#128188; Biz</button><button class="addr-btn${persSel}" onclick="classifyAddr(this,'${i}','personal')">&#128100; Personal</button></div></div>`;
  });
  addrRows.innerHTML=addrHtml||'<div style="color:var(--text3);font-size:13px">No addresses to classify</div>';
  document.getElementById('summary-modal').classList.add('show');
}
function classifyAddr(btn,idx,cat){
  const row=btn.parentElement;row.querySelectorAll('.addr-btn').forEach(b=>{b.classList.remove('sel');b.classList.remove('sel-p');});
  btn.classList.add(cat==='business'?'sel':'sel-p');
  const addr=idx==='0'?pendingSummaryTrip.startName:pendingSummaryTrip.endName;
  saveAddrCategory(addr,cat);document.getElementById('sum-cat').value=cat;
}
function saveTripSummary(){
  if(!pendingSummaryTrip)return;
  pendingSummaryTrip.category=document.getElementById('sum-cat').value;
  app.trips.unshift(pendingSummaryTrip);
  setSyncing(true);
  if(window._saveTrip)window._saveTrip(pendingSummaryTrip).then(()=>setSyncing(false));
  save();
  document.getElementById('summary-modal').classList.remove('show');
  updateHomeStats();showToast(`Trip saved: ${pendingSummaryTrip.miles.toFixed(1)} mi`);
  if(app.settings.tripAlerts)addNotification('trip','Trip Saved',`${pendingSummaryTrip.startName} \u2192 ${pendingSummaryTrip.endName}: ${pendingSummaryTrip.miles.toFixed(1)} mi`,'classify');
  pendingSummaryTrip=null;
}

// ===================== MODAL CLOSE ON BACKDROP =====================
document.getElementById('edit-modal').addEventListener('click',function(e){if(e.target===this)closeModal();});
document.getElementById('manual-modal').addEventListener('click',function(e){if(e.target===this)closeManualModal();});
setupDistanceCalc();
// Start with login screen shown (Firebase will trigger showApp when auth state is ready)
showLogin();
// Set hostname in config screen if visible
setTimeout(() => {
  const el = document.getElementById('cfg-hostname');
  if (el) el.textContent = window.location.hostname || 'your-site.github.io';
}, 200);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MileTracker">
<meta name="theme-color" content="#0a0a1a">
<link rel="manifest" href="manifest.json">
<title>MileTracker - Smart Mileage Tracking</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, deleteDoc, writeBatch, onSnapshot }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // =============================================
  // ðŸ”§ PASTE YOUR FIREBASE CONFIG HERE
  // Get this from: Firebase Console â†’ Project Settings â†’ Your apps â†’ SDK setup
  // =============================================
  const firebaseConfig = {
    apiKey: "AIzaSyCOmth_ROgpSK54nIUoszVf9kBO0Mf1oPM",
    authDomain: "mile-tracker-71aee.firebaseapp.com",
    projectId: "mile-tracker-71aee",
    storageBucket: "mile-tracker-71aee.firebasestorage.app",
    messagingSenderId: "704629301384",
    appId: "1:704629301384:web:ba4842eff8654bc1d2bf3d",
    measurementId: "G-THHCMF6K7S"
  };
  // =============================================

  // Check if config has been filled in
  const isConfigured = firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY";

  if (!isConfigured) {
    // Show config needed screen instead of login
    const showConfigScreen = () => {
      const ls = document.getElementById('login-screen');
      const cs = document.getElementById('config-screen');
      if (ls) ls.classList.remove('show');
      if (cs) cs.style.display = 'flex';
    };
    if (document.readyState === 'loading') {
      window.addEventListener('DOMContentLoaded', showConfigScreen);
    } else {
      showConfigScreen();
      // Also try after a short delay in case DOM isn't fully ready
      setTimeout(showConfigScreen, 100);
    }
    window._signIn = () => alert('Please add your Firebase config first. See the setup guide.');
    window._signOut = () => {};
    window._saveTrip = () => {};
    window._deleteTrip = () => {};
    window._saveSettings = () => {};
    window._clearAllFirestore = () => {};
  } else {
    // Firebase is configured â€” initialize normally
    let unsubscribeFirestore = null;

    try {
      const firebaseApp = initializeApp(firebaseConfig);
      const auth = getAuth(firebaseApp);
      const db = getFirestore(firebaseApp);
      const provider = new GoogleAuthProvider();
      provider.setCustomParameters({ prompt: 'select_account' });

      window._fb = { auth, db, provider };

      // Auth state listener
      onAuthStateChanged(auth, (user) => {
        window._currentUser = user;
        if (user) {
          if (typeof showApp === 'function') showApp(user);
          loadFromFirestore(user.uid);
        } else {
          if (typeof showLogin === 'function') showLogin();
        }
      });

      window._signIn = async () => {
        const btn = document.getElementById('signin-btn');
        const original = btn.innerHTML;
        try {
          btn.innerHTML = '<span style="opacity:0.7">Signing in...</span>';
          btn.disabled = true;
          await signInWithPopup(auth, provider);
        } catch(e) {
          console.error('Sign-in error:', e.code, e.message);
          btn.innerHTML = original;
          btn.disabled = false;
          if (e.code === 'auth/popup-blocked') {
            if (typeof showToast === 'function') showToast('Popup blocked! Allow popups for this site.');
            else alert('Popup blocked! Please allow popups for this site in your browser settings.');
          } else if (e.code === 'auth/unauthorized-domain') {
            if (typeof showToast === 'function') showToast('Domain not authorized. Check Firebase settings.');
            else alert('This domain is not authorized in Firebase.\nGo to Firebase Console â†’ Authentication â†’ Settings â†’ Authorized domains\nand add: ' + window.location.hostname);
          } else if (e.code === 'auth/cancelled-popup-request' || e.code === 'auth/popup-closed-by-user') {
            btn.innerHTML = original; // user closed popup, no error needed
          } else {
            if (typeof showToast === 'function') showToast('Sign-in failed: ' + (e.code || e.message));
            else alert('Sign-in error: ' + e.message);
          }
        }
      };

      window._signOut = async () => {
        if (!confirm('Sign out of MileTracker?')) return;
        if (unsubscribeFirestore) { unsubscribeFirestore(); unsubscribeFirestore = null; }
        await signOut(auth);
      };

      async function loadFromFirestore(uid) {
        try {
          const settingsDoc = await getDoc(doc(db, 'users', uid, 'data', 'settings'));
          if (settingsDoc.exists()) {
            app.settings = { ...app.settings, ...settingsDoc.data() };
          }
          const addrDoc = await getDoc(doc(db, 'users', uid, 'data', 'addresses'));
          if (addrDoc.exists()) {
            app.savedAddresses = addrDoc.data().addresses || {};
          }
          const tripsRef = collection(db, 'users', uid, 'trips');
          if (unsubscribeFirestore) unsubscribeFirestore();
          unsubscribeFirestore = onSnapshot(tripsRef, (snapshot) => {
            app.trips = [];
            snapshot.forEach(d => app.trips.push({ id: d.id, ...d.data() }));
            app.trips.sort((a,b) => new Date(b.date) - new Date(a.date));
            if (typeof updateHomeStats === 'function') updateHomeStats();
            if (typeof updateNotifBadge === 'function') updateNotifBadge();
            const tp = document.getElementById('page-trips');
            const dp = document.getElementById('page-dashboard');
            if (tp && tp.classList.contains('active') && typeof renderTrips === 'function') renderTrips();
            if (dp && dp.classList.contains('active') && typeof renderDashboard === 'function') renderDashboard();
          }, (err) => {
            console.error('Firestore snapshot error:', err);
          });
          if (typeof updateHomeStats === 'function') updateHomeStats();
          if (typeof renderSettings === 'function') renderSettings();
        } catch(e) {
          console.error('Firestore load error:', e);
          if (typeof showToast === 'function') showToast('Cloud sync error. Working offline.');
        }
      }

      window._saveTrip = async (trip) => {
        if (!window._currentUser) return;
        try {
          const tripData = { ...trip };
          delete tripData.id;
          await setDoc(doc(db, 'users', window._currentUser.uid, 'trips', trip.id), tripData);
        } catch(e) { console.error('Save trip error:', e); }
      };

      window._deleteTrip = async (tripId) => {
        if (!window._currentUser) return;
        try {
          await deleteDoc(doc(db, 'users', window._currentUser.uid, 'trips', tripId));
        } catch(e) { console.error('Delete trip error:', e); }
      };

      window._saveSettings = async () => {
        if (!window._currentUser) return;
        try {
          const uid = window._currentUser.uid;
          await setDoc(doc(db, 'users', uid, 'data', 'settings'), app.settings);
          await setDoc(doc(db, 'users', uid, 'data', 'addresses'), { addresses: app.savedAddresses });
        } catch(e) { console.error('Save settings error:', e); }
      };

      window._clearAllFirestore = async () => {
        if (!window._currentUser) return;
        try {
          const uid = window._currentUser.uid;
          const tripsRef = collection(db, 'users', uid, 'trips');
          const snap = await getDoc(doc(db, 'users', uid, 'trips', '_placeholder')); // check access
          const { getDocs } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
          const allTrips = await getDocs(tripsRef);
          const batch = writeBatch(db);
          allTrips.forEach(d => batch.delete(d.ref));
          await batch.commit();
          await setDoc(doc(db, 'users', uid, 'data', 'addresses'), { addresses: {} });
        } catch(e) { console.error('Clear error:', e); }
      };

    } catch(initError) {
      console.error('Firebase init error:', initError);
      window._signIn = () => {
        alert('Firebase initialization failed.\n\nError: ' + initError.message + '\n\nCheck that your firebaseConfig values are correct in index.html');
      };
      window._signOut = window._saveTrip = window._deleteTrip = window._saveSettings = window._clearAllFirestore = () => {};
    }
  }
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

:root {
  --bg: #0a0a1a;
  --bg-secondary: #12122a;
  --card: rgba(255, 255, 255, 0.06);
  --card-border: rgba(255, 255, 255, 0.08);
  --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  --blue: #4F8EF7;
  --blue-light: rgba(79, 142, 247, 0.15);
  --teal: #00D4AA;
  --teal-light: rgba(0, 212, 170, 0.15);
  --pink: #FF6B9D;
  --pink-light: rgba(255, 107, 157, 0.15);
  --green: #00E676;
  --green-light: rgba(0, 230, 118, 0.15);
  --orange: #FFB74D;
  --red: #FF5252;
  --purple: #6C63FF;
  --text: #FFFFFF;
  --text2: rgba(255, 255, 255, 0.6);
  --text3: rgba(255, 255, 255, 0.3);
  --safe-top: env(safe-area-inset-top, 20px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(135deg, var(--bg) 0%, var(--bg-secondary) 100%);
  color: var(--text);
  min-height: 100vh;
  min-height: 100dvh;
  overflow-x: hidden;
}

/* ===== LOGIN SCREEN ===== */
#login-screen {
  display: none;
  position: fixed;
  inset: 0;
  background: linear-gradient(135deg, #0a0a1a 0%, #12122a 50%, #1a0a2e 100%);
  z-index: 1000;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 24px;
  text-align: center;
}
#login-screen.show { display: flex; }

.login-logo {
  width: 80px;
  height: 80px;
  background: linear-gradient(135deg, #4F8EF7 0%, #6C63FF 100%);
  border-radius: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 24px;
  box-shadow: 0 20px 60px rgba(79, 142, 247, 0.4);
}
.login-logo svg { width: 48px; height: 48px; fill: white; }

.login-title {
  font-size: 36px;
  font-weight: 800;
  letter-spacing: -1px;
  margin-bottom: 8px;
  background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.7) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.login-sub {
  font-size: 16px;
  color: var(--text2);
  margin-bottom: 60px;
  line-height: 1.5;
}

.login-features {
  display: flex;
  flex-direction: column;
  gap: 14px;
  margin-bottom: 52px;
  width: 100%;
  max-width: 320px;
}
.login-feature {
  display: flex;
  align-items: center;
  gap: 14px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 14px;
  padding: 14px 18px;
  text-align: left;
}
.login-feature .feat-icon { font-size: 24px; flex-shrink: 0; }
.login-feature .feat-text h4 { font-size: 14px; font-weight: 600; }
.login-feature .feat-text p { font-size: 12px; color: var(--text2); margin-top: 2px; }

#signin-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  width: 100%;
  max-width: 320px;
  padding: 16px 24px;
  background: white;
  color: #1a1a2e;
  border: none;
  border-radius: 14px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
  box-shadow: 0 8px 32px rgba(79, 142, 247, 0.3);
  transition: all 0.3s ease;
}
#signin-btn:active { transform: scale(0.97); }
#signin-btn svg { width: 22px; height: 22px; }

.login-privacy {
  font-size: 11px;
  color: var(--text3);
  margin-top: 16px;
  max-width: 280px;
  line-height: 1.5;
}

/* ===== APP SHELL ===== */
#app-shell { display: none; }
#app-shell.show { display: block; }

/* HEADER */
.app-header {
  background: #0a0a1a;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  padding: calc(var(--safe-top) + 12px) 20px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
}
.header-left { display: flex; align-items: center; gap: 12px; }
.header-logo {
  width: 40px; height: 40px;
  background: linear-gradient(135deg, #4F8EF7 0%, #6C63FF 100%);
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 8px 24px rgba(79, 142, 247, 0.3);
}
.header-logo svg { width: 24px; height: 24px; fill: white; }
.header-title { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
.header-right { display: flex; align-items: center; gap: 10px; }
.header-btn {
  width: 40px; height: 40px; border-radius: 12px;
  background: rgba(255,255,255,0.08); border: 1px solid var(--card-border);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: var(--text2); font-size: 18px; transition: all 0.3s ease;
}
.header-btn:hover { background: rgba(255,255,255,0.12); color: var(--blue); }

/* User avatar */
.user-avatar {
  width: 36px; height: 36px; border-radius: 50%;
  background: linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%);
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 700; color: white; cursor: pointer;
  border: 2px solid rgba(79,142,247,0.4); overflow: hidden;
  flex-shrink: 0;
}
.user-avatar img { width: 100%; height: 100%; object-fit: cover; }

/* Sync status dot */
.sync-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--green);
  animation: glow-pulse 3s infinite;
  flex-shrink: 0;
}
.sync-dot.syncing { background: var(--orange); animation: blink 0.8s infinite; }
.sync-dot.offline { background: var(--red); animation: none; }

/* STATUS BAR */
.status-bar {
  background: #0d0d20;
  border-bottom: 1px solid rgba(255,255,255,0.06);
  padding: 12px 20px;
  display: flex; align-items: center; gap: 10px;
}
.status-dot { width:10px; height:10px; border-radius:50%; background:var(--text3); flex-shrink:0; }
.status-dot.active { background:var(--green); animation:glow-pulse 2s infinite; }
.status-dot.searching { background:var(--orange); animation:blink 1.2s infinite; }
.status-dot.error { background:var(--red); }
.status-text { font-size:13px; color:var(--text2); }

/* BOTTOM NAV */
.bottom-nav {
  position: fixed; bottom:0; left:0; right:0;
  background: #0a0a1a; border-top: 1px solid rgba(255,255,255,0.08);
  display: flex; padding: 8px 0 calc(8px + var(--safe-bottom)); z-index:100;
}
.nav-item {
  flex:1; display:flex; flex-direction:column; align-items:center; gap:4px;
  padding:8px 0; border:none; background:none; cursor:pointer; font-family:inherit;
  position:relative; transition:all 0.3s ease;
}
.nav-item svg { width:24px; height:24px; fill:var(--text3); transition:all 0.3s ease; }
.nav-item span { font-size:10px; font-weight:500; color:var(--text3); transition:all 0.3s ease; }
.nav-item.active svg { fill:var(--blue); }
.nav-item.active span { color:var(--blue); }
.nav-item.active::before {
  content:''; position:absolute; top:0; left:50%; transform:translateX(-50%);
  width:20px; height:3px;
  background:linear-gradient(90deg, var(--blue) 0%, var(--teal) 100%); border-radius:2px;
}

/* PAGES */
.page { display:none; padding:0 0 100px; }
.page.active { display:block; }

/* ANIMATIONS */
@keyframes glow-pulse { 0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(79,142,247,0.7);}50%{opacity:0.8;box-shadow:0 0 0 10px rgba(79,142,247,0);} }
@keyframes blink { 0%,100%{opacity:1;}50%{opacity:0.2;} }
@keyframes record-pulse { 0%,100%{box-shadow:0 0 0 0 rgba(255,82,82,0.7);}50%{box-shadow:0 0 0 15px rgba(255,82,82,0);} }
@keyframes slide-up { from{transform:translateY(100%);opacity:0;}to{transform:translateY(0);opacity:1;} }
@keyframes fade-in { from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);} }

/* DRIVE PAGE */
.drive-hero { background:#0d0d20; border-bottom:1px solid rgba(255,255,255,0.06); padding:32px 20px 24px; text-align:center; }
.drive-circle { width:140px; height:140px; border-radius:50%; margin:0 auto 20px; position:relative; display:flex; align-items:center; justify-content:center; transition:all 0.3s ease; }
.drive-circle.monitoring { background:rgba(0,230,118,0.15); border:3px solid var(--green); box-shadow:0 0 30px rgba(0,230,118,0.3); }
.drive-circle.recording { background:rgba(255,82,82,0.15); border:3px solid var(--red); animation:record-pulse 2s infinite; box-shadow:0 0 30px rgba(255,82,82,0.4); }
.drive-circle.inactive { background:rgba(255,255,255,0.04); border:3px solid var(--text3); }
.drive-circle-inner { font-size:48px; line-height:1; }
.drive-label { font-size:24px; font-weight:700; margin-bottom:6px; }
.drive-sublabel { font-size:14px; color:var(--text2); margin-bottom:20px; line-height:1.5; }
.drive-speed { display:inline-flex; align-items:baseline; gap:6px; background:rgba(79,142,247,0.15); padding:12px 28px; border-radius:24px; margin-bottom:10px; border:1px solid rgba(79,142,247,0.3); }
.drive-speed .num { font-size:40px; font-weight:300; color:var(--blue); }
.drive-speed .unit { font-size:14px; color:var(--text2); font-weight:500; }
.drive-accuracy { font-size:12px; color:var(--text3); margin-top:8px; }
.live-panel { display:none; background:#0d0d20; border-bottom:1px solid rgba(255,255,255,0.06); padding:24px 20px; text-align:center; animation:slide-up 0.4s ease; }
.live-panel.show { display:block; }
.live-stats { display:flex; justify-content:center; gap:60px; margin:10px 0; }
.live-stat .val { font-size:44px; font-weight:300; color:var(--blue); }
.live-stat .lbl { font-size:12px; color:var(--text2); text-transform:uppercase; letter-spacing:1px; font-weight:600; margin-top:4px; }
.live-speed-inline { font-size:18px; font-weight:600; color:var(--blue); margin-top:12px; }
.gps-activate-wrap { display:none; padding:0 20px 16px; }
.gps-activate-btn { width:100%; padding:16px; border-radius:14px; border:2px solid var(--blue); background:linear-gradient(135deg,rgba(79,142,247,0.2),rgba(108,99,255,0.2)); color:var(--blue); font-size:16px; font-weight:600; cursor:pointer; font-family:inherit; transition:all 0.3s ease; }
.map-btn-wrap { padding:16px; }
.map-btn { width:100%; padding:14px; border-radius:14px; background:rgba(255,255,255,0.06); border:1px solid var(--card-border); color:var(--text); font-size:15px; font-weight:600; cursor:pointer; font-family:inherit; display:flex; align-items:center; justify-content:center; gap:8px; box-shadow:0 4px 15px rgba(0,0,0,0.2); transition:all 0.3s ease; }
.map-btn:hover { background:rgba(255,255,255,0.1); }
.quick-stats { display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:20px 16px 0; }
.quick-stat { background:rgba(255,255,255,0.06); backdrop-filter:blur(20px); border:1px solid var(--card-border); border-radius:16px; padding:20px; box-shadow:0 4px 15px rgba(0,0,0,0.2); transition:all 0.3s ease; }
.quick-stat:hover { background:rgba(255,255,255,0.08); transform:translateY(-2px); }
.quick-stat .icon { font-size:24px; margin-bottom:8px; }
.quick-stat .val { font-size:24px; font-weight:700; line-height:1.1; }
.quick-stat .val.biz { color:var(--blue); }
.quick-stat .val.pers { color:var(--pink); }
.quick-stat .val.ded { color:var(--green); }
.quick-stat .val.trips { color:var(--blue); }
.quick-stat .lbl { font-size:12px; color:var(--text2); margin-top:6px; font-weight:500; }
.uncl-banner { margin:16px 16px 0; background:rgba(255,183,77,0.15); border:1px solid rgba(255,183,77,0.3); border-radius:14px; padding:16px; display:none; }
.uncl-banner.show { display:flex; align-items:center; gap:12px; animation:slide-up 0.3s ease; }
.uncl-banner .icon { font-size:24px; flex-shrink:0; }
.uncl-banner .info h4 { font-size:14px; font-weight:600; color:var(--orange); }
.uncl-banner .info p { font-size:12px; color:var(--text2); margin-top:2px; }
.manual-btn-wrap { padding:12px 16px 0; }
.manual-btn { width:100%; padding:14px; border:2px dashed var(--card-border); border-radius:14px; background:rgba(255,255,255,0.03); color:var(--text2); font-size:14px; font-weight:500; cursor:pointer; font-family:inherit; display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.3s ease; }
.manual-btn:hover { border-color:var(--card-border); background:rgba(255,255,255,0.06); color:var(--text); }
.debug-log { margin:16px; font-size:10px; color:var(--text3); text-align:left; max-height:80px; overflow-y:auto; background:rgba(255,255,255,0.04); border-radius:10px; padding:10px; font-family:'SF Mono',monospace; }

/* MAP OVERLAY */
.map-overlay { position:fixed; inset:0; z-index:200; background:#f5f5f5; display:none; flex-direction:column; }
.map-overlay.show { display:flex; }
.map-header { background:#ffffff; padding:calc(var(--safe-top)+8px) 16px 12px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #e0e0e0; z-index:201; }
.map-header h3 { font-size:18px; font-weight:700; color:#1a1a2e; }
.map-close { background:#f0f0f0; border:none; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; cursor:pointer; color:#333; transition:all 0.3s ease; }
.map-trip-count { font-size:11px; font-weight:600; padding:3px 10px; border-radius:12px; background:#e8f0fe; color:#1a73e8; }
.map-filter-bar { display:flex; gap:6px; padding:10px 16px; background:#ffffff; border-bottom:1px solid #e0e0e0; z-index:202; overflow-x:auto; }
.map-filter-pill { padding:6px 16px; border-radius:20px; border:1px solid #ddd; background:#fff; color:#666; font-size:12px; font-weight:600; cursor:pointer; font-family:inherit; white-space:nowrap; transition:all 0.3s ease; }
.map-filter-pill.active { background:#1a73e8; border-color:#1a73e8; color:white; }
.map-legend { display:flex; gap:14px; padding:8px 16px; background:rgba(255,255,255,0.95); position:absolute; bottom:180px; left:12px; border-radius:12px; z-index:203; border:1px solid #e0e0e0; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.map-legend-item { display:flex; align-items:center; gap:5px; font-size:11px; color:#555; font-weight:500; }
.map-legend-dot { width:8px; height:8px; border-radius:50%; }
.map-trips-panel { position:absolute; bottom:0; left:0; right:0; max-height:55vh; background:rgba(255,255,255,0.97); border-top:1px solid #e0e0e0; border-radius:20px 20px 0 0; z-index:204; overflow-y:auto; transition:max-height 0.3s ease; box-shadow:0 -4px 20px rgba(0,0,0,0.1); }
.map-trips-panel.collapsed { max-height:70px; overflow:hidden; }
.map-trips-handle { display:flex; justify-content:center; padding:10px; cursor:pointer; }
.map-trips-handle-bar { width:40px; height:4px; border-radius:2px; background:#ccc; }
.map-trips-summary { display:flex; gap:10px; padding:0 16px 12px; border-bottom:1px solid #eee; }
.map-sum-card { flex:1; text-align:center; padding:10px 6px; border-radius:12px; background:#f8f9fa; border:1px solid #eee; }
.map-sum-card .val { font-size:20px; font-weight:700; line-height:1; color:#1a1a2e; }
.map-sum-card .lbl { font-size:10px; color:#888; margin-top:3px; text-transform:uppercase; letter-spacing:0.5px; }
.map-trips-list { padding:8px 12px 20px; }
.map-trip-item { display:flex; align-items:center; gap:10px; padding:12px; margin-bottom:6px; border-radius:12px; background:#fff; border:1px solid #eee; cursor:pointer; transition:all 0.2s ease; }
.map-trip-item:active { transform:scale(0.98); }
.map-trip-item.selected { border-color:#1a73e8; background:#e8f0fe; }
.map-trip-dot { width:12px; height:12px; border-radius:50%; flex-shrink:0; }
.map-trip-dot.business { background:#00D4AA; }
.map-trip-dot.personal { background:#FF6B9D; }
.map-trip-dot.unclassified { background:#FFB74D; }
.map-trip-info { flex:1; min-width:0; }
.map-trip-info .route { font-size:13px; font-weight:600; color:#1a1a2e; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.map-trip-info .meta { font-size:11px; color:#888; margin-top:2px; }
.map-trip-miles { text-align:right; flex-shrink:0; }
.map-trip-miles .mi { font-size:16px; font-weight:700; color:#1a1a2e; }
.map-trip-miles .unit { font-size:10px; color:#aaa; }
#map-container { flex:1; }

/* TRIPS */
.trips-header { background:#0d0d20; border-bottom:1px solid rgba(255,255,255,0.06); padding:20px 20px 0; }
.trips-header h2 { font-size:28px; font-weight:700; margin-bottom:16px; }
.filter-row { display:flex; gap:0; }
.filter-tab { flex:1; padding:12px 0; text-align:center; font-size:14px; font-weight:500; color:var(--text3); border:none; background:none; cursor:pointer; font-family:inherit; position:relative; transition:all 0.3s ease; }
.filter-tab:hover { color:var(--text2); }
.filter-tab.active { color:var(--blue); font-weight:600; }
.filter-tab.active::after { content:''; position:absolute; bottom:-1px; left:10%; right:10%; height:3px; background:linear-gradient(90deg,var(--blue),var(--teal)); border-radius:2px; }
.trips-list { padding:16px; }
.trip-date-header { font-size:12px; font-weight:600; color:var(--text2); padding:12px 4px 8px; text-transform:uppercase; letter-spacing:0.5px; }
.trip-card { background:rgba(255,255,255,0.06); border:1px solid var(--card-border); border-radius:16px; margin-bottom:12px; box-shadow:0 4px 15px rgba(0,0,0,0.2); overflow:hidden; transition:all 0.3s ease; }
.trip-card:hover { background:rgba(255,255,255,0.08); border-color:rgba(255,255,255,0.12); }
.trip-card:active { transform:scale(0.98); }
.trip-mini-map { width:100%; height:90px; background:#1a1a2e; position:relative; overflow:hidden; }
.map-category-badge { position:absolute; top:8px; right:8px; padding:4px 10px; border-radius:8px; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; }
.map-category-badge.business { background:rgba(0,212,170,0.25); color:#00D4AA; border:1px solid rgba(0,212,170,0.3); }
.map-category-badge.personal { background:rgba(255,107,157,0.25); color:#FF6B9D; border:1px solid rgba(255,107,157,0.3); }
.map-category-badge.unclassified { background:rgba(255,183,77,0.25); color:#FFB74D; border:1px solid rgba(255,183,77,0.3); }
.trip-route-section { padding:14px 16px 10px; }
.trip-route-row { display:flex; align-items:flex-start; gap:10px; }
.trip-route-dots { display:flex; flex-direction:column; align-items:center; padding-top:2px; flex-shrink:0; }
.route-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.route-dot.start { background:#00E676; border:2px solid rgba(0,230,118,0.3); }
.route-dot.end { background:#FF5252; border:2px solid rgba(255,82,82,0.3); }
.route-line { width:2px; height:20px; background:rgba(255,255,255,0.15); margin:3px 0; }
.trip-route-addrs { flex:1; min-width:0; }
.trip-addr { font-size:14px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:1.2; }
.trip-addr.to { margin-top:16px; }
.trip-miles-badge { flex-shrink:0; text-align:right; padding-top:8px; }
.trip-miles-badge .mi-val { font-size:24px; font-weight:800; line-height:1; }
.trip-miles-badge .mi-unit { font-size:11px; color:var(--text3); font-weight:500; }
.trip-meta-row { display:flex; align-items:center; justify-content:space-between; padding:8px 16px 12px; font-size:12px; color:var(--text2); }
.trip-meta-left { display:flex; align-items:center; gap:12px; }
.trip-deduction { font-weight:700; color:var(--teal); }
.trip-classify { display:flex; border-top:1px solid var(--card-border); }
.classify-btn { flex:1; padding:12px; border:none; background:none; cursor:pointer; font-family:inherit; font-size:13px; font-weight:600; display:flex; align-items:center; justify-content:center; gap:6px; color:var(--text2); transition:all 0.2s; }
.classify-btn:first-child { border-right:1px solid var(--card-border); }
.classify-btn:active { background:rgba(255,255,255,0.06); }
.classify-btn.sel-biz { color:var(--blue); background:rgba(79,142,247,0.15); }
.classify-btn.sel-pers { color:var(--pink); background:rgba(255,107,157,0.15); }
.classify-btn .dot { width:8px; height:8px; border-radius:50%; border:2px solid currentColor; }
.classify-btn.sel-biz .dot, .classify-btn.sel-pers .dot { background:currentColor; }
.empty-state { text-align:center; padding:80px 20px; color:var(--text3); }
.empty-state .icon { font-size:52px; margin-bottom:16px; opacity:0.5; }
.empty-state h3 { font-size:18px; color:var(--text2); margin-bottom:8px; }
.empty-state p { font-size:14px; }

/* DASHBOARD */
.dash-header { background:#0d0d20; border-bottom:1px solid rgba(255,255,255,0.06); padding:20px; }
.dash-header h2 { font-size:28px; font-weight:700; margin-bottom:16px; }
.period-pills { display:flex; gap:8px; flex-wrap:wrap; }
.period-pill { padding:8px 16px; border-radius:20px; border:1px solid var(--card-border); background:rgba(255,255,255,0.05); color:var(--text2); font-size:13px; font-weight:500; cursor:pointer; font-family:inherit; transition:all 0.3s ease; }
.period-pill.active { background:linear-gradient(135deg,var(--blue),var(--teal)); border-color:transparent; color:white; box-shadow:0 4px 15px rgba(79,142,247,0.3); }
.dash-content { padding:16px; }
.dash-card { background:rgba(255,255,255,0.06); border:1px solid var(--card-border); border-radius:16px; padding:20px; margin-bottom:12px; box-shadow:0 4px 15px rgba(0,0,0,0.2); transition:all 0.3s ease; }
.dash-card:hover { background:rgba(255,255,255,0.08); }
.dash-card-title { font-size:12px; font-weight:700; color:var(--text2); text-transform:uppercase; letter-spacing:1px; margin-bottom:16px; }
.summary-row { display:flex; text-align:center; }
.summary-item { flex:1; padding:12px 0; }
.summary-item:not(:last-child) { border-right:1px solid var(--card-border); }
.summary-item .val { font-size:32px; font-weight:700; line-height:1; }
.summary-item .val.biz { color:var(--blue); }
.summary-item .val.pers { color:var(--pink); }
.summary-item .val.total { color:var(--text); }
.summary-item .lbl { font-size:11px; color:var(--text2); margin-top:6px; font-weight:600; }
.breakdown-bar { height:14px; border-radius:7px; overflow:hidden; display:flex; margin-bottom:14px; background:rgba(255,255,255,0.05); }
.breakdown-bar .seg { height:100%; transition:width 0.5s ease; border-radius:2px 2px 0 0; }
.breakdown-bar .seg.biz { background:linear-gradient(90deg,var(--blue),#5a9dff); }
.breakdown-bar .seg.pers { background:linear-gradient(90deg,var(--pink),#ff8fb5); }
.breakdown-bar .seg.uncl { background:linear-gradient(90deg,var(--orange),#ffc97a); }
.breakdown-legend { display:flex; gap:16px; flex-wrap:wrap; }
.legend-item { display:flex; align-items:center; gap:8px; font-size:12px; color:var(--text2); }
.legend-dot { width:10px; height:10px; border-radius:50%; }
.tax-card { background:linear-gradient(135deg,rgba(0,212,170,0.15),rgba(0,230,118,0.15)); border:1px solid rgba(0,230,118,0.3); }
.tax-card h4 { font-size:14px; font-weight:600; color:var(--green); display:flex; align-items:center; gap:8px; margin-bottom:12px; }
.tax-amount { font-size:42px; font-weight:700; color:var(--green); }
.tax-detail { font-size:12px; color:var(--text2); margin-top:6px; }
.chart-area { height:180px; display:flex; align-items:flex-end; justify-content:space-around; padding:0 4px; margin-bottom:8px; border-bottom:1px solid var(--card-border); }
.chart-col { display:flex; flex-direction:column; align-items:center; gap:2px; flex:1; max-width:40px; }
.chart-stack { display:flex; flex-direction:column-reverse; width:80%; gap:1px; }
.chart-seg { min-height:0; transition:height 0.5s ease; border-radius:2px 2px 0 0; }
.chart-seg.biz { background:linear-gradient(90deg,var(--blue),#5a9dff); }
.chart-seg.pers { background:linear-gradient(90deg,var(--pink),#ff8fb5); }
.export-btns { display:flex; gap:10px; }
.btn-exp { flex:1; padding:12px; border-radius:12px; border:1px solid var(--card-border); background:rgba(255,255,255,0.05); color:var(--text); font-size:14px; font-weight:600; cursor:pointer; font-family:inherit; display:flex; align-items:center; justify-content:center; gap:6px; transition:all 0.3s ease; }
.btn-exp:active { transform:scale(0.96); }

/* Day view */
.add-trip-form { background:rgba(255,255,255,0.06); border:1px solid var(--card-border); border-radius:16px; padding:20px; margin-bottom:16px; }
.add-trip-form h4 { font-size:15px; font-weight:600; margin-bottom:16px; }
.form-row { margin-bottom:14px; }
.form-row label { display:block; font-size:11px; color:var(--text2); margin-bottom:6px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
.form-row input,.form-row select { width:100%; padding:12px; border:1px solid var(--card-border); border-radius:10px; font-size:15px; font-family:inherit; background:rgba(255,255,255,0.05); color:var(--text); -webkit-appearance:none; transition:all 0.3s ease; }
.form-row input:focus,.form-row select:focus { outline:none; background:rgba(255,255,255,0.08); border-color:var(--blue); }
.form-row-inline { display:flex; gap:12px; }
.form-row-inline .form-row { flex:1; }
.calc-distance { display:flex; align-items:center; gap:10px; padding:10px 14px; background:rgba(79,142,247,0.15); border-radius:10px; margin-bottom:14px; font-size:13px; color:var(--blue); font-weight:500; border:1px solid rgba(79,142,247,0.3); }
.form-btns { display:flex; gap:10px; margin-top:16px; }
.form-btns button { flex:1; padding:12px; border-radius:10px; border:none; font-size:15px; font-weight:600; cursor:pointer; font-family:inherit; transition:all 0.3s ease; }
.fbtn-cancel { background:rgba(255,255,255,0.06); color:var(--text); border:1px solid var(--card-border); }
.fbtn-save { background:linear-gradient(135deg,var(--blue),var(--teal)); color:white; box-shadow:0 4px 15px rgba(79,142,247,0.3); }
.fbtn-save:active { transform:scale(0.96); }
.day-trip-row { background:rgba(255,255,255,0.06); border:1px solid var(--card-border); border-radius:14px; padding:14px; margin-bottom:10px; display:flex; align-items:center; gap:12px; transition:all 0.3s ease; }
.day-trip-row .cat-dot { width:12px; height:12px; border-radius:50%; flex-shrink:0; }
.day-trip-row .cat-dot.biz { background:var(--blue); }
.day-trip-row .cat-dot.pers { background:var(--pink); }
.day-trip-row .cat-dot.uncl { background:var(--orange); }
.day-trip-row .route-info { flex:1; }
.day-trip-row .route-info .addr { font-size:14px; font-weight:600; }
.day-trip-row .route-info .meta { font-size:12px; color:var(--text2); margin-top:2px; }
.day-trip-row .miles-col { text-align:right; }
.day-trip-row .miles-col .mi { font-size:18px; font-weight:700; }
.day-trip-row .miles-col .lbl { font-size:10px; color:var(--text2); }

/* NOTIFICATIONS */
.notif-header { background:#0d0d20; border-bottom:1px solid rgba(255,255,255,0.06); padding:20px; }
.notif-header h2 { font-size:28px; font-weight:700; }
.notif-list { padding:16px; }
.notif-card { background:rgba(255,255,255,0.06); border:1px solid var(--card-border); border-radius:16px; padding:16px; margin-bottom:10px; display:flex; align-items:flex-start; gap:12px; transition:all 0.3s ease; }
.notif-icon { width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px; flex-shrink:0; }
.notif-icon.trip { background:rgba(0,230,118,0.2); }
.notif-icon.classify { background:rgba(255,183,77,0.2); }
.notif-icon.report { background:rgba(79,142,247,0.2); }
.notif-icon.alert { background:rgba(255,82,82,0.2); }
.notif-body { flex:1; }
.notif-body h4 { font-size:14px; font-weight:600; }
.notif-body p { font-size:13px; color:var(--text2); margin-top:4px; line-height:1.4; }
.notif-body .time { font-size:11px; color:var(--text3); margin-top:6px; }
.notif-action { padding:6px 14px; border-radius:8px; border:none; background:linear-gradient(135deg,var(--blue),var(--teal)); color:white; font-size:12px; font-weight:600; cursor:pointer; font-family:inherit; margin-top:10px; transition:all 0.3s ease; }
.notif-badge { position:absolute; top:-4px; right:-4px; min-width:18px; height:18px; border-radius:9px; background:linear-gradient(135deg,var(--red),#ff7070); color:white; font-size:10px; font-weight:700; display:flex; align-items:center; justify-content:center; padding:0 4px; box-shadow:0 2px 8px rgba(255,82,82,0.3); }

/* SETTINGS */
.settings-header { background:#0d0d20; border-bottom:1px solid rgba(255,255,255,0.06); padding:16px 20px; display:flex; align-items:center; gap:12px; }
.settings-header h2 { font-size:28px; font-weight:700; }
.settings-back { background:none; border:none; font-size:24px; color:var(--blue); cursor:pointer; padding:4px; }
.settings-content { padding:16px; }
.settings-section-title { font-size:11px; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--text2); padding:12px 4px 8px; }
.settings-card { background:rgba(255,255,255,0.06); border:1px solid var(--card-border); border-radius:14px; margin-bottom:12px; overflow:hidden; }
.setting-row { display:flex; align-items:center; justify-content:space-between; padding:16px; border-bottom:1px solid var(--card-border); }
.setting-row:last-child { border-bottom:none; }
.setting-row .info h4 { font-size:15px; font-weight:500; }
.setting-row .info p { font-size:12px; color:var(--text2); margin-top:4px; }
.toggle { width:54px; height:32px; background:rgba(255,255,255,0.1); border-radius:18px; position:relative; cursor:pointer; border:1px solid var(--card-border); flex-shrink:0; transition:all 0.3s ease; }
.toggle.on { background:linear-gradient(135deg,var(--green),#00e67e); border-color:transparent; box-shadow:0 4px 12px rgba(0,230,118,0.3); }
.toggle::after { content:''; width:28px; height:28px; background:white; border-radius:50%; position:absolute; top:2px; left:2px; transition:transform 0.3s ease; box-shadow:0 2px 6px rgba(0,0,0,0.3); }
.toggle.on::after { transform:translateX(22px); }
.setting-input { padding:8px 12px; border-radius:8px; border:1px solid var(--card-border); background:rgba(255,255,255,0.05); color:var(--text); font-family:inherit; font-size:14px; text-align:center; transition:all 0.3s ease; }
.setting-input:focus { outline:none; background:rgba(255,255,255,0.08); border-color:var(--blue); }
.btn-danger { padding:8px 16px; border-radius:8px; border:none; background:rgba(255,82,82,0.15); color:var(--red); font-size:14px; font-weight:500; cursor:pointer; font-family:inherit; transition:all 0.3s ease; }
.btn-danger:hover { background:rgba(255,82,82,0.25); }
.btn-signout { padding:8px 16px; border-radius:8px; border:1px solid rgba(255,82,82,0.3); background:rgba(255,82,82,0.1); color:var(--red); font-size:14px; font-weight:600; cursor:pointer; font-family:inherit; display:flex; align-items:center; gap:6px; transition:all 0.3s ease; }
.btn-signout:hover { background:rgba(255,82,82,0.2); }

/* User profile card in settings */
.user-profile-card {
  background: linear-gradient(135deg, rgba(79,142,247,0.15), rgba(108,99,255,0.15));
  border: 1px solid rgba(79,142,247,0.3);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 16px;
}
.user-profile-avatar {
  width: 56px; height: 56px; border-radius: 50%;
  background: linear-gradient(135deg,var(--blue),var(--purple));
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; font-weight: 700; color: white;
  overflow: hidden; flex-shrink: 0;
  border: 2px solid rgba(79,142,247,0.4);
}
.user-profile-avatar img { width:100%; height:100%; object-fit:cover; }
.user-profile-info h4 { font-size:16px; font-weight:700; }
.user-profile-info p { font-size:13px; color:var(--text2); margin-top:3px; }
.user-profile-info .sync-badge { display:inline-flex; align-items:center; gap:5px; margin-top:6px; font-size:11px; color:var(--green); font-weight:500; }
.user-profile-info .sync-badge::before { content:''; width:6px; height:6px; border-radius:50%; background:var(--green); }

/* MODALS */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:300; display:none; align-items:flex-end; justify-content:center; backdrop-filter:blur(8px); }
.modal-overlay.show { display:flex; }
.modal { background:linear-gradient(135deg,rgba(255,255,255,0.1),rgba(255,255,255,0.08)); backdrop-filter:blur(20px); border:1px solid var(--card-border); border-radius:24px 24px 0 0; width:100%; max-width:500px; padding:20px; padding-bottom:calc(24px+var(--safe-bottom)); transform:translateY(100%); transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1); max-height:90vh; overflow-y:auto; }
.modal-overlay.show .modal { transform:translateY(0); }
.modal-handle { width:40px; height:5px; background:rgba(255,255,255,0.2); border-radius:3px; margin:0 auto 20px; }
.modal h3 { font-size:22px; font-weight:700; margin-bottom:20px; }
.modal-field { margin-bottom:16px; }
.modal-field label { display:block; font-size:12px; color:var(--text2); margin-bottom:8px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
.modal-field input,.modal-field textarea,.modal-field select { width:100%; padding:12px; border:1px solid var(--card-border); border-radius:12px; font-size:16px; font-family:inherit; background:rgba(255,255,255,0.05); color:var(--text); -webkit-appearance:none; transition:all 0.3s ease; }
.modal-field input:focus,.modal-field textarea:focus,.modal-field select:focus { outline:none; background:rgba(255,255,255,0.08); border-color:var(--blue); }
.modal-field textarea { resize:vertical; min-height:80px; }
.modal-btns { display:flex; gap:10px; margin-top:20px; }
.modal-btns button { flex:1; padding:14px; border-radius:12px; border:none; font-size:16px; font-weight:600; cursor:pointer; font-family:inherit; transition:all 0.3s ease; }
.mbtn-cancel { background:rgba(255,255,255,0.06); color:var(--text); border:1px solid var(--card-border); }
.mbtn-cancel:active { transform:scale(0.96); }
.mbtn-delete { background:rgba(255,82,82,0.15); color:var(--red); border:1px solid rgba(255,82,82,0.3); }
.mbtn-delete:active { transform:scale(0.96); }
.mbtn-save { background:linear-gradient(135deg,var(--blue),var(--teal)); color:white; box-shadow:0 4px 15px rgba(79,142,247,0.3); }
.mbtn-save:active { transform:scale(0.96); }
.trip-summary-card { background:rgba(255,255,255,0.04); border-radius:14px; padding:20px; margin-bottom:20px; }
.trip-summary-card .row { display:flex; justify-content:space-between; padding:8px 0; }
.trip-summary-card .row .label { font-size:13px; color:var(--text2); }
.trip-summary-card .row .value { font-size:14px; font-weight:600; }
.trip-summary-card .miles-big { font-size:48px; font-weight:700; text-align:center; color:var(--blue); margin:16px 0; }
.trip-summary-card .miles-lbl { text-align:center; font-size:13px; color:var(--text2); }
.addr-classify { background:rgba(255,255,255,0.04); border-radius:14px; padding:16px; margin-bottom:16px; }
.addr-classify h4 { font-size:15px; font-weight:600; margin-bottom:12px; }
.addr-classify .addr-row { display:flex; align-items:center; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.08); }
.addr-classify .addr-row:last-child { border-bottom:none; }
.addr-classify .addr-name { font-size:14px; font-weight:500; }
.addr-classify .addr-btns { display:flex; gap:8px; }
.addr-classify .addr-btn { padding:6px 12px; border-radius:8px; border:1px solid var(--card-border); background:rgba(255,255,255,0.05); font-size:12px; font-weight:600; cursor:pointer; font-family:inherit; color:var(--text2); transition:all 0.3s ease; }
.addr-classify .addr-btn.sel { border-color:var(--blue); color:var(--blue); background:rgba(79,142,247,0.2); }
.addr-classify .addr-btn.sel-p { border-color:var(--pink); color:var(--pink); background:rgba(255,107,157,0.2); }

/* TOAST */
.toast { position:fixed; top:calc(var(--safe-top)+70px); left:50%; transform:translateX(-50%) translateY(-100px); background:rgba(30,30,50,0.95); backdrop-filter:blur(10px); color:white; padding:14px 28px; border-radius:28px; font-size:14px; font-weight:500; z-index:400; transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1); box-shadow:0 8px 32px rgba(0,0,0,0.4); border:1px solid rgba(255,255,255,0.1); }
.toast.show { transform:translateX(-50%) translateY(0); }

/* NOTIF BANNER */
.notif-banner { position:fixed; top:calc(var(--safe-top)+60px); left:12px; right:12px; background:linear-gradient(135deg,rgba(255,255,255,0.1),rgba(255,255,255,0.08)); backdrop-filter:blur(20px); border:1px solid var(--card-border); border-radius:16px; padding:16px; box-shadow:0 8px 32px rgba(0,0,0,0.4); z-index:500; display:flex; align-items:center; gap:14px; transform:translateY(-200px); transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1); }
.notif-banner.show { transform:translateY(0); }
.notif-banner .n-icon { font-size:32px; flex-shrink:0; }
.notif-banner .n-body { flex:1; }
.notif-banner .n-body h5 { font-size:14px; font-weight:600; }
.notif-banner .n-body p { font-size:12px; color:var(--text2); margin-top:2px; }
.notif-banner .n-close { background:none; border:none; color:var(--text3); font-size:20px; cursor:pointer; padding:4px; }

::-webkit-scrollbar { width:0; }
</style>
</head>
<body>

<!-- ===== CONFIG NEEDED SCREEN ===== -->
<div id="config-screen" style="display:none;position:fixed;inset:0;background:linear-gradient(135deg,#0a0a1a 0%,#12122a 50%,#1a0a2e 100%);z-index:2000;flex-direction:column;align-items:center;justify-content:center;padding:32px 24px;text-align:center;overflow-y:auto;">
  <div style="font-size:52px;margin-bottom:20px">ðŸ”§</div>
  <div style="font-size:26px;font-weight:800;margin-bottom:10px;color:white">Firebase Setup Required</div>
  <div style="font-size:15px;color:rgba(255,255,255,0.6);margin-bottom:32px;line-height:1.6;max-width:340px">
    To enable Google Sign-In and cloud sync, you need to add your Firebase config to <code style="background:rgba(255,255,255,0.1);padding:2px 8px;border-radius:6px;font-size:13px">index.html</code>
  </div>
  <div style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:16px;padding:20px 24px;text-align:left;width:100%;max-width:400px;margin-bottom:24px">
    <div style="font-size:12px;font-weight:700;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:1px;margin-bottom:14px">Quick Steps</div>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,#4F8EF7,#6C63FF);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0">1</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.8)">Go to <strong style="color:#4F8EF7">console.firebase.google.com</strong> and create a project</div>
      </div>
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,#4F8EF7,#6C63FF);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0">2</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.8)">Enable <strong>Google Sign-In</strong> and create a <strong>Firestore Database</strong></div>
      </div>
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,#4F8EF7,#6C63FF);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0">3</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.8)">Copy your <strong>firebaseConfig</strong> and paste it into <code style="background:rgba(255,255,255,0.1);padding:1px 6px;border-radius:4px">index.html</code> where it says <code style="background:rgba(255,255,255,0.1);padding:1px 6px;border-radius:4px">YOUR_API_KEY</code></div>
      </div>
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,#4F8EF7,#6C63FF);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0">4</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.8)">Add your domain to Firebase â†’ Authentication â†’ <strong>Authorized domains</strong> (e.g. <span id="cfg-hostname" style="color:#4F8EF7;font-weight:600">your domain</span>)</div>
      </div>
    </div>
  </div>
  <a href="https://console.firebase.google.com" target="_blank" style="display:flex;align-items:center;gap:10px;width:100%;max-width:400px;padding:16px 24px;background:linear-gradient(135deg,#4F8EF7,#6C63FF);color:white;border-radius:14px;font-size:16px;font-weight:700;text-decoration:none;justify-content:center;box-shadow:0 8px 32px rgba(79,142,247,0.4)">
    ðŸ”¥ Open Firebase Console
  </a>
  <div style="margin-top:16px;font-size:12px;color:rgba(255,255,255,0.3)">See SETUP_GUIDE.md for full instructions</div>
</div>

<!-- ===== LOGIN SCREEN ===== -->
<div id="login-screen">
  <div class="login-logo">
    <svg viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>
  </div>
  <div class="login-title">MileTracker</div>
  <div class="login-sub">Smart mileage tracking for<br>business & tax deductions</div>

  <div class="login-features">
    <div class="login-feature">
      <div class="feat-icon">ðŸ›°ï¸</div>
      <div class="feat-text">
        <h4>Auto-detect trips</h4>
        <p>GPS starts recording when you drive</p>
      </div>
    </div>
    <div class="login-feature">
      <div class="feat-icon">â˜ï¸</div>
      <div class="feat-text">
        <h4>Cloud sync</h4>
        <p>Your trips sync across all devices</p>
      </div>
    </div>
    <div class="login-feature">
      <div class="feat-icon">ðŸ’°</div>
      <div class="feat-text">
        <h4>Tax deductions</h4>
        <p>IRS-ready reports & CSV export</p>
      </div>
    </div>
  </div>

  <button id="signin-btn" onclick="window._signIn()">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
      <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
      <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
      <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
    </svg>
    Sign in with Google
  </button>
  <div class="login-privacy">Your data is private and secure. Trips are stored in your personal cloud account and never shared.</div>
</div>

<!-- ===== APP SHELL ===== -->
<div id="app-shell">

<div class="toast" id="toast"></div>
<div class="notif-banner" id="notif-banner">
  <div class="n-icon" id="nb-icon"></div>
  <div class="n-body"><h5 id="nb-title"></h5><p id="nb-msg"></p></div>
  <button class="n-close" onclick="hideNotifBanner()">&times;</button>
</div>

<!-- HEADER -->
<div class="app-header">
  <div class="header-left">
    <div class="header-logo"><svg viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg></div>
    <div class="header-title">MileTracker</div>
  </div>
  <div class="header-right">
    <div class="sync-dot" id="sync-dot" title="Synced to cloud"></div>
    <div class="user-avatar" id="user-avatar" onclick="openSettings()" title="Account">?</div>
    <button class="header-btn" onclick="openSettings()" title="Settings">&#9881;</button>
  </div>
</div>

<!-- STATUS BAR -->
<div class="status-bar" id="status-bar">
  <span class="status-dot" id="gps-dot"></span>
  <span class="status-text" id="gps-text">Starting GPS...</span>
</div>

<!-- MAP OVERLAY -->
<div class="map-overlay" id="map-overlay">
  <div class="map-header">
    <div style="display:flex;align-items:center;gap:10px">
      <h3>My Trips</h3>
      <span class="map-trip-count" id="map-trip-count">0 trips</span>
    </div>
    <button class="map-close" onclick="closeMap()">&times;</button>
  </div>
  <div class="map-filter-bar" id="map-filter-bar">
    <button class="map-filter-pill active" onclick="setMapFilter('today',this)">Today</button>
    <button class="map-filter-pill" onclick="setMapFilter('week',this)">This Week</button>
    <button class="map-filter-pill" onclick="setMapFilter('month',this)">This Month</button>
    <button class="map-filter-pill" onclick="setMapFilter('all',this)">All</button>
  </div>
  <div class="map-legend">
    <span class="map-legend-item"><span class="map-legend-dot" style="background:#00D4AA"></span>Business</span>
    <span class="map-legend-item"><span class="map-legend-dot" style="background:#FF6B9D"></span>Personal</span>
    <span class="map-legend-item"><span class="map-legend-dot" style="background:#FFB74D"></span>Unclassified</span>
  </div>
  <div id="map-container"></div>
  <div class="map-trips-panel" id="map-trips-panel">
    <div class="map-trips-handle" onclick="toggleMapTripsPanel()"><div class="map-trips-handle-bar"></div></div>
    <div class="map-trips-summary" id="map-trips-summary"></div>
    <div class="map-trips-list" id="map-trips-list"></div>
  </div>
</div>

<!-- DRIVE PAGE -->
<div class="page active" id="page-drive">
  <div class="drive-hero" id="drive-hero">
    <div class="drive-circle monitoring" id="drive-circle">
      <div class="drive-circle-inner" id="drive-icon">&#x1F7E2;</div>
    </div>
    <div class="drive-label" id="drive-label">Always On</div>
    <div class="drive-sublabel" id="drive-sublabel">GPS monitoring active. Trips auto-detect when you drive.</div>
    <div class="drive-speed" id="idle-speed-wrap">
      <span class="num" id="idle-speed">0</span><span class="unit">mph</span>
    </div>
    <div class="drive-accuracy" id="idle-accuracy">GPS accuracy: --</div>
  </div>
  <div class="live-panel" id="live-panel">
    <div class="live-stats">
      <div class="live-stat"><div class="val" id="live-miles">0.0</div><div class="lbl">Miles</div></div>
      <div class="live-stat"><div class="val" id="live-duration">0m</div><div class="lbl">Duration</div></div>
    </div>
    <div class="live-speed-inline" id="live-speed">0 mph</div>
  </div>
  <div class="gps-activate-wrap" id="gps-activate">
    <button class="gps-activate-btn" onclick="activateGPS()">Tap to Activate GPS</button>
    <div style="font-size:11px;color:var(--text3);margin-top:6px;text-align:center">Some browsers need a tap to start location</div>
  </div>
  <div class="map-btn-wrap">
    <button class="map-btn" onclick="switchPage('trips',document.getElementById('nav-trips'))">&#x1F5FA; View My Trips</button>
    <button class="map-btn" onclick="openMap()" style="margin-top:8px">&#127760; Open Full Map</button>
  </div>
  <div class="quick-stats">
    <div class="quick-stat"><div class="icon">&#128188;</div><div class="val biz" id="s-biz">0 mi</div><div class="lbl">Business Miles</div></div>
    <div class="quick-stat"><div class="icon">&#128100;</div><div class="val pers" id="s-pers">0 mi</div><div class="lbl">Personal Miles</div></div>
    <div class="quick-stat"><div class="icon">$</div><div class="val ded" id="s-ded">$0.00</div><div class="lbl">Tax Deduction</div></div>
    <div class="quick-stat"><div class="icon">&#128663;</div><div class="val trips" id="s-trips">0</div><div class="lbl">Total Trips</div></div>
  </div>
  <div class="uncl-banner" id="uncl-banner"><div class="icon">&#9888;&#65039;</div><div class="info"><h4>Unclassified Trips</h4><p id="uncl-text">Tap to classify</p></div></div>
  <div class="manual-btn-wrap"><button class="manual-btn" onclick="openManualTrip()">+ Add Trip Manually</button></div>
  <div class="debug-log" id="gps-debug"></div>
</div>

<!-- TRIPS PAGE -->
<div class="page" id="page-trips">
  <div class="trips-header">
    <h2>Your Trips</h2>
    <div class="filter-row">
      <button class="filter-tab active" onclick="filterTrips('all',this)">All</button>
      <button class="filter-tab" onclick="filterTrips('business',this)">Business</button>
      <button class="filter-tab" onclick="filterTrips('personal',this)">Personal</button>
      <button class="filter-tab" onclick="filterTrips('unclassified',this)">Unclassified</button>
    </div>
  </div>
  <div class="trips-list" id="trips-list"></div>
  <div class="empty-state" id="trips-empty"><div class="icon">&#128663;</div><h3>No trips yet</h3><p>Start driving to see trips here</p></div>
</div>

<!-- DASHBOARD PAGE -->
<div class="page" id="page-dashboard">
  <div class="dash-header">
    <h2>Dashboard</h2>
    <div class="period-pills">
      <button class="period-pill" onclick="setDashPeriod('day',this)">Day</button>
      <button class="period-pill" onclick="setDashPeriod('week',this)">Week</button>
      <button class="period-pill active" onclick="setDashPeriod('month',this)">Month</button>
      <button class="period-pill" onclick="setDashPeriod('year',this)">Year</button>
    </div>
  </div>
  <div class="dash-content" id="dash-content"></div>
</div>

<!-- NOTIFICATIONS -->
<div class="page" id="page-notifs">
  <div class="notif-header"><h2>Notifications</h2></div>
  <div class="notif-list" id="notif-list"></div>
</div>

<!-- SETTINGS -->
<div class="page" id="page-settings">
  <div class="settings-header">
    <button class="settings-back" onclick="goBack()">&larr;</button>
    <h2>Settings</h2>
  </div>
  <div class="settings-content">
    <div id="user-profile-section"></div>
    <div class="settings-section-title">Tracking</div>
    <div class="settings-card">
      <div class="setting-row"><div class="info"><h4>Auto-detect trips</h4><p>Start recording when driving</p></div><button class="toggle on" id="tog-auto" onclick="toggleSetting('autoDetect')"></button></div>
      <div class="setting-row"><div class="info"><h4>Default category</h4><p>New trips default to this</p></div><select class="setting-input" id="set-defcat" onchange="updateSetting('defaultCat')" style="width:120px"><option value="unclassified">Unclassified</option><option value="business">Business</option><option value="personal">Personal</option></select></div>
      <div class="setting-row"><div class="info"><h4>Speed threshold</h4><p>Min mph to count as driving</p></div><input type="number" class="setting-input" id="set-speed" value="5" min="1" max="25" style="width:60px" onchange="updateSetting('speed')"></div>
    </div>
    <div class="settings-section-title">Notifications</div>
    <div class="settings-card">
      <div class="setting-row"><div class="info"><h4>Trip alerts</h4><p>Notify when trips saved</p></div><button class="toggle on" id="tog-tripalert" onclick="toggleSetting('tripAlerts')"></button></div>
      <div class="setting-row"><div class="info"><h4>Classification reminders</h4><p>Remind to classify trips</p></div><button class="toggle on" id="tog-classify" onclick="toggleSetting('classifyReminders')"></button></div>
      <div class="setting-row"><div class="info"><h4>Weekly summary</h4><p>Show weekly mileage summary</p></div><button class="toggle on" id="tog-weekly" onclick="toggleSetting('weeklySummary')"></button></div>
    </div>
    <div class="settings-section-title">IRS Rate</div>
    <div class="settings-card">
      <div class="setting-row"><div class="info"><h4>Business rate per mile</h4><p>2026 IRS standard mileage rate</p></div><div style="display:flex;align-items:center;gap:4px"><span>$</span><input type="number" class="setting-input" id="set-irs" value="0.70" step="0.01" min="0" style="width:70px" onchange="updateSetting('irs')"></div></div>
    </div>
    <div class="settings-section-title">Saved Addresses</div>
    <div class="settings-card" id="saved-addresses-list"></div>
    <div class="settings-section-title">Data</div>
    <div class="settings-card">
      <div class="setting-row"><div class="info"><h4>Total recorded</h4><p id="set-count">0 trips</p></div></div>
      <div class="setting-row"><div class="info"><h4>Clear all data</h4><p>Remove all trip records</p></div><button class="btn-danger" onclick="clearAllData()">Clear</button></div>
    </div>
    <div style="text-align:center;color:var(--text3);font-size:12px;padding:20px">MileTracker v4.1 Â· Cloud Sync Edition</div>
  </div>
</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <button class="nav-item active" onclick="switchPage('drive',this)" id="nav-drive">
    <svg viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg><span>Drive</span>
  </button>
  <button class="nav-item" onclick="switchPage('trips',this)" id="nav-trips">
    <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg><span>Trips</span>
  </button>
  <button class="nav-item" onclick="switchPage('dashboard',this)" id="nav-dashboard">
    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg><span>Dashboard</span>
  </button>
  <button class="nav-item" onclick="switchPage('notifs',this)" id="nav-notifs" style="position:relative">
    <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg><span>Alerts</span>
    <span class="notif-badge" id="notif-badge" style="display:none">0</span>
  </button>
</div>

<!-- MANUAL TRIP MODAL -->
<div class="modal-overlay" id="manual-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3>Add Trip</h3>
    <div class="modal-field"><label>From Address</label><input type="text" id="man-from" placeholder="e.g. 123 Main St or Home"></div>
    <div class="modal-field"><label>To Address</label><input type="text" id="man-to" placeholder="e.g. 456 Oak Ave or Office"></div>
    <div id="man-calc-dist" style="display:none" class="calc-distance"><span>&#x1F4CD;</span><span id="man-calc-text">Calculating distance...</span></div>
    <div class="modal-field"><label>Miles (auto-calculated or manual)</label><input type="number" id="man-miles" step="0.1" min="0" placeholder="Miles"></div>
    <div class="modal-field"><label>Category</label><select id="man-cat"><option value="business">Business</option><option value="personal">Personal</option><option value="unclassified">Unclassified</option></select></div>
    <div class="modal-field"><label>Date</label><input type="date" id="man-date"></div>
    <div class="modal-field"><label>Notes (optional)</label><textarea id="man-notes" placeholder="Meeting with client..."></textarea></div>
    <div class="modal-btns">
      <button class="mbtn-cancel" onclick="closeManualModal()">Cancel</button>
      <button class="mbtn-save" onclick="saveManualTrip()">Save Trip</button>
    </div>
  </div>
</div>

<!-- EDIT TRIP MODAL -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3>Edit Trip</h3>
    <div class="modal-field"><label>Trip Name</label><input type="text" id="ed-name" placeholder="Home to Office"></div>
    <div class="modal-field"><label>Category</label><select id="ed-cat"><option value="business">Business</option><option value="personal">Personal</option><option value="unclassified">Unclassified</option></select></div>
    <div class="modal-field"><label>Miles</label><input type="number" id="ed-miles" step="0.1" min="0"></div>
    <div class="modal-field"><label>Notes</label><textarea id="ed-notes" placeholder="Optional notes..."></textarea></div>
    <div class="modal-btns">
      <button class="mbtn-cancel" onclick="closeModal()">Cancel</button>
      <button class="mbtn-delete" onclick="deleteTrip()">Delete</button>
      <button class="mbtn-save" onclick="saveEditTrip()">Save</button>
    </div>
  </div>
</div>

<!-- TRIP SUMMARY MODAL -->
<div class="modal-overlay" id="summary-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3>Trip Complete!</h3>
    <div class="trip-summary-card">
      <div class="miles-big" id="sum-miles">0.0</div>
      <div class="miles-lbl">miles driven</div>
      <div class="row"><span class="label">From</span><span class="value" id="sum-from">--</span></div>
      <div class="row"><span class="label">To</span><span class="value" id="sum-to">--</span></div>
      <div class="row"><span class="label">Duration</span><span class="value" id="sum-dur">--</span></div>
      <div class="row"><span class="label">Avg Speed</span><span class="value" id="sum-speed">--</span></div>
    </div>
    <div class="addr-classify" id="sum-addr-section">
      <h4>Classify these addresses</h4>
      <div id="sum-addr-rows"></div>
    </div>
    <div class="modal-field"><label>Trip Category</label>
      <select id="sum-cat">
        <option value="business">Business</option>
        <option value="personal">Personal</option>
        <option value="unclassified">Decide Later</option>
      </select>
    </div>
    <div class="modal-btns">
      <button class="mbtn-save" onclick="saveTripSummary()" style="flex:1">Save Trip</button>
    </div>
  </div>
</div>

</div><!-- end app-shell -->

<script>
// ===================== STATE =====================
const IRS_RATE_2026 = 0.70;
let app = {
  trips: [], tracking: false, notifications: [],
  savedAddresses: {},
  settings: {
    autoDetect:true, defaultCat:'unclassified', speedThreshold:5,
    irsRate:IRS_RATE_2026, tripAlerts:true, classifyReminders:true, weeklySummary:true
  },
  dashPeriod:'month', tripFilter:'all', editId:null, lastPage:'drive'
};
let watchId=null, positions=[], trackStart=null, trackTimer=null;
let leafletMap=null, userMarker=null, trackPolyline=null;
let pendingSummaryTrip = null;

// ===================== AUTH UI =====================
function showLogin() {
  document.getElementById('login-screen').classList.add('show');
  document.getElementById('app-shell').classList.remove('show');
  // Hide config screen if shown
  const cs = document.getElementById('config-screen');
  if (cs) cs.style.display = 'none';
}
function showApp(user) {
  document.getElementById('login-screen').classList.remove('show');
  document.getElementById('app-shell').classList.add('show');
  const cs = document.getElementById('config-screen');
  if (cs) cs.style.display = 'none';
  // Set user avatar
  const av = document.getElementById('user-avatar');
  if (user.photoURL) {
    av.innerHTML = `<img src="${user.photoURL}" alt="${user.displayName}">`;
  } else {
    av.textContent = (user.displayName||user.email||'?')[0].toUpperCase();
  }
  load();
  updateHomeStats();
  updateNotifBadge();
  startAlwaysOnMonitor();
  if (!app.notifications.length) {
    addNotification('alert','Welcome to MileTracker!','Trips auto-detect when you drive. Your data syncs to the cloud.',null);
  }
}

// ===================== STORAGE (localStorage fallback + Firestore) =====================
function save() {
  try { localStorage.setItem('mt4', JSON.stringify({
    settings:app.settings, notifications:app.notifications,
    savedAddresses:app.savedAddresses
  })); } catch(e) {}
  // Sync settings/addresses to Firestore
  if (window._saveSettings) window._saveSettings();
}
function load() {
  try {
    const d = JSON.parse(localStorage.getItem('mt4'));
    if (d) {
      app.settings = {...app.settings,...(d.settings||{})};
      app.notifications = d.notifications||[];
      app.savedAddresses = d.savedAddresses||{};
    }
  } catch(e) {}
}

// ===================== SYNC DOT =====================
function setSyncing(syncing) {
  const dot = document.getElementById('sync-dot');
  if (!dot) return;
  dot.className = 'sync-dot' + (syncing ? ' syncing' : '');
  dot.title = syncing ? 'Syncing...' : 'Synced to cloud';
}

// ===================== NAV =====================
function switchPage(p, btn) {
  if (p!=='settings') app.lastPage=p;
  document.querySelectorAll('.page').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
  document.getElementById('page-'+p).classList.add('active');
  if (btn) btn.classList.add('active');
  else { const n=document.getElementById('nav-'+p); if(n) n.classList.add('active'); }
  if (p==='trips') renderTrips();
  if (p==='dashboard') renderDashboard();
  if (p==='settings') renderSettings();
  if (p==='notifs') { renderNotifs(); updateNotifBadge(); }
}
function openSettings() { switchPage('settings'); }
function goBack() { switchPage(app.lastPage||'drive'); }
function showToast(msg) {
  const t=document.getElementById('toast'); t.textContent=msg;
  t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500);
}

// ===================== MAP =====================
let mapFilter = 'today';
let mapTripMarkers = [];
let mapTripLines = [];
let lastMonitorPos = null;

function openMap() {
  document.getElementById('map-overlay').classList.add('show');
  setTimeout(()=>{
    if (!leafletMap) {
      const defaultLat = lastMonitorPos ? lastMonitorPos.lat : 49.8951;
      const defaultLng = lastMonitorPos ? lastMonitorPos.lng : -97.1384;
      leafletMap = L.map('map-container', { zoomControl: false }).setView([defaultLat, defaultLng], 13);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{
        attribution:'&copy; OpenStreetMap &copy; CartoDB', maxZoom:19
      }).addTo(leafletMap);
      L.control.zoom({ position: 'topright' }).addTo(leafletMap);
    }
    leafletMap.invalidateSize();
    if (lastMonitorPos) {
      leafletMap.setView([lastMonitorPos.lat, lastMonitorPos.lng], 13);
      if (userMarker) userMarker.setLatLng([lastMonitorPos.lat, lastMonitorPos.lng]);
      else userMarker = L.circleMarker([lastMonitorPos.lat, lastMonitorPos.lng],{radius:8,fillColor:'#4F8EF7',fillOpacity:1,color:'white',weight:3}).addTo(leafletMap);
    }
    renderMapTrips();
  },150);
}
function closeMap() {
  document.getElementById('map-overlay').classList.remove('show');
  clearMapTripMarkers();
}
function setMapFilter(filter, btn) {
  mapFilter = filter;
  document.querySelectorAll('.map-filter-pill').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  renderMapTrips();
}
function getMapFilteredTrips() {
  const now = new Date();
  if (mapFilter==='today') return app.trips.filter(t=>new Date(t.date).toDateString()===now.toDateString());
  if (mapFilter==='week') { const w=new Date(now); w.setDate(w.getDate()-7); return app.trips.filter(t=>new Date(t.date)>=w); }
  if (mapFilter==='month') return app.trips.filter(t=>{const d=new Date(t.date);return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();});
  return [...app.trips];
}
function clearMapTripMarkers() {
  mapTripMarkers.forEach(m=>{if(leafletMap)leafletMap.removeLayer(m);});
  mapTripLines.forEach(l=>{if(leafletMap)leafletMap.removeLayer(l);});
  mapTripMarkers=[];mapTripLines=[];
}
function getCatColor(cat) { return cat==='business'?'#00D4AA':cat==='personal'?'#FF6B9D':'#FFB74D'; }
function renderMapTrips() {
  clearMapTripMarkers();
  const trips = getMapFilteredTrips();
  const bizMiles=trips.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0);
  const persMiles=trips.filter(t=>t.category==='personal').reduce((s,t)=>s+t.miles,0);
  const totalMiles=trips.reduce((s,t)=>s+t.miles,0);
  document.getElementById('map-trip-count').textContent=trips.length+' trip'+(trips.length!==1?'s':'');
  document.getElementById('map-trips-summary').innerHTML=`
    <div class="map-sum-card"><div class="val" style="color:#00D4AA">${bizMiles.toFixed(1)}</div><div class="lbl">Business mi</div></div>
    <div class="map-sum-card"><div class="val" style="color:#FF6B9D">${persMiles.toFixed(1)}</div><div class="lbl">Personal mi</div></div>
    <div class="map-sum-card"><div class="val">${totalMiles.toFixed(1)}</div><div class="lbl">Total mi</div></div>
    <div class="map-sum-card"><div class="val" style="color:var(--blue)">${trips.length}</div><div class="lbl">Trips</div></div>`;
  const listEl=document.getElementById('map-trips-list');
  if(!trips.length){listEl.innerHTML='<div style="text-align:center;padding:20px;color:#999;font-size:14px">No trips for this period</div>';return;}
  listEl.innerHTML=trips.map((t,i)=>{
    const time=new Date(t.date).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
    const dur=t.duration?Math.round(t.duration/60000):0;
    return `<div class="map-trip-item" id="map-trip-${i}" onclick="focusMapTrip(${i})">
      <div class="map-trip-dot ${t.category}"></div>
      <div class="map-trip-info"><div class="route">${esc(t.startName||'Start')} &rarr; ${esc(t.endName||'Dest')}</div><div class="meta">${time} &middot; ${t.category} &middot; ${dur}min</div></div>
      <div class="map-trip-miles"><div class="mi">${t.miles.toFixed(1)}</div><div class="unit">mi</div></div>
    </div>`;
  }).join('');
  const bounds=[];
  trips.forEach((t,i)=>{
    const color=getCatColor(t.category);
    if(t.startCoord){const m=L.circleMarker([t.startCoord.lat,t.startCoord.lng],{radius:6,fillColor:color,fillOpacity:0.8,color:'white',weight:2}).addTo(leafletMap);m.bindPopup(`<b>Start:</b> ${esc(t.startName||'Unknown')}<br><b>${t.category}</b> - ${t.miles.toFixed(1)} mi`);mapTripMarkers.push(m);bounds.push([t.startCoord.lat,t.startCoord.lng]);}
    if(t.endCoord){const m=L.circleMarker([t.endCoord.lat,t.endCoord.lng],{radius:9,fillColor:color,fillOpacity:1,color:'white',weight:3}).addTo(leafletMap);m.bindPopup(`<b>Dest:</b> ${esc(t.endName||'Unknown')}<br><b>${t.category}</b> - ${t.miles.toFixed(1)} mi`);mapTripMarkers.push(m);bounds.push([t.endCoord.lat,t.endCoord.lng]);}
    if(t.startCoord&&t.endCoord){const l=L.polyline([[t.startCoord.lat,t.startCoord.lng],[t.endCoord.lat,t.endCoord.lng]],{color,weight:4,opacity:0.8,dashArray:'8,5'}).addTo(leafletMap);mapTripLines.push(l);}
  });
  if(bounds.length>1)leafletMap.fitBounds(bounds,{padding:[40,40],maxZoom:13,animate:true});
  else if(bounds.length===1)leafletMap.setView(bounds[0],13);
  else if(lastMonitorPos)leafletMap.setView([lastMonitorPos.lat,lastMonitorPos.lng],13);
}
function focusMapTrip(index) {
  const trips=getMapFilteredTrips();const t=trips[index];if(!t)return;
  document.querySelectorAll('.map-trip-item').forEach(el=>el.classList.remove('selected'));
  const card=document.getElementById('map-trip-'+index);if(card)card.classList.add('selected');
  if(t.endCoord)leafletMap.flyTo([t.endCoord.lat,t.endCoord.lng],15,{duration:0.8});
  else if(t.startCoord)leafletMap.flyTo([t.startCoord.lat,t.startCoord.lng],15,{duration:0.8});
}
function toggleMapTripsPanel(){document.getElementById('map-trips-panel').classList.toggle('collapsed');}
function updateMapPosition(lat,lng){
  if(!leafletMap)return;
  if(userMarker)userMarker.setLatLng([lat,lng]);
  else userMarker=L.circleMarker([lat,lng],{radius:8,fillColor:'#4F8EF7',fillOpacity:1,color:'white',weight:3}).addTo(leafletMap);
  if(app.tracking&&trackPolyline)trackPolyline.addLatLng([lat,lng]);
}

// ===================== NOTIFICATIONS =====================
function addNotification(type,title,message,action){
  const n={id:Date.now().toString(),type,title,message,action:action||null,time:new Date().toISOString(),read:false};
  app.notifications.unshift(n);
  if(app.notifications.length>50)app.notifications=app.notifications.slice(0,50);
  save();updateNotifBadge();showNotifBanner(type,title,message);
}
function showNotifBanner(type,title,message){
  const icons={trip:'&#x1F697;',classify:'&#9888;&#65039;',report:'&#128202;',alert:'&#128276;'};
  document.getElementById('nb-icon').innerHTML=icons[type]||'&#128276;';
  document.getElementById('nb-title').textContent=title;
  document.getElementById('nb-msg').textContent=message;
  const b=document.getElementById('notif-banner');
  b.classList.add('show');setTimeout(()=>b.classList.remove('show'),5000);
}
function hideNotifBanner(){document.getElementById('notif-banner').classList.remove('show');}
function updateNotifBadge(){
  const u=app.notifications.filter(n=>!n.read).length;
  const b=document.getElementById('notif-badge');
  if(u>0){b.style.display='flex';b.textContent=u>9?'9+':u;}else{b.style.display='none';}
}
function renderNotifs(){
  app.notifications.forEach(n=>n.read=true);save();
  const list=document.getElementById('notif-list');
  if(!app.notifications.length){list.innerHTML='<div class="empty-state"><div class="icon">&#128276;</div><h3>No notifications</h3><p>Trip alerts will appear here</p></div>';return;}
  list.innerHTML=app.notifications.map(n=>{
    const icons={trip:'&#x1F697;',classify:'&#9888;&#65039;',report:'&#128202;',alert:'&#128276;'};
    const ago=timeAgo(new Date(n.time));
    let ab='';
    if(n.action==='classify')ab=`<button class="notif-action" onclick="switchPage('trips')">Classify Now</button>`;
    else if(n.action==='dashboard')ab=`<button class="notif-action" onclick="switchPage('dashboard')">View Dashboard</button>`;
    return `<div class="notif-card"><div class="notif-icon ${n.type}">${icons[n.type]||'&#128276;'}</div><div class="notif-body"><h4>${esc(n.title)}</h4><p>${esc(n.message)}</p><div class="time">${ago}</div>${ab}</div></div>`;
  }).join('');
}
function timeAgo(d){const s=Math.floor((Date.now()-d.getTime())/1000);if(s<60)return'Just now';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';}

// ===================== SAVED ADDRESSES =====================
function normalizeAddr(addr){return(addr||'').toLowerCase().trim().replace(/[^a-z0-9 ]/g,'');}
function getAddrCategory(addr){const key=normalizeAddr(addr);return app.savedAddresses[key]?app.savedAddresses[key].category:null;}
function saveAddrCategory(addr,category){
  const key=normalizeAddr(addr);if(!key)return;
  if(!app.savedAddresses[key])app.savedAddresses[key]={name:addr,category,count:1};
  else{app.savedAddresses[key].category=category;app.savedAddresses[key].count++;}
  save();
}
function autoClassifyTrip(trip){return getAddrCategory(trip.endName)||getAddrCategory(trip.startName)||null;}

// ===================== DISTANCE =====================
let calcTimeout=null;
function setupDistanceCalc(){
  const fromEl=document.getElementById('man-from');const toEl=document.getElementById('man-to');
  const handler=()=>{clearTimeout(calcTimeout);calcTimeout=setTimeout(()=>calcDistanceBetween(fromEl.value,toEl.value),800);};
  fromEl.addEventListener('input',handler);toEl.addEventListener('input',handler);
}
function calcDistanceBetween(from,to){
  if(!from||!to||from.length<3||to.length<3){document.getElementById('man-calc-dist').style.display='none';return;}
  document.getElementById('man-calc-dist').style.display='flex';
  document.getElementById('man-calc-text').textContent='Calculating distance...';
  Promise.all([geocodeAddress(from),geocodeAddress(to)]).then(([fc,tc])=>{
    if(fc&&tc){const dist=Math.round(haversine(fc.lat,fc.lon,tc.lat,tc.lon)*1.3*10)/10;document.getElementById('man-calc-text').textContent=`Estimated: ${dist} miles`;document.getElementById('man-miles').value=dist;}
    else document.getElementById('man-calc-text').textContent='Could not find address. Enter miles manually.';
  }).catch(()=>document.getElementById('man-calc-text').textContent='Distance lookup failed.');
}
function geocodeAddress(addr){
  return fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}&limit=1`)
    .then(r=>r.json()).then(d=>d.length?{lat:parseFloat(d[0].lat),lon:parseFloat(d[0].lon)}:null).catch(()=>null);
}

// ===================== GPS =====================
function onPos(p){
  const{latitude,longitude,speed,accuracy}=p.coords;const now=Date.now();
  if(accuracy<150)positions.push({lat:latitude,lng:longitude,time:now,speed,accuracy});
  const dist=calcDistance();
  document.getElementById('live-miles').textContent=dist<1?dist.toFixed(2):dist.toFixed(1);
}
function calcDistance(){if(positions.length<2)return 0;let t=0;for(let i=1;i<positions.length;i++)t+=haversine(positions[i-1].lat,positions[i-1].lng,positions[i].lat,positions[i].lng);return t;}
function haversine(lat1,lon1,lat2,lon2){const R=3959,dLat=rad(lat2-lat1),dLon=rad(lon2-lon1);const a=Math.sin(dLat/2)**2+Math.cos(rad(lat1))*Math.cos(rad(lat2))*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}
function rad(d){return d*Math.PI/180;}
function updateDuration(){if(!trackStart)return;const e=Date.now()-trackStart;const h=Math.floor(e/3600000),m=Math.floor((e%3600000)/60000);document.getElementById('live-duration').textContent=h>0?`${h}h${m}m`:`${m}m`;}
function reverseGeocode(lat,lng,cb){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
    .then(r=>r.json()).then(d=>{const a=d.address||{};const parts=[];if(a.house_number&&a.road)parts.push(a.house_number+' '+a.road);else if(a.road)parts.push(a.road);else if(a.building||a.amenity)parts.push(a.building||a.amenity);if(a.suburb||a.neighbourhood)parts.push(a.suburb||a.neighbourhood);if(a.city||a.town||a.village)parts.push(a.city||a.town||a.village);cb(parts.join(', ')||'Unknown Location');}).catch(()=>cb('Unknown Location'));
}
function updateHomeStats(){
  const now=new Date();
  const mTrips=app.trips.filter(t=>{const d=new Date(t.date);return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();});
  const biz=mTrips.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0);
  const pers=mTrips.filter(t=>t.category==='personal').reduce((s,t)=>s+t.miles,0);
  document.getElementById('s-biz').textContent=biz.toFixed(1)+' mi';
  document.getElementById('s-pers').textContent=pers.toFixed(1)+' mi';
  document.getElementById('s-ded').textContent='$'+(biz*app.settings.irsRate).toFixed(2);
  document.getElementById('s-trips').textContent=mTrips.length;
  const uncl=app.trips.filter(t=>t.category==='unclassified').length;
  const banner=document.getElementById('uncl-banner');
  if(uncl>0){banner.classList.add('show');document.getElementById('uncl-text').textContent=`${uncl} trip${uncl!==1?'s':''} to classify.`;}
  else{banner.classList.remove('show');}
}

// ===================== TRIPS =====================
function filterTrips(f,btn){
  app.tripFilter=f;
  document.querySelectorAll('.filter-tab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  renderTrips();
}
function renderTrips(){
  let trips=[...app.trips];
  if(app.tripFilter!=='all')trips=trips.filter(t=>t.category===app.tripFilter);
  const list=document.getElementById('trips-list');const empty=document.getElementById('trips-empty');
  if(!trips.length){list.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  const groups={};
  trips.forEach(t=>{const d=new Date(t.date);const key=d.toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'});if(!groups[key])groups[key]=[];groups[key].push(t);});
  let html='';
  for(const[date,dayTrips]of Object.entries(groups)){
    const dayTotal=dayTrips.reduce((s,x)=>s+x.miles,0);
    html+=`<div class="trip-date-header">${date} <span style="float:right;color:var(--text3);font-weight:400">${dayTrips.length} trip${dayTrips.length!==1?'s':''} &middot; ${dayTotal.toFixed(1)} mi</span></div>`;
    dayTrips.forEach(t=>{
      const d=new Date(t.date);const timeStr=d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
      const dur=t.duration?Math.round(t.duration/60000):0;
      const fromAddr=t.startName||'Start';const toAddr=t.endName||'Destination';
      const deduction=t.category==='business'?(t.miles*app.settings.irsRate).toFixed(2):'0.00';
      const bizSel=t.category==='business'?' sel-biz':'';const persSel=t.category==='personal'?' sel-pers':'';
      const catLabel=t.category==='business'?'Business':t.category==='personal'?'Personal':'Classify';
      const catColorSolid=t.category==='business'?'#00D4AA':t.category==='personal'?'#FF6B9D':'#FFB74D';
      const catColorAlpha=t.category==='business'?'rgba(0,212,170,':'rgba(255,107,157,';
      const seed=(t.id?parseInt(t.id)%100:50)/100;const curveY=30+seed*40;
      const miniMapHtml=`<div class="trip-mini-map" style="background:linear-gradient(135deg,${catColorAlpha}0.06) 0%,rgba(10,10,26,0.95) 100%)">
        <svg width="100%" height="100%" viewBox="0 0 400 100" preserveAspectRatio="none" style="position:absolute;inset:0">
          <defs><linearGradient id="rg${t.id}" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#00E676;stop-opacity:0.6"/><stop offset="100%" style="stop-color:${catColorSolid};stop-opacity:0.6"/></linearGradient></defs>
          <path d="M 30 70 Q 120 ${curveY} 200 50 Q 280 ${100-curveY} 370 30" fill="none" stroke="url(#rg${t.id})" stroke-width="2.5" stroke-dasharray="6,4" opacity="0.7"/>
          <circle cx="30" cy="70" r="5" fill="#00E676" opacity="0.9"/>
          <circle cx="370" cy="30" r="5" fill="#FF5252" opacity="0.9"/>
        </svg>
        <div style="position:absolute;bottom:8px;left:12px;font-size:10px;color:var(--text3);font-weight:500">${t.miles.toFixed(1)} miles</div>
        <div class="map-category-badge ${t.category}">${catLabel}</div>
      </div>`;
      html+=`<div class="trip-card" onclick="editTrip('${t.id}')">
        ${miniMapHtml}
        <div class="trip-route-section">
          <div class="trip-route-row">
            <div class="trip-route-dots"><div class="route-dot start"></div><div class="route-line"></div><div class="route-dot end"></div></div>
            <div class="trip-route-addrs"><div class="trip-addr from">${esc(fromAddr)}</div><div class="trip-addr to">${esc(toAddr)}</div></div>
            <div class="trip-miles-badge"><div class="mi-val">${t.miles.toFixed(1)}</div><div class="mi-unit">miles</div></div>
          </div>
        </div>
        <div class="trip-meta-row">
          <div class="trip-meta-left">
            <span>${timeStr}</span><span>${dur}min</span>
            ${t.category==='business'?`<span class="trip-deduction">+$${deduction}</span>`:''}
          </div>
        </div>
        <div class="trip-classify" onclick="event.stopPropagation()">
          <button class="classify-btn${bizSel}" onclick="setCat('${t.id}','business')"><span class="dot"></span> Business</button>
          <button class="classify-btn${persSel}" onclick="setCat('${t.id}','personal')"><span class="dot"></span> Personal</button>
        </div>
      </div>`;
    });
  }
  list.innerHTML=html;
}
function setCat(id,cat){
  const t=app.trips.find(x=>x.id===id);if(!t)return;
  t.category=cat;
  setSyncing(true);
  if(window._saveTrip){window._saveTrip(t).then(()=>setSyncing(false));}
  save();renderTrips();updateHomeStats();
}
function editTrip(id){
  const t=app.trips.find(x=>x.id===id);if(!t)return;
  app.editId=id;
  document.getElementById('ed-name').value=t.name||`${t.startName||'Start'} \u2192 ${t.endName||'Destination'}`;
  document.getElementById('ed-cat').value=t.category;
  document.getElementById('ed-miles').value=t.miles;
  document.getElementById('ed-notes').value=t.notes||'';
  document.getElementById('edit-modal').classList.add('show');
}
function closeModal(){document.getElementById('edit-modal').classList.remove('show');}
function openManualTrip(){
  document.getElementById('man-from').value='';document.getElementById('man-to').value='';
  document.getElementById('man-miles').value='';
  document.getElementById('man-cat').value=app.settings.defaultCat||'business';
  document.getElementById('man-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('man-notes').value='';
  document.getElementById('man-calc-dist').style.display='none';
  document.getElementById('manual-modal').classList.add('show');
}
function closeManualModal(){document.getElementById('manual-modal').classList.remove('show');}
function saveManualTrip(){
  const miles=parseFloat(document.getElementById('man-miles').value);
  if(!miles||miles<=0){showToast('Please enter miles');return;}
  const from=document.getElementById('man-from').value||'Start';
  const to=document.getElementById('man-to').value||'Destination';
  const dateVal=document.getElementById('man-date').value;
  const d=dateVal?new Date(dateVal+'T12:00:00'):new Date();
  const dur=Math.round(miles*2.5*60000);
  let cat=document.getElementById('man-cat').value;
  const savedCat=getAddrCategory(to)||getAddrCategory(from);
  if(savedCat&&cat==='unclassified')cat=savedCat;
  const trip={id:Date.now().toString(),category:cat,miles,date:d.toISOString(),duration:dur,startTime:d.toISOString(),endTime:new Date(d.getTime()+dur).toISOString(),startName:from,endName:to,name:'',notes:document.getElementById('man-notes').value,startCoord:null,endCoord:null};
  app.trips.unshift(trip);
  setSyncing(true);
  if(window._saveTrip)window._saveTrip(trip).then(()=>setSyncing(false));
  save();closeManualModal();updateHomeStats();
  showToast(`Trip added: ${miles} miles`);
  if(app.settings.tripAlerts)addNotification('trip','Trip Added',`${from} \u2192 ${to}: ${miles} miles`,null);
}
function saveEditTrip(){
  const t=app.trips.find(x=>x.id===app.editId);if(!t)return;
  t.name=document.getElementById('ed-name').value;t.category=document.getElementById('ed-cat').value;
  t.miles=parseFloat(document.getElementById('ed-miles').value)||t.miles;t.notes=document.getElementById('ed-notes').value;
  setSyncing(true);
  if(window._saveTrip)window._saveTrip(t).then(()=>setSyncing(false));
  save();closeModal();renderTrips();updateHomeStats();showToast('Trip updated');
}
function deleteTrip(){
  if(!confirm('Delete this trip?'))return;
  const id=app.editId;
  app.trips=app.trips.filter(x=>x.id!==id);
  setSyncing(true);
  if(window._deleteTrip)window._deleteTrip(id).then(()=>setSyncing(false));
  save();closeModal();renderTrips();updateHomeStats();showToast('Trip deleted');
}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}

// ===================== DASHBOARD =====================
function setDashPeriod(p,btn){
  app.dashPeriod=p;document.querySelectorAll('.period-pill').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');renderDashboard();
}
function renderDashboard(){
  const now=new Date();const dc=document.getElementById('dash-content');let filtered=[];
  if(app.dashPeriod==='day'){filtered=app.trips.filter(t=>new Date(t.date).toDateString()===now.toDateString());renderDayView(dc,filtered,now);return;}
  else if(app.dashPeriod==='week'){const wa=new Date(now);wa.setDate(wa.getDate()-7);filtered=app.trips.filter(t=>new Date(t.date)>=wa);}
  else if(app.dashPeriod==='month')filtered=app.trips.filter(t=>{const d=new Date(t.date);return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();});
  else filtered=app.trips.filter(t=>new Date(t.date).getFullYear()===now.getFullYear());
  const biz=filtered.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0);
  const pers=filtered.filter(t=>t.category==='personal').reduce((s,t)=>s+t.miles,0);
  const uncl=filtered.filter(t=>t.category==='unclassified').reduce((s,t)=>s+t.miles,0);
  const total=biz+pers+uncl;
  const periodLabel=app.dashPeriod==='week'?'This Week':app.dashPeriod==='month'?now.toLocaleDateString('en-US',{month:'long',year:'numeric'}):'Year '+now.getFullYear();
  let html=`<div class="dash-card"><div class="dash-card-title">${periodLabel} Summary</div><div class="summary-row"><div class="summary-item"><div class="val biz">${Math.round(biz)}</div><div class="lbl">Business mi</div></div><div class="summary-item"><div class="val pers">${Math.round(pers)}</div><div class="lbl">Personal mi</div></div><div class="summary-item"><div class="val total">${Math.round(total)}</div><div class="lbl">Total mi</div></div></div></div>`;
  html+=`<div class="dash-card"><div class="dash-card-title">Breakdown</div><div class="breakdown-bar">${total>0?`<div class="seg biz" style="width:${(biz/total*100).toFixed(0)}%"></div><div class="seg pers" style="width:${(pers/total*100).toFixed(0)}%"></div><div class="seg uncl" style="width:${(uncl/total*100).toFixed(0)}%"></div>`:'<div class="seg" style="width:100%;background:var(--bg)"></div>'}</div><div class="breakdown-legend">${total>0?`<div class="legend-item"><span class="legend-dot" style="background:var(--blue)"></span>Business ${(biz/total*100).toFixed(0)}%</div><div class="legend-item"><span class="legend-dot" style="background:var(--purple)"></span>Personal ${(pers/total*100).toFixed(0)}%</div>`:'<div class="legend-item" style="color:var(--text3)">No data</div>'}</div></div>`;
  html+=`<div class="dash-card tax-card"><h4>&#x1F4B0; Estimated Tax Deduction</h4><div class="tax-amount">$${(biz*app.settings.irsRate).toFixed(2)}</div><div class="tax-detail">${biz.toFixed(1)} business miles at $${app.settings.irsRate.toFixed(2)}/mile</div></div>`;
  // Top destinations
  const destCounts={};
  filtered.forEach(t=>{const dest=t.endName||'Unknown';if(!destCounts[dest])destCounts[dest]={count:0,miles:0,cat:t.category};destCounts[dest].count++;destCounts[dest].miles+=t.miles;});
  const topDests=Object.entries(destCounts).sort((a,b)=>b[1].count-a[1].count).slice(0,5);
  if(topDests.length){html+=`<div class="dash-card"><div class="dash-card-title">Top Destinations</div>`;topDests.forEach(([dest,info])=>{const cc=info.cat==='business'?'var(--blue)':info.cat==='personal'?'var(--purple)':'var(--orange)';html+=`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--card-border)"><div style="width:8px;height:8px;border-radius:50%;background:${cc};flex-shrink:0"></div><div style="flex:1"><div style="font-size:14px;font-weight:500">${esc(dest)}</div><div style="font-size:11px;color:var(--text2)">${info.count} trips &middot; ${info.miles.toFixed(1)} mi</div></div></div>`;});html+=`</div>`;}
  html+=`<div class="dash-card"><div class="dash-card-title">${app.dashPeriod==='year'?'Monthly Breakdown':'Mileage Chart'}</div><div class="chart-area" id="chart-area"></div><div style="display:flex;justify-content:space-around;margin-top:4px" id="chart-xlabels"></div><div style="display:flex;justify-content:center;gap:16px;margin-top:10px;font-size:12px;color:var(--text2)"><span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--blue);margin-right:4px"></span>Business</span><span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--purple);margin-right:4px"></span>Personal</span></div></div>`;
  html+=`<div class="dash-card"><div class="dash-card-title">Export Report</div><div class="export-btns"><button class="btn-exp" onclick="exportCSV()">&#128196; CSV</button><button class="btn-exp" onclick="exportPDF()">&#128462; PDF</button></div></div>`;
  dc.innerHTML=html;renderChart(filtered);
}
function renderDayView(dc,trips,date){
  const biz=trips.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0);
  const pers=trips.filter(t=>t.category==='personal').reduce((s,t)=>s+t.miles,0);
  const total=biz+pers+trips.filter(t=>t.category==='unclassified').reduce((s,t)=>s+t.miles,0);
  let html=`<div class="dash-card"><div class="dash-card-title">${date.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'})}</div><div class="summary-row"><div class="summary-item"><div class="val biz">${biz.toFixed(1)}</div><div class="lbl">Business</div></div><div class="summary-item"><div class="val pers">${pers.toFixed(1)}</div><div class="lbl">Personal</div></div><div class="summary-item"><div class="val total">${total.toFixed(1)}</div><div class="lbl">Total mi</div></div></div></div>`;
  html+=`<div class="add-trip-form"><h4>&#x2795; Quick Add Trip</h4><div class="form-row"><label>From</label><input type="text" id="day-from" placeholder="From address"></div><div class="form-row"><label>To</label><input type="text" id="day-to" placeholder="To address"></div><div id="day-calc-dist" style="display:none" class="calc-distance"><span>&#x1F4CD;</span><span id="day-calc-text">Calculating...</span></div><div class="form-row-inline"><div class="form-row"><label>Miles</label><input type="number" id="day-miles" step="0.1" placeholder="Auto or manual"></div><div class="form-row"><label>Category</label><select id="day-cat"><option value="business">Business</option><option value="personal">Personal</option></select></div></div><div class="form-btns"><button class="fbtn-save" onclick="addDayTrip()">Add Trip</button></div></div>`;
  if(trips.length){html+=`<div class="dash-card-title" style="padding:8px 4px">Today's Trips (${trips.length})</div>`;trips.forEach(t=>{const timeStr=new Date(t.date).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});const cc=t.category==='business'?'biz':t.category==='personal'?'pers':'uncl';html+=`<div class="day-trip-row"><div class="cat-dot ${cc}"></div><div class="route-info"><div class="addr">${esc(t.startName||'Start')} &rarr; ${esc(t.endName||'Dest')}</div><div class="meta">${timeStr} &middot; ${t.category} &middot; ${t.duration?Math.round(t.duration/60000)+'min':'--'}</div></div><div class="miles-col"><div class="mi">${t.miles.toFixed(1)}</div><div class="lbl">miles</div></div></div>`;});}
  else html+=`<div class="empty-state" style="padding:30px"><div class="icon">&#128663;</div><h3>No trips today</h3><p>Add a trip above or start driving</p></div>`;
  dc.innerHTML=html;
  setTimeout(()=>{const fe=document.getElementById('day-from');const te=document.getElementById('day-to');if(fe&&te){let dt=null;const h=()=>{clearTimeout(dt);dt=setTimeout(()=>calcDayDist(fe.value,te.value),800);};fe.addEventListener('input',h);te.addEventListener('input',h);}},100);
}
function calcDayDist(from,to){
  if(!from||!to||from.length<3||to.length<3){document.getElementById('day-calc-dist').style.display='none';return;}
  document.getElementById('day-calc-dist').style.display='flex';document.getElementById('day-calc-text').textContent='Calculating distance...';
  Promise.all([geocodeAddress(from),geocodeAddress(to)]).then(([fc,tc])=>{if(fc&&tc){const dist=Math.round(haversine(fc.lat,fc.lon,tc.lat,tc.lon)*1.3*10)/10;document.getElementById('day-calc-text').textContent=`Estimated: ${dist} miles`;document.getElementById('day-miles').value=dist;}else document.getElementById('day-calc-text').textContent='Address not found.';}).catch(()=>document.getElementById('day-calc-text').textContent='Lookup failed.');
}
function addDayTrip(){
  const miles=parseFloat(document.getElementById('day-miles').value);if(!miles||miles<=0){showToast('Enter miles');return;}
  const from=document.getElementById('day-from').value||'Start';const to=document.getElementById('day-to').value||'Destination';
  let cat=document.getElementById('day-cat').value;const savedCat=getAddrCategory(to)||getAddrCategory(from);if(savedCat)cat=savedCat;
  const now=new Date();
  const trip={id:Date.now().toString(),category:cat,miles,date:now.toISOString(),duration:Math.round(miles*2.5*60000),startTime:now.toISOString(),endTime:new Date(now.getTime()+Math.round(miles*2.5*60000)).toISOString(),startName:from,endName:to,name:'',notes:'',startCoord:null,endCoord:null};
  app.trips.unshift(trip);
  setSyncing(true);if(window._saveTrip)window._saveTrip(trip).then(()=>setSyncing(false));
  save();updateHomeStats();showToast(`Added: ${from} \u2192 ${to} (${miles} mi)`);renderDashboard();
}
function renderChart(trips){
  const chart=document.getElementById('chart-area');const labels=document.getElementById('chart-xlabels');if(!chart)return;
  let buckets=[];
  if(app.dashPeriod==='week'){const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const dt=trips.filter(t=>new Date(t.date).toDateString()===d.toDateString());buckets.push({label:days[d.getDay()],biz:dt.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0),pers:dt.filter(t=>t.category!=='business').reduce((s,t)=>s+t.miles,0)});}}
  else if(app.dashPeriod==='month'){const now=new Date();const weeks=Math.ceil(new Date(now.getFullYear(),now.getMonth()+1,0).getDate()/7);for(let w=0;w<weeks;w++){const wt=trips.filter(t=>Math.floor((new Date(t.date).getDate()-1)/7)===w);buckets.push({label:'W'+(w+1),biz:wt.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0),pers:wt.filter(t=>t.category!=='business').reduce((s,t)=>s+t.miles,0)});}}
  else{const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];for(let m=0;m<12;m++){const mt=trips.filter(t=>new Date(t.date).getMonth()===m);buckets.push({label:months[m],biz:mt.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0),pers:mt.filter(t=>t.category!=='business').reduce((s,t)=>s+t.miles,0)});}}
  const maxH=150,maxVal=Math.max(...buckets.map(b=>b.biz+b.pers),1);
  chart.innerHTML=buckets.map(b=>`<div class="chart-col"><div class="chart-stack"><div class="chart-seg pers" style="height:${(b.pers/maxVal)*maxH}px"></div><div class="chart-seg biz" style="height:${(b.biz/maxVal)*maxH}px"></div></div></div>`).join('');
  labels.innerHTML=buckets.map(b=>`<span style="flex:1;text-align:center;font-size:9px;color:var(--text3)">${b.label}</span>`).join('');
}

// ===================== EXPORT =====================
function exportCSV(){
  if(!app.trips.length){showToast('No trips');return;}
  const h='Date,Start Time,End Time,Category,Miles,Duration (min),From,To,Notes';
  const rows=app.trips.map(t=>{const d=new Date(t.date);return[d.toLocaleDateString(),t.startTime?new Date(t.startTime).toLocaleTimeString():'',t.endTime?new Date(t.endTime).toLocaleTimeString():'',t.category,t.miles.toFixed(2),t.duration?Math.round(t.duration/60000):'',`"${(t.startName||'').replace(/"/g,'""')}"`,`"${(t.endName||'').replace(/"/g,'""')}"`,`"${(t.notes||'').replace(/"/g,'""')}"`].join(',');});
  dl('MileTracker_Export.csv',h+'\n'+rows.join('\n'),'text/csv');showToast('CSV exported');
}
function exportPDF(){
  if(!app.trips.length){showToast('No trips');return;}
  const biz=app.trips.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0);
  const pers=app.trips.filter(t=>t.category==='personal').reduce((s,t)=>s+t.miles,0);
  const ded=biz*app.settings.irsRate;
  let html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>MileTracker Report</title><style>body{font-family:-apple-system,sans-serif;padding:40px;color:#1a1a2e;max-width:800px;margin:0 auto}h1{color:#007AFF;border-bottom:3px solid #007AFF;padding-bottom:10px}.sum{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin:24px 0;padding:24px;background:#f0f4ff;border-radius:12px}.si{text-align:center}.sv{font-size:32px;font-weight:800}.sl{font-size:12px;color:#666;text-transform:uppercase;margin-top:4px}table{width:100%;border-collapse:collapse;margin:20px 0}th{background:#007AFF;color:white;padding:10px;text-align:left;font-size:12px}td{padding:8px 10px;border-bottom:1px solid #eee;font-size:13px}tr:nth-child(even){background:#f8f9ff}</style></head><body><h1>MileTracker Report</h1><p>Generated: ${new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}</p><div class="sum"><div class="si"><div class="sv" style="color:#007AFF">${biz.toFixed(1)}</div><div class="sl">Business Miles</div></div><div class="si"><div class="sv" style="color:#AF52DE">${pers.toFixed(1)}</div><div class="sl">Personal Miles</div></div><div class="si"><div class="sv" style="color:#34C759">$${ded.toFixed(2)}</div><div class="sl">Tax Deduction</div></div></div><table><thead><tr><th>Date</th><th>Category</th><th>From</th><th>To</th><th>Miles</th><th>Duration</th></tr></thead><tbody>`;
  app.trips.forEach(t=>{const d=new Date(t.date);html+=`<tr><td>${d.toLocaleDateString()}</td><td>${t.category}</td><td>${esc(t.startName||'')}</td><td>${esc(t.endName||'')}</td><td>${t.miles.toFixed(2)}</td><td>${t.duration?Math.round(t.duration/60000)+'m':'--'}</td></tr>`;});
  html+='</tbody></table></body></html>';
  const w=window.open('','_blank');w.document.write(html);w.document.close();setTimeout(()=>w.print(),500);
}
function dl(name,content,type){const b=new Blob([content],{type});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;a.click();URL.revokeObjectURL(u);}

// ===================== SETTINGS =====================
function renderSettings(){
  // User profile section
  const user = window._currentUser;
  const profileSection = document.getElementById('user-profile-section');
  if (user) {
    const initials = (user.displayName||user.email||'?').split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
    const avatarHtml = user.photoURL ? `<img src="${user.photoURL}" alt="${user.displayName}">` : initials;
    profileSection.innerHTML = `
      <div class="user-profile-card">
        <div class="user-profile-avatar">${avatarHtml}</div>
        <div class="user-profile-info" style="flex:1">
          <h4>${esc(user.displayName||'User')}</h4>
          <p>${esc(user.email||'')}</p>
          <div class="sync-badge">Synced to cloud</div>
        </div>
        <button class="btn-signout" onclick="window._signOut()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
          Sign Out
        </button>
      </div>`;
  }
  document.getElementById('tog-auto').className='toggle'+(app.settings.autoDetect?' on':'');
  document.getElementById('tog-tripalert').className='toggle'+(app.settings.tripAlerts?' on':'');
  document.getElementById('tog-classify').className='toggle'+(app.settings.classifyReminders?' on':'');
  document.getElementById('tog-weekly').className='toggle'+(app.settings.weeklySummary?' on':'');
  document.getElementById('set-defcat').value=app.settings.defaultCat;
  document.getElementById('set-speed').value=app.settings.speedThreshold;
  document.getElementById('set-irs').value=app.settings.irsRate.toFixed(2);
  document.getElementById('set-count').textContent=app.trips.length+' trips';
  const sal=document.getElementById('saved-addresses-list');
  const addrs=Object.entries(app.savedAddresses);
  if(!addrs.length)sal.innerHTML='<div class="setting-row"><div class="info"><h4>No saved addresses</h4><p>Addresses are learned from your trips</p></div></div>';
  else sal.innerHTML=addrs.map(([k,v])=>`<div class="setting-row"><div class="info"><h4>${esc(v.name)}</h4><p>${v.category} &middot; ${v.count} trips</p></div><button class="btn-danger" onclick="deleteAddr('${k}')" style="padding:4px 10px;font-size:12px">Remove</button></div>`).join('');
}
function deleteAddr(key){delete app.savedAddresses[key];save();renderSettings();}
function toggleSetting(key){app.settings[key]=!app.settings[key];save();renderSettings();}
function updateSetting(type){
  if(type==='defaultCat')app.settings.defaultCat=document.getElementById('set-defcat').value;
  if(type==='speed')app.settings.speedThreshold=parseInt(document.getElementById('set-speed').value)||5;
  if(type==='irs')app.settings.irsRate=parseFloat(document.getElementById('set-irs').value)||IRS_RATE_2026;
  save();
}
function clearAllData(){
  if(!confirm('Delete ALL trips?'))return;
  app.trips=[];app.notifications=[];app.savedAddresses={};
  if(window._clearAllFirestore)window._clearAllFirestore();
  save();updateHomeStats();renderSettings();showToast('All data cleared');
}

// ===================== ALWAYS-ON GPS MONITOR =====================
let monitorWatchId=null,pollTimer=null,speedHistory=[],stopCounter=0;
let lastMonitorTime=null,gpsReady=false,positionCount=0;
const DRIVE_DETECT_COUNT=2,STOP_DETECT_COUNT=12;

function debugLog(msg){const el=document.getElementById('gps-debug');if(!el)return;const t=new Date().toLocaleTimeString();el.innerHTML=`[${t}] ${msg}<br>`+el.innerHTML;if(el.children.length>20)el.innerHTML=el.innerHTML.split('<br>').slice(0,15).join('<br>');}
function calcSpeedBetween(lat1,lon1,t1,lat2,lon2,t2){const d=haversine(lat1,lon1,lat2,lon2);const h=(t2-t1)/3600000;return h<=0?0:d/h;}
function setGPS(status){
  const dot=document.getElementById('gps-dot'),text=document.getElementById('gps-text');
  dot.className='status-dot';dot.style.background='';
  if(status==='monitoring'){dot.classList.add('active');text.textContent='GPS Active \u2022 Always On';}
  else if(status==='recording'){dot.style.background='var(--red)';text.textContent='Recording Trip...';}
  else if(status==='searching'){dot.classList.add('searching');text.textContent='Acquiring GPS...';}
  else if(status==='error'){dot.classList.add('error');text.textContent='GPS Error';}
}
function startAlwaysOnMonitor(){
  if(!navigator.geolocation){setGPS('error');debugLog('No Geolocation API');return;}
  debugLog('Starting GPS...');setGPS('searching');
  document.getElementById('drive-sublabel').textContent='Requesting GPS access...';
  try{monitorWatchId=navigator.geolocation.watchPosition(handlePosition,handleError,{enableHighAccuracy:true,maximumAge:2000,timeout:10000});debugLog('watchPosition ID:'+monitorWatchId);}catch(e){debugLog('watchPosition failed:'+e.message);}
  startPolling();
  setTimeout(()=>{if(!gpsReady){debugLog('No GPS 5s - show button');document.getElementById('gps-activate').style.display='block';document.getElementById('drive-sublabel').textContent='Tap button below to activate GPS.';}},5000);
}
function startPolling(){if(pollTimer)clearInterval(pollTimer);pollTimer=setInterval(()=>{navigator.geolocation.getCurrentPosition(handlePosition,(e)=>{debugLog('Poll:'+e.message);},{enableHighAccuracy:true,maximumAge:1000,timeout:8000});},3000);debugLog('Polling started');}
function activateGPS(){
  debugLog('Manual activate');document.getElementById('gps-activate').style.display='none';
  document.getElementById('drive-sublabel').textContent='Activating GPS...';
  if(monitorWatchId!==null)navigator.geolocation.clearWatch(monitorWatchId);
  if(pollTimer)clearInterval(pollTimer);
  navigator.geolocation.getCurrentPosition(
    (pos)=>{debugLog('Manual OK');handlePosition(pos);monitorWatchId=navigator.geolocation.watchPosition(handlePosition,handleError,{enableHighAccuracy:true,maximumAge:2000,timeout:10000});startPolling();},
    (err)=>{debugLog('Manual FAIL:'+err.message);if(err.code===1)updateDriveUI('denied');else{document.getElementById('drive-sublabel').textContent='GPS error. Try again.';document.getElementById('gps-activate').style.display='block';}},
    {enableHighAccuracy:true,maximumAge:0,timeout:15000}
  );
}
function updateDriveUI(state){
  const circle=document.getElementById('drive-circle'),icon=document.getElementById('drive-icon'),label=document.getElementById('drive-label'),sub=document.getElementById('drive-sublabel');
  circle.className='drive-circle';
  if(state==='monitoring'){circle.classList.add('monitoring');icon.innerHTML='&#x1F7E2;';label.textContent='Always On';label.style.color='var(--green)';sub.textContent='GPS monitoring active. Trips auto-detect when you drive.';}
  else if(state==='recording'){circle.classList.add('recording');icon.innerHTML='&#x1F534;';label.textContent='Recording Trip';label.style.color='var(--red)';sub.textContent='Driving detected. Will auto-save when you stop.';}
  else if(state==='saved'){circle.classList.add('monitoring');icon.innerHTML='&#x2705;';label.textContent='Trip Saved!';label.style.color='var(--green)';}
  else if(state==='denied'){circle.classList.add('inactive');icon.innerHTML='&#x274C;';label.textContent='Location Denied';label.style.color='var(--red)';sub.textContent='Allow location in browser settings and refresh.';}
}
function handlePosition(pos){
  const{latitude,longitude,speed,accuracy}=pos.coords;const now=Date.now();positionCount++;
  if(!gpsReady){gpsReady=true;document.getElementById('gps-activate').style.display='none';debugLog('GPS READY');updateDriveUI('monitoring');}
  let gpsSpeed=(speed!==null&&speed>=0)?speed*2.237:0;let calcSpeed=0;
  if(lastMonitorPos&&lastMonitorTime&&(now-lastMonitorTime)>500){calcSpeed=calcSpeedBetween(lastMonitorPos.lat,lastMonitorPos.lng,lastMonitorTime,latitude,longitude,now);if(calcSpeed>200)calcSpeed=0;}
  const mph=Math.max(gpsSpeed,calcSpeed);
  if(accuracy>300){debugLog('Skip acc:'+Math.round(accuracy));return;}
  lastMonitorPos={lat:latitude,lng:longitude};lastMonitorTime=now;
  document.getElementById('idle-speed').textContent=Math.round(mph);
  document.getElementById('idle-accuracy').textContent=`GPS: \u00B1${Math.round(accuracy)}m | #${positionCount}`;
  updateMapPosition(latitude,longitude);
  if(!app.tracking){
    setGPS('monitoring');
    if(mph>app.settings.speedThreshold){speedHistory.push(mph);if(speedHistory.length>=DRIVE_DETECT_COUNT){speedHistory=[];stopCounter=0;showToast('Driving detected!');debugLog('=== TRIP START ===');autoStartTracking(pos);}}
    else{if(mph<app.settings.speedThreshold*0.5)speedHistory=[];}
  } else {
    onPos(pos);document.getElementById('live-speed').textContent=Math.round(mph)+' mph';
    if(mph<3){stopCounter++;if(stopCounter>=STOP_DETECT_COUNT){stopCounter=0;debugLog('=== TRIP END ===');stopTracking();}}else{stopCounter=0;}
  }
}
function handleError(err){
  debugLog('GPS Error:'+err.code+' '+err.message);
  if(err.code===1){setGPS('error');updateDriveUI('denied');}
  else{document.getElementById('drive-sublabel').textContent='GPS unavailable. Try again.';document.getElementById('gps-activate').style.display='block';}
}
function autoStartTracking(initialPos){
  app.tracking=true;positions=[];trackStart=Date.now();
  const{latitude,longitude,speed,accuracy}=initialPos.coords;
  if(accuracy<150)positions.push({lat:latitude,lng:longitude,time:Date.now(),speed,accuracy});
  updateDriveUI('recording');setGPS('recording');
  document.getElementById('idle-speed-wrap').style.display='none';document.getElementById('idle-accuracy').style.display='none';
  document.getElementById('live-panel').classList.add('show');
  document.getElementById('live-miles').textContent='0.0';document.getElementById('live-duration').textContent='0m';
  trackTimer=setInterval(updateDuration,1000);
  if(leafletMap){trackPolyline=L.polyline([],{color:'#FF5252',weight:4}).addTo(leafletMap);trackPolyline.addLatLng([latitude,longitude]);}
  if(app.settings.tripAlerts)addNotification('trip','Trip Started','Driving detected. Auto-recording.',null);
}
function stopTracking(){
  app.tracking=false;
  if(watchId!==null){navigator.geolocation.clearWatch(watchId);watchId=null;}
  if(trackTimer){clearInterval(trackTimer);trackTimer=null;}
  const miles=calcDistance();const dur=Date.now()-trackStart;
  const startPt=positions.length>0?positions[0]:null;const endPt=positions.length>1?positions[positions.length-1]:null;
  const saveMiles=miles>0?Math.round(miles*100)/100:0;
  const trip={id:Date.now().toString(),category:'unclassified',miles:saveMiles,date:new Date().toISOString(),duration:dur,startTime:new Date(trackStart).toISOString(),endTime:new Date().toISOString(),startName:'Locating...',endName:'Locating...',name:'',notes:'',startCoord:startPt?{lat:startPt.lat,lng:startPt.lng}:null,endCoord:endPt?{lat:endPt.lat,lng:endPt.lng}:null};
  if(saveMiles<0.1){debugLog('Trip too short, discarding');document.getElementById('live-panel').classList.remove('show');document.getElementById('idle-speed-wrap').style.display='';document.getElementById('idle-accuracy').style.display='';updateDriveUI('monitoring');setGPS('monitoring');stopCounter=0;speedHistory=[];return;}
  closeMap();
  let resolved=0;
  const checkReady=()=>{resolved++;if(resolved>=2)showTripSummary(trip);};
  if(startPt)reverseGeocode(startPt.lat,startPt.lng,name=>{trip.startName=name;checkReady();});else{trip.startName='Unknown';checkReady();}
  if(endPt)reverseGeocode(endPt.lat,endPt.lng,name=>{trip.endName=name;checkReady();});else{trip.endName='Unknown';checkReady();}
  document.getElementById('live-panel').classList.remove('show');document.getElementById('idle-speed-wrap').style.display='';document.getElementById('idle-accuracy').style.display='';
  updateDriveUI('saved');document.getElementById('drive-sublabel').textContent=`${saveMiles.toFixed(1)} miles recorded.`;
  setTimeout(()=>updateDriveUI('monitoring'),3000);setGPS('monitoring');stopCounter=0;speedHistory=[];
}

// ===================== TRIP SUMMARY =====================
function showTripSummary(trip){
  pendingSummaryTrip=trip;
  document.getElementById('sum-miles').textContent=trip.miles.toFixed(1);
  document.getElementById('sum-from').textContent=trip.startName;
  document.getElementById('sum-to').textContent=trip.endName;
  const durMin=trip.duration?Math.round(trip.duration/60000):0;
  document.getElementById('sum-dur').textContent=durMin>60?Math.floor(durMin/60)+'h '+durMin%60+'m':durMin+'min';
  document.getElementById('sum-speed').textContent=(trip.duration>0?(trip.miles/(trip.duration/3600000)).toFixed(0):'0')+' mph';
  const autoCat=autoClassifyTrip(trip);document.getElementById('sum-cat').value=autoCat||'unclassified';
  const addrRows=document.getElementById('sum-addr-rows');let addrHtml='';
  [trip.startName,trip.endName].forEach((addr,i)=>{
    if(!addr||addr==='Unknown'||addr==='Locating...')return;
    const saved=getAddrCategory(addr);const bizSel=saved==='business'?' sel':'';const persSel=saved==='personal'?' sel-p':'';
    addrHtml+=`<div class="addr-row"><div class="addr-name">${esc(addr.length>30?addr.substring(0,30)+'...':addr)}</div><div class="addr-btns"><button class="addr-btn${bizSel}" onclick="classifyAddr(this,'${i}','business')">&#128188; Biz</button><button class="addr-btn${persSel}" onclick="classifyAddr(this,'${i}','personal')">&#128100; Personal</button></div></div>`;
  });
  addrRows.innerHTML=addrHtml||'<div style="color:var(--text3);font-size:13px">No addresses to classify</div>';
  document.getElementById('summary-modal').classList.add('show');
}
function classifyAddr(btn,idx,cat){
  const row=btn.parentElement;row.querySelectorAll('.addr-btn').forEach(b=>{b.classList.remove('sel');b.classList.remove('sel-p');});
  btn.classList.add(cat==='business'?'sel':'sel-p');
  const addr=idx==='0'?pendingSummaryTrip.startName:pendingSummaryTrip.endName;
  saveAddrCategory(addr,cat);document.getElementById('sum-cat').value=cat;
}
function saveTripSummary(){
  if(!pendingSummaryTrip)return;
  pendingSummaryTrip.category=document.getElementById('sum-cat').value;
  app.trips.unshift(pendingSummaryTrip);
  setSyncing(true);
  if(window._saveTrip)window._saveTrip(pendingSummaryTrip).then(()=>setSyncing(false));
  save();
  document.getElementById('summary-modal').classList.remove('show');
  updateHomeStats();showToast(`Trip saved: ${pendingSummaryTrip.miles.toFixed(1)} mi`);
  if(app.settings.tripAlerts)addNotification('trip','Trip Saved',`${pendingSummaryTrip.startName} \u2192 ${pendingSummaryTrip.endName}: ${pendingSummaryTrip.miles.toFixed(1)} mi`,'classify');
  pendingSummaryTrip=null;
}

// ===================== MODAL CLOSE ON BACKDROP =====================
document.getElementById('edit-modal').addEventListener('click',function(e){if(e.target===this)closeModal();});
document.getElementById('manual-modal').addEventListener('click',function(e){if(e.target===this)closeManualModal();});
setupDistanceCalc();
// Start with login screen shown (Firebase will trigger showApp when auth state is ready)
showLogin();
// Set hostname in config screen if visible
setTimeout(() => {
  const el = document.getElementById('cfg-hostname');
  if (el) el.textContent = window.location.hostname || 'your-site.github.io';
}, 200);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MileTracker">
<meta name="theme-color" content="#0a0a1a">
<link rel="manifest" href="manifest.json">
<title>MileTracker - Smart Mileage Tracking</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc, writeBatch, onSnapshot }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // =============================================
  // ðŸ”§ PASTE YOUR FIREBASE CONFIG HERE
  // =============================================
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  // =============================================

  const firebaseApp = initializeApp(firebaseConfig);
  const auth = getAuth(firebaseApp);
  const db = getFirestore(firebaseApp);
  const provider = new GoogleAuthProvider();

  let currentUser = null;
  let unsubscribeFirestore = null;

  // Expose to global scope for non-module code
  window._fb = { auth, db, provider, signInWithPopup, signOut, onAuthStateChanged,
    doc, setDoc, getDoc, collection, getDocs, deleteDoc, writeBatch, onSnapshot };

  // Auth state listener
  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    window._currentUser = user;
    if (user) {
      showApp(user);
      loadFromFirestore(user.uid);
    } else {
      showLogin();
    }
  });

  window._signIn = async () => {
    try {
      document.getElementById('signin-btn').textContent = 'Signing in...';
      await signInWithPopup(auth, provider);
    } catch(e) {
      console.error(e);
      document.getElementById('signin-btn').textContent = 'Sign in with Google';
      showToast('Sign-in failed. Try again.');
    }
  };

  window._signOut = async () => {
    if (!confirm('Sign out?')) return;
    if (unsubscribeFirestore) unsubscribeFirestore();
    await signOut(auth);
  };

  async function loadFromFirestore(uid) {
    const { doc, getDoc, collection, getDocs, onSnapshot } = window._fb;
    try {
      // Load settings
      const settingsDoc = await getDoc(doc(db, 'users', uid, 'data', 'settings'));
      if (settingsDoc.exists()) {
        app.settings = { ...app.settings, ...settingsDoc.data() };
      }
      // Load saved addresses
      const addrDoc = await getDoc(doc(db, 'users', uid, 'data', 'addresses'));
      if (addrDoc.exists()) {
        app.savedAddresses = addrDoc.data().addresses || {};
      }
      // Real-time listener for trips
      const tripsRef = collection(db, 'users', uid, 'trips');
      unsubscribeFirestore = onSnapshot(tripsRef, (snapshot) => {
        app.trips = [];
        snapshot.forEach(d => app.trips.push({ id: d.id, ...d.data() }));
        app.trips.sort((a,b) => new Date(b.date) - new Date(a.date));
        updateHomeStats();
        updateNotifBadge();
        if (document.getElementById('page-trips').classList.contains('active')) renderTrips();
        if (document.getElementById('page-dashboard').classList.contains('active')) renderDashboard();
      });
      updateHomeStats();
      renderSettings();
    } catch(e) {
      console.error('Firestore load error', e);
      showToast('Sync error. Check connection.');
    }
  }

  window._saveTrip = async (trip) => {
    if (!window._currentUser) { save(); return; }
    const uid = window._currentUser.uid;
    try {
      const tripData = { ...trip };
      delete tripData.id;
      await setDoc(doc(db, 'users', uid, 'trips', trip.id), tripData);
    } catch(e) { console.error('Save trip error', e); save(); }
  };

  window._deleteTrip = async (tripId) => {
    if (!window._currentUser) { save(); return; }
    const uid = window._currentUser.uid;
    try {
      await deleteDoc(doc(db, 'users', uid, 'trips', tripId));
    } catch(e) { console.error('Delete trip error', e); }
  };

  window._saveSettings = async () => {
    if (!window._currentUser) { save(); return; }
    const uid = window._currentUser.uid;
    try {
      await setDoc(doc(db, 'users', uid, 'data', 'settings'), app.settings);
      await setDoc(doc(db, 'users', uid, 'data', 'addresses'), { addresses: app.savedAddresses });
    } catch(e) { console.error('Save settings error', e); save(); }
  };

  window._clearAllFirestore = async () => {
    if (!window._currentUser) return;
    const uid = window._currentUser.uid;
    try {
      const { collection, getDocs, writeBatch } = window._fb;
      const tripsRef = collection(db, 'users', uid, 'trips');
      const snap = await getDocs(tripsRef);
      const batch = writeBatch(db);
      snap.forEach(d => batch.delete(d.ref));
      await batch.commit();
      await setDoc(doc(db, 'users', uid, 'data', 'addresses'), { addresses: {} });
    } catch(e) { console.error('Clear error', e); }
  };
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

:root {
  --bg: #0a0a1a;
  --bg-secondary: #12122a;
  --card: rgba(255, 255, 255, 0.06);
  --card-border: rgba(255, 255, 255, 0.08);
  --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  --blue: #4F8EF7;
  --blue-light: rgba(79, 142, 247, 0.15);
  --teal: #00D4AA;
  --teal-light: rgba(0, 212, 170, 0.15);
  --pink: #FF6B9D;
  --pink-light: rgba(255, 107, 157, 0.15);
  --green: #00E676;
  --green-light: rgba(0, 230, 118, 0.15);
  --orange: #FFB74D;
  --red: #FF5252;
  --purple: #6C63FF;
  --text: #FFFFFF;
  --text2: rgba(255, 255, 255, 0.6);
  --text3: rgba(255, 255, 255, 0.3);
  --safe-top: env(safe-area-inset-top, 20px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(135deg, var(--bg) 0%, var(--bg-secondary) 100%);
  color: var(--text);
  min-height: 100vh;
  min-height: 100dvh;
  overflow-x: hidden;
}

/* ===== LOGIN SCREEN ===== */
#login-screen {
  display: none;
  position: fixed;
  inset: 0;
  background: linear-gradient(135deg, #0a0a1a 0%, #12122a 50%, #1a0a2e 100%);
  z-index: 1000;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 24px;
  text-align: center;
}
#login-screen.show { display: flex; }

.login-logo {
  width: 80px;
  height: 80px;
  background: linear-gradient(135deg, #4F8EF7 0%, #6C63FF 100%);
  border-radius: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 24px;
  box-shadow: 0 20px 60px rgba(79, 142, 247, 0.4);
}
.login-logo svg { width: 48px; height: 48px; fill: white; }

.login-title {
  font-size: 36px;
  font-weight: 800;
  letter-spacing: -1px;
  margin-bottom: 8px;
  background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.7) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.login-sub {
  font-size: 16px;
  color: var(--text2);
  margin-bottom: 60px;
  line-height: 1.5;
}

.login-features {
  display: flex;
  flex-direction: column;
  gap: 14px;
  margin-bottom: 52px;
  width: 100%;
  max-width: 320px;
}
.login-feature {
  display: flex;
  align-items: center;
  gap: 14px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 14px;
  padding: 14px 18px;
  text-align: left;
}
.login-feature .feat-icon { font-size: 24px; flex-shrink: 0; }
.login-feature .feat-text h4 { font-size: 14px; font-weight: 600; }
.login-feature .feat-text p { font-size: 12px; color: var(--text2); margin-top: 2px; }

#signin-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  width: 100%;
  max-width: 320px;
  padding: 16px 24px;
  background: white;
  color: #1a1a2e;
  border: none;
  border-radius: 14px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
  box-shadow: 0 8px 32px rgba(79, 142, 247, 0.3);
  transition: all 0.3s ease;
}
#signin-btn:active { transform: scale(0.97); }
#signin-btn svg { width: 22px; height: 22px; }

.login-privacy {
  font-size: 11px;
  color: var(--text3);
  margin-top: 16px;
  max-width: 280px;
  line-height: 1.5;
}

/* ===== APP SHELL ===== */
#app-shell { display: none; }
#app-shell.show { display: block; }

/* HEADER */
.app-header {
  background: #0a0a1a;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  padding: calc(var(--safe-top) + 12px) 20px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
}
.header-left { display: flex; align-items: center; gap: 12px; }
.header-logo {
  width: 40px; height: 40px;
  background: linear-gradient(135deg, #4F8EF7 0%, #6C63FF 100%);
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 8px 24px rgba(79, 142, 247, 0.3);
}
.header-logo svg { width: 24px; height: 24px; fill: white; }
.header-title { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
.header-right { display: flex; align-items: center; gap: 10px; }
.header-btn {
  width: 40px; height: 40px; border-radius: 12px;
  background: rgba(255,255,255,0.08); border: 1px solid var(--card-border);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: var(--text2); font-size: 18px; transition: all 0.3s ease;
}
.header-btn:hover { background: rgba(255,255,255,0.12); color: var(--blue); }

/* User avatar */
.user-avatar {
  width: 36px; height: 36px; border-radius: 50%;
  background: linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%);
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 700; color: white; cursor: pointer;
  border: 2px solid rgba(79,142,247,0.4); overflow: hidden;
  flex-shrink: 0;
}
.user-avatar img { width: 100%; height: 100%; object-fit: cover; }

/* Sync status dot */
.sync-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--green);
  animation: glow-pulse 3s infinite;
  flex-shrink: 0;
}
.sync-dot.syncing { background: var(--orange); animation: blink 0.8s infinite; }
.sync-dot.offline { background: var(--red); animation: none; }

/* STATUS BAR */
.status-bar {
  background: #0d0d20;
  border-bottom: 1px solid rgba(255,255,255,0.06);
  padding: 12px 20px;
  display: flex; align-items: center; gap: 10px;
}
.status-dot { width:10px; height:10px; border-radius:50%; background:var(--text3); flex-shrink:0; }
.status-dot.active { background:var(--green); animation:glow-pulse 2s infinite; }
.status-dot.searching { background:var(--orange); animation:blink 1.2s infinite; }
.status-dot.error { background:var(--red); }
.status-text { font-size:13px; color:var(--text2); }

/* BOTTOM NAV */
.bottom-nav {
  position: fixed; bottom:0; left:0; right:0;
  background: #0a0a1a; border-top: 1px solid rgba(255,255,255,0.08);
  display: flex; padding: 8px 0 calc(8px + var(--safe-bottom)); z-index:100;
}
.nav-item {
  flex:1; display:flex; flex-direction:column; align-items:center; gap:4px;
  padding:8px 0; border:none; background:none; cursor:pointer; font-family:inherit;
  position:relative; transition:all 0.3s ease;
}
.nav-item svg { width:24px; height:24px; fill:var(--text3); transition:all 0.3s ease; }
.nav-item span { font-size:10px; font-weight:500; color:var(--text3); transition:all 0.3s ease; }
.nav-item.active svg { fill:var(--blue); }
.nav-item.active span { color:var(--blue); }
.nav-item.active::before {
  content:''; position:absolute; top:0; left:50%; transform:translateX(-50%);
  width:20px; height:3px;
  background:linear-gradient(90deg, var(--blue) 0%, var(--teal) 100%); border-radius:2px;
}

/* PAGES */
.page { display:none; padding:0 0 100px; }
.page.active { display:block; }

/* ANIMATIONS */
@keyframes glow-pulse { 0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(79,142,247,0.7);}50%{opacity:0.8;box-shadow:0 0 0 10px rgba(79,142,247,0);} }
@keyframes blink { 0%,100%{opacity:1;}50%{opacity:0.2;} }
@keyframes record-pulse { 0%,100%{box-shadow:0 0 0 0 rgba(255,82,82,0.7);}50%{box-shadow:0 0 0 15px rgba(255,82,82,0);} }
@keyframes slide-up { from{transform:translateY(100%);opacity:0;}to{transform:translateY(0);opacity:1;} }
@keyframes fade-in { from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);} }

/* DRIVE PAGE */
.drive-hero { background:#0d0d20; border-bottom:1px solid rgba(255,255,255,0.06); padding:32px 20px 24px; text-align:center; }
.drive-circle { width:140px; height:140px; border-radius:50%; margin:0 auto 20px; position:relative; display:flex; align-items:center; justify-content:center; transition:all 0.3s ease; }
.drive-circle.monitoring { background:rgba(0,230,118,0.15); border:3px solid var(--green); box-shadow:0 0 30px rgba(0,230,118,0.3); }
.drive-circle.recording { background:rgba(255,82,82,0.15); border:3px solid var(--red); animation:record-pulse 2s infinite; box-shadow:0 0 30px rgba(255,82,82,0.4); }
.drive-circle.inactive { background:rgba(255,255,255,0.04); border:3px solid var(--text3); }
.drive-circle-inner { font-size:48px; line-height:1; }
.drive-label { font-size:24px; font-weight:700; margin-bottom:6px; }
.drive-sublabel { font-size:14px; color:var(--text2); margin-bottom:20px; line-height:1.5; }
.drive-speed { display:inline-flex; align-items:baseline; gap:6px; background:rgba(79,142,247,0.15); padding:12px 28px; border-radius:24px; margin-bottom:10px; border:1px solid rgba(79,142,247,0.3); }
.drive-speed .num { font-size:40px; font-weight:300; color:var(--blue); }
.drive-speed .unit { font-size:14px; color:var(--text2); font-weight:500; }
.drive-accuracy { font-size:12px; color:var(--text3); margin-top:8px; }
.live-panel { display:none; background:#0d0d20; border-bottom:1px solid rgba(255,255,255,0.06); padding:24px 20px; text-align:center; animation:slide-up 0.4s ease; }
.live-panel.show { display:block; }
.live-stats { display:flex; justify-content:center; gap:60px; margin:10px 0; }
.live-stat .val { font-size:44px; font-weight:300; color:var(--blue); }
.live-stat .lbl { font-size:12px; color:var(--text2); text-transform:uppercase; letter-spacing:1px; font-weight:600; margin-top:4px; }
.live-speed-inline { font-size:18px; font-weight:600; color:var(--blue); margin-top:12px; }
.gps-activate-wrap { display:none; padding:0 20px 16px; }
.gps-activate-btn { width:100%; padding:16px; border-radius:14px; border:2px solid var(--blue); background:linear-gradient(135deg,rgba(79,142,247,0.2),rgba(108,99,255,0.2)); color:var(--blue); font-size:16px; font-weight:600; cursor:pointer; font-family:inherit; transition:all 0.3s ease; }
.map-btn-wrap { padding:16px; }
.map-btn { width:100%; padding:14px; border-radius:14px; background:rgba(255,255,255,0.06); border:1px solid var(--card-border); color:var(--text); font-size:15px; font-weight:600; cursor:pointer; font-family:inherit; display:flex; align-items:center; justify-content:center; gap:8px; box-shadow:0 4px 15px rgba(0,0,0,0.2); transition:all 0.3s ease; }
.map-btn:hover { background:rgba(255,255,255,0.1); }
.quick-stats { display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:20px 16px 0; }
.quick-stat { background:rgba(255,255,255,0.06); backdrop-filter:blur(20px); border:1px solid var(--card-border); border-radius:16px; padding:20px; box-shadow:0 4px 15px rgba(0,0,0,0.2); transition:all 0.3s ease; }
.quick-stat:hover { background:rgba(255,255,255,0.08); transform:translateY(-2px); }
.quick-stat .icon { font-size:24px; margin-bottom:8px; }
.quick-stat .val { font-size:24px; font-weight:700; line-height:1.1; }
.quick-stat .val.biz { color:var(--blue); }
.quick-stat .val.pers { color:var(--pink); }
.quick-stat .val.ded { color:var(--green); }
.quick-stat .val.trips { color:var(--blue); }
.quick-stat .lbl { font-size:12px; color:var(--text2); margin-top:6px; font-weight:500; }
.uncl-banner { margin:16px 16px 0; background:rgba(255,183,77,0.15); border:1px solid rgba(255,183,77,0.3); border-radius:14px; padding:16px; display:none; }
.uncl-banner.show { display:flex; align-items:center; gap:12px; animation:slide-up 0.3s ease; }
.uncl-banner .icon { font-size:24px; flex-shrink:0; }
.uncl-banner .info h4 { font-size:14px; font-weight:600; color:var(--orange); }
.uncl-banner .info p { font-size:12px; color:var(--text2); margin-top:2px; }
.manual-btn-wrap { padding:12px 16px 0; }
.manual-btn { width:100%; padding:14px; border:2px dashed var(--card-border); border-radius:14px; background:rgba(255,255,255,0.03); color:var(--text2); font-size:14px; font-weight:500; cursor:pointer; font-family:inherit; display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.3s ease; }
.manual-btn:hover { border-color:var(--card-border); background:rgba(255,255,255,0.06); color:var(--text); }
.debug-log { margin:16px; font-size:10px; color:var(--text3); text-align:left; max-height:80px; overflow-y:auto; background:rgba(255,255,255,0.04); border-radius:10px; padding:10px; font-family:'SF Mono',monospace; }

/* MAP OVERLAY */
.map-overlay { position:fixed; inset:0; z-index:200; background:#f5f5f5; display:none; flex-direction:column; }
.map-overlay.show { display:flex; }
.map-header { background:#ffffff; padding:calc(var(--safe-top)+8px) 16px 12px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #e0e0e0; z-index:201; }
.map-header h3 { font-size:18px; font-weight:700; color:#1a1a2e; }
.map-close { background:#f0f0f0; border:none; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; cursor:pointer; color:#333; transition:all 0.3s ease; }
.map-trip-count { font-size:11px; font-weight:600; padding:3px 10px; border-radius:12px; background:#e8f0fe; color:#1a73e8; }
.map-filter-bar { display:flex; gap:6px; padding:10px 16px; background:#ffffff; border-bottom:1px solid #e0e0e0; z-index:202; overflow-x:auto; }
.map-filter-pill { padding:6px 16px; border-radius:20px; border:1px solid #ddd; background:#fff; color:#666; font-size:12px; font-weight:600; cursor:pointer; font-family:inherit; white-space:nowrap; transition:all 0.3s ease; }
.map-filter-pill.active { background:#1a73e8; border-color:#1a73e8; color:white; }
.map-legend { display:flex; gap:14px; padding:8px 16px; background:rgba(255,255,255,0.95); position:absolute; bottom:180px; left:12px; border-radius:12px; z-index:203; border:1px solid #e0e0e0; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.map-legend-item { display:flex; align-items:center; gap:5px; font-size:11px; color:#555; font-weight:500; }
.map-legend-dot { width:8px; height:8px; border-radius:50%; }
.map-trips-panel { position:absolute; bottom:0; left:0; right:0; max-height:55vh; background:rgba(255,255,255,0.97); border-top:1px solid #e0e0e0; border-radius:20px 20px 0 0; z-index:204; overflow-y:auto; transition:max-height 0.3s ease; box-shadow:0 -4px 20px rgba(0,0,0,0.1); }
.map-trips-panel.collapsed { max-height:70px; overflow:hidden; }
.map-trips-handle { display:flex; justify-content:center; padding:10px; cursor:pointer; }
.map-trips-handle-bar { width:40px; height:4px; border-radius:2px; background:#ccc; }
.map-trips-summary { display:flex; gap:10px; padding:0 16px 12px; border-bottom:1px solid #eee; }
.map-sum-card { flex:1; text-align:center; padding:10px 6px; border-radius:12px; background:#f8f9fa; border:1px solid #eee; }
.map-sum-card .val { font-size:20px; font-weight:700; line-height:1; color:#1a1a2e; }
.map-sum-card .lbl { font-size:10px; color:#888; margin-top:3px; text-transform:uppercase; letter-spacing:0.5px; }
.map-trips-list { padding:8px 12px 20px; }
.map-trip-item { display:flex; align-items:center; gap:10px; padding:12px; margin-bottom:6px; border-radius:12px; background:#fff; border:1px solid #eee; cursor:pointer; transition:all 0.2s ease; }
.map-trip-item:active { transform:scale(0.98); }
.map-trip-item.selected { border-color:#1a73e8; background:#e8f0fe; }
.map-trip-dot { width:12px; height:12px; border-radius:50%; flex-shrink:0; }
.map-trip-dot.business { background:#00D4AA; }
.map-trip-dot.personal { background:#FF6B9D; }
.map-trip-dot.unclassified { background:#FFB74D; }
.map-trip-info { flex:1; min-width:0; }
.map-trip-info .route { font-size:13px; font-weight:600; color:#1a1a2e; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.map-trip-info .meta { font-size:11px; color:#888; margin-top:2px; }
.map-trip-miles { text-align:right; flex-shrink:0; }
.map-trip-miles .mi { font-size:16px; font-weight:700; color:#1a1a2e; }
.map-trip-miles .unit { font-size:10px; color:#aaa; }
#map-container { flex:1; }

/* TRIPS */
.trips-header { background:#0d0d20; border-bottom:1px solid rgba(255,255,255,0.06); padding:20px 20px 0; }
.trips-header h2 { font-size:28px; font-weight:700; margin-bottom:16px; }
.filter-row { display:flex; gap:0; }
.filter-tab { flex:1; padding:12px 0; text-align:center; font-size:14px; font-weight:500; color:var(--text3); border:none; background:none; cursor:pointer; font-family:inherit; position:relative; transition:all 0.3s ease; }
.filter-tab:hover { color:var(--text2); }
.filter-tab.active { color:var(--blue); font-weight:600; }
.filter-tab.active::after { content:''; position:absolute; bottom:-1px; left:10%; right:10%; height:3px; background:linear-gradient(90deg,var(--blue),var(--teal)); border-radius:2px; }
.trips-list { padding:16px; }
.trip-date-header { font-size:12px; font-weight:600; color:var(--text2); padding:12px 4px 8px; text-transform:uppercase; letter-spacing:0.5px; }
.trip-card { background:rgba(255,255,255,0.06); border:1px solid var(--card-border); border-radius:16px; margin-bottom:12px; box-shadow:0 4px 15px rgba(0,0,0,0.2); overflow:hidden; transition:all 0.3s ease; }
.trip-card:hover { background:rgba(255,255,255,0.08); border-color:rgba(255,255,255,0.12); }
.trip-card:active { transform:scale(0.98); }
.trip-mini-map { width:100%; height:90px; background:#1a1a2e; position:relative; overflow:hidden; }
.map-category-badge { position:absolute; top:8px; right:8px; padding:4px 10px; border-radius:8px; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; }
.map-category-badge.business { background:rgba(0,212,170,0.25); color:#00D4AA; border:1px solid rgba(0,212,170,0.3); }
.map-category-badge.personal { background:rgba(255,107,157,0.25); color:#FF6B9D; border:1px solid rgba(255,107,157,0.3); }
.map-category-badge.unclassified { background:rgba(255,183,77,0.25); color:#FFB74D; border:1px solid rgba(255,183,77,0.3); }
.trip-route-section { padding:14px 16px 10px; }
.trip-route-row { display:flex; align-items:flex-start; gap:10px; }
.trip-route-dots { display:flex; flex-direction:column; align-items:center; padding-top:2px; flex-shrink:0; }
.route-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.route-dot.start { background:#00E676; border:2px solid rgba(0,230,118,0.3); }
.route-dot.end { background:#FF5252; border:2px solid rgba(255,82,82,0.3); }
.route-line { width:2px; height:20px; background:rgba(255,255,255,0.15); margin:3px 0; }
.trip-route-addrs { flex:1; min-width:0; }
.trip-addr { font-size:14px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:1.2; }
.trip-addr.to { margin-top:16px; }
.trip-miles-badge { flex-shrink:0; text-align:right; padding-top:8px; }
.trip-miles-badge .mi-val { font-size:24px; font-weight:800; line-height:1; }
.trip-miles-badge .mi-unit { font-size:11px; color:var(--text3); font-weight:500; }
.trip-meta-row { display:flex; align-items:center; justify-content:space-between; padding:8px 16px 12px; font-size:12px; color:var(--text2); }
.trip-meta-left { display:flex; align-items:center; gap:12px; }
.trip-deduction { font-weight:700; color:var(--teal); }
.trip-classify { display:flex; border-top:1px solid var(--card-border); }
.classify-btn { flex:1; padding:12px; border:none; background:none; cursor:pointer; font-family:inherit; font-size:13px; font-weight:600; display:flex; align-items:center; justify-content:center; gap:6px; color:var(--text2); transition:all 0.2s; }
.classify-btn:first-child { border-right:1px solid var(--card-border); }
.classify-btn:active { background:rgba(255,255,255,0.06); }
.classify-btn.sel-biz { color:var(--blue); background:rgba(79,142,247,0.15); }
.classify-btn.sel-pers { color:var(--pink); background:rgba(255,107,157,0.15); }
.classify-btn .dot { width:8px; height:8px; border-radius:50%; border:2px solid currentColor; }
.classify-btn.sel-biz .dot, .classify-btn.sel-pers .dot { background:currentColor; }
.empty-state { text-align:center; padding:80px 20px; color:var(--text3); }
.empty-state .icon { font-size:52px; margin-bottom:16px; opacity:0.5; }
.empty-state h3 { font-size:18px; color:var(--text2); margin-bottom:8px; }
.empty-state p { font-size:14px; }

/* DASHBOARD */
.dash-header { background:#0d0d20; border-bottom:1px solid rgba(255,255,255,0.06); padding:20px; }
.dash-header h2 { font-size:28px; font-weight:700; margin-bottom:16px; }
.period-pills { display:flex; gap:8px; flex-wrap:wrap; }
.period-pill { padding:8px 16px; border-radius:20px; border:1px solid var(--card-border); background:rgba(255,255,255,0.05); color:var(--text2); font-size:13px; font-weight:500; cursor:pointer; font-family:inherit; transition:all 0.3s ease; }
.period-pill.active { background:linear-gradient(135deg,var(--blue),var(--teal)); border-color:transparent; color:white; box-shadow:0 4px 15px rgba(79,142,247,0.3); }
.dash-content { padding:16px; }
.dash-card { background:rgba(255,255,255,0.06); border:1px solid var(--card-border); border-radius:16px; padding:20px; margin-bottom:12px; box-shadow:0 4px 15px rgba(0,0,0,0.2); transition:all 0.3s ease; }
.dash-card:hover { background:rgba(255,255,255,0.08); }
.dash-card-title { font-size:12px; font-weight:700; color:var(--text2); text-transform:uppercase; letter-spacing:1px; margin-bottom:16px; }
.summary-row { display:flex; text-align:center; }
.summary-item { flex:1; padding:12px 0; }
.summary-item:not(:last-child) { border-right:1px solid var(--card-border); }
.summary-item .val { font-size:32px; font-weight:700; line-height:1; }
.summary-item .val.biz { color:var(--blue); }
.summary-item .val.pers { color:var(--pink); }
.summary-item .val.total { color:var(--text); }
.summary-item .lbl { font-size:11px; color:var(--text2); margin-top:6px; font-weight:600; }
.breakdown-bar { height:14px; border-radius:7px; overflow:hidden; display:flex; margin-bottom:14px; background:rgba(255,255,255,0.05); }
.breakdown-bar .seg { height:100%; transition:width 0.5s ease; border-radius:2px 2px 0 0; }
.breakdown-bar .seg.biz { background:linear-gradient(90deg,var(--blue),#5a9dff); }
.breakdown-bar .seg.pers { background:linear-gradient(90deg,var(--pink),#ff8fb5); }
.breakdown-bar .seg.uncl { background:linear-gradient(90deg,var(--orange),#ffc97a); }
.breakdown-legend { display:flex; gap:16px; flex-wrap:wrap; }
.legend-item { display:flex; align-items:center; gap:8px; font-size:12px; color:var(--text2); }
.legend-dot { width:10px; height:10px; border-radius:50%; }
.tax-card { background:linear-gradient(135deg,rgba(0,212,170,0.15),rgba(0,230,118,0.15)); border:1px solid rgba(0,230,118,0.3); }
.tax-card h4 { font-size:14px; font-weight:600; color:var(--green); display:flex; align-items:center; gap:8px; margin-bottom:12px; }
.tax-amount { font-size:42px; font-weight:700; color:var(--green); }
.tax-detail { font-size:12px; color:var(--text2); margin-top:6px; }
.chart-area { height:180px; display:flex; align-items:flex-end; justify-content:space-around; padding:0 4px; margin-bottom:8px; border-bottom:1px solid var(--card-border); }
.chart-col { display:flex; flex-direction:column; align-items:center; gap:2px; flex:1; max-width:40px; }
.chart-stack { display:flex; flex-direction:column-reverse; width:80%; gap:1px; }
.chart-seg { min-height:0; transition:height 0.5s ease; border-radius:2px 2px 0 0; }
.chart-seg.biz { background:linear-gradient(90deg,var(--blue),#5a9dff); }
.chart-seg.pers { background:linear-gradient(90deg,var(--pink),#ff8fb5); }
.export-btns { display:flex; gap:10px; }
.btn-exp { flex:1; padding:12px; border-radius:12px; border:1px solid var(--card-border); background:rgba(255,255,255,0.05); color:var(--text); font-size:14px; font-weight:600; cursor:pointer; font-family:inherit; display:flex; align-items:center; justify-content:center; gap:6px; transition:all 0.3s ease; }
.btn-exp:active { transform:scale(0.96); }

/* Day view */
.add-trip-form { background:rgba(255,255,255,0.06); border:1px solid var(--card-border); border-radius:16px; padding:20px; margin-bottom:16px; }
.add-trip-form h4 { font-size:15px; font-weight:600; margin-bottom:16px; }
.form-row { margin-bottom:14px; }
.form-row label { display:block; font-size:11px; color:var(--text2); margin-bottom:6px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
.form-row input,.form-row select { width:100%; padding:12px; border:1px solid var(--card-border); border-radius:10px; font-size:15px; font-family:inherit; background:rgba(255,255,255,0.05); color:var(--text); -webkit-appearance:none; transition:all 0.3s ease; }
.form-row input:focus,.form-row select:focus { outline:none; background:rgba(255,255,255,0.08); border-color:var(--blue); }
.form-row-inline { display:flex; gap:12px; }
.form-row-inline .form-row { flex:1; }
.calc-distance { display:flex; align-items:center; gap:10px; padding:10px 14px; background:rgba(79,142,247,0.15); border-radius:10px; margin-bottom:14px; font-size:13px; color:var(--blue); font-weight:500; border:1px solid rgba(79,142,247,0.3); }
.form-btns { display:flex; gap:10px; margin-top:16px; }
.form-btns button { flex:1; padding:12px; border-radius:10px; border:none; font-size:15px; font-weight:600; cursor:pointer; font-family:inherit; transition:all 0.3s ease; }
.fbtn-cancel { background:rgba(255,255,255,0.06); color:var(--text); border:1px solid var(--card-border); }
.fbtn-save { background:linear-gradient(135deg,var(--blue),var(--teal)); color:white; box-shadow:0 4px 15px rgba(79,142,247,0.3); }
.fbtn-save:active { transform:scale(0.96); }
.day-trip-row { background:rgba(255,255,255,0.06); border:1px solid var(--card-border); border-radius:14px; padding:14px; margin-bottom:10px; display:flex; align-items:center; gap:12px; transition:all 0.3s ease; }
.day-trip-row .cat-dot { width:12px; height:12px; border-radius:50%; flex-shrink:0; }
.day-trip-row .cat-dot.biz { background:var(--blue); }
.day-trip-row .cat-dot.pers { background:var(--pink); }
.day-trip-row .cat-dot.uncl { background:var(--orange); }
.day-trip-row .route-info { flex:1; }
.day-trip-row .route-info .addr { font-size:14px; font-weight:600; }
.day-trip-row .route-info .meta { font-size:12px; color:var(--text2); margin-top:2px; }
.day-trip-row .miles-col { text-align:right; }
.day-trip-row .miles-col .mi { font-size:18px; font-weight:700; }
.day-trip-row .miles-col .lbl { font-size:10px; color:var(--text2); }

/* NOTIFICATIONS */
.notif-header { background:#0d0d20; border-bottom:1px solid rgba(255,255,255,0.06); padding:20px; }
.notif-header h2 { font-size:28px; font-weight:700; }
.notif-list { padding:16px; }
.notif-card { background:rgba(255,255,255,0.06); border:1px solid var(--card-border); border-radius:16px; padding:16px; margin-bottom:10px; display:flex; align-items:flex-start; gap:12px; transition:all 0.3s ease; }
.notif-icon { width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px; flex-shrink:0; }
.notif-icon.trip { background:rgba(0,230,118,0.2); }
.notif-icon.classify { background:rgba(255,183,77,0.2); }
.notif-icon.report { background:rgba(79,142,247,0.2); }
.notif-icon.alert { background:rgba(255,82,82,0.2); }
.notif-body { flex:1; }
.notif-body h4 { font-size:14px; font-weight:600; }
.notif-body p { font-size:13px; color:var(--text2); margin-top:4px; line-height:1.4; }
.notif-body .time { font-size:11px; color:var(--text3); margin-top:6px; }
.notif-action { padding:6px 14px; border-radius:8px; border:none; background:linear-gradient(135deg,var(--blue),var(--teal)); color:white; font-size:12px; font-weight:600; cursor:pointer; font-family:inherit; margin-top:10px; transition:all 0.3s ease; }
.notif-badge { position:absolute; top:-4px; right:-4px; min-width:18px; height:18px; border-radius:9px; background:linear-gradient(135deg,var(--red),#ff7070); color:white; font-size:10px; font-weight:700; display:flex; align-items:center; justify-content:center; padding:0 4px; box-shadow:0 2px 8px rgba(255,82,82,0.3); }

/* SETTINGS */
.settings-header { background:#0d0d20; border-bottom:1px solid rgba(255,255,255,0.06); padding:16px 20px; display:flex; align-items:center; gap:12px; }
.settings-header h2 { font-size:28px; font-weight:700; }
.settings-back { background:none; border:none; font-size:24px; color:var(--blue); cursor:pointer; padding:4px; }
.settings-content { padding:16px; }
.settings-section-title { font-size:11px; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--text2); padding:12px 4px 8px; }
.settings-card { background:rgba(255,255,255,0.06); border:1px solid var(--card-border); border-radius:14px; margin-bottom:12px; overflow:hidden; }
.setting-row { display:flex; align-items:center; justify-content:space-between; padding:16px; border-bottom:1px solid var(--card-border); }
.setting-row:last-child { border-bottom:none; }
.setting-row .info h4 { font-size:15px; font-weight:500; }
.setting-row .info p { font-size:12px; color:var(--text2); margin-top:4px; }
.toggle { width:54px; height:32px; background:rgba(255,255,255,0.1); border-radius:18px; position:relative; cursor:pointer; border:1px solid var(--card-border); flex-shrink:0; transition:all 0.3s ease; }
.toggle.on { background:linear-gradient(135deg,var(--green),#00e67e); border-color:transparent; box-shadow:0 4px 12px rgba(0,230,118,0.3); }
.toggle::after { content:''; width:28px; height:28px; background:white; border-radius:50%; position:absolute; top:2px; left:2px; transition:transform 0.3s ease; box-shadow:0 2px 6px rgba(0,0,0,0.3); }
.toggle.on::after { transform:translateX(22px); }
.setting-input { padding:8px 12px; border-radius:8px; border:1px solid var(--card-border); background:rgba(255,255,255,0.05); color:var(--text); font-family:inherit; font-size:14px; text-align:center; transition:all 0.3s ease; }
.setting-input:focus { outline:none; background:rgba(255,255,255,0.08); border-color:var(--blue); }
.btn-danger { padding:8px 16px; border-radius:8px; border:none; background:rgba(255,82,82,0.15); color:var(--red); font-size:14px; font-weight:500; cursor:pointer; font-family:inherit; transition:all 0.3s ease; }
.btn-danger:hover { background:rgba(255,82,82,0.25); }
.btn-signout { padding:8px 16px; border-radius:8px; border:1px solid rgba(255,82,82,0.3); background:rgba(255,82,82,0.1); color:var(--red); font-size:14px; font-weight:600; cursor:pointer; font-family:inherit; display:flex; align-items:center; gap:6px; transition:all 0.3s ease; }
.btn-signout:hover { background:rgba(255,82,82,0.2); }

/* User profile card in settings */
.user-profile-card {
  background: linear-gradient(135deg, rgba(79,142,247,0.15), rgba(108,99,255,0.15));
  border: 1px solid rgba(79,142,247,0.3);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 16px;
}
.user-profile-avatar {
  width: 56px; height: 56px; border-radius: 50%;
  background: linear-gradient(135deg,var(--blue),var(--purple));
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; font-weight: 700; color: white;
  overflow: hidden; flex-shrink: 0;
  border: 2px solid rgba(79,142,247,0.4);
}
.user-profile-avatar img { width:100%; height:100%; object-fit:cover; }
.user-profile-info h4 { font-size:16px; font-weight:700; }
.user-profile-info p { font-size:13px; color:var(--text2); margin-top:3px; }
.user-profile-info .sync-badge { display:inline-flex; align-items:center; gap:5px; margin-top:6px; font-size:11px; color:var(--green); font-weight:500; }
.user-profile-info .sync-badge::before { content:''; width:6px; height:6px; border-radius:50%; background:var(--green); }

/* MODALS */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:300; display:none; align-items:flex-end; justify-content:center; backdrop-filter:blur(8px); }
.modal-overlay.show { display:flex; }
.modal { background:linear-gradient(135deg,rgba(255,255,255,0.1),rgba(255,255,255,0.08)); backdrop-filter:blur(20px); border:1px solid var(--card-border); border-radius:24px 24px 0 0; width:100%; max-width:500px; padding:20px; padding-bottom:calc(24px+var(--safe-bottom)); transform:translateY(100%); transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1); max-height:90vh; overflow-y:auto; }
.modal-overlay.show .modal { transform:translateY(0); }
.modal-handle { width:40px; height:5px; background:rgba(255,255,255,0.2); border-radius:3px; margin:0 auto 20px; }
.modal h3 { font-size:22px; font-weight:700; margin-bottom:20px; }
.modal-field { margin-bottom:16px; }
.modal-field label { display:block; font-size:12px; color:var(--text2); margin-bottom:8px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
.modal-field input,.modal-field textarea,.modal-field select { width:100%; padding:12px; border:1px solid var(--card-border); border-radius:12px; font-size:16px; font-family:inherit; background:rgba(255,255,255,0.05); color:var(--text); -webkit-appearance:none; transition:all 0.3s ease; }
.modal-field input:focus,.modal-field textarea:focus,.modal-field select:focus { outline:none; background:rgba(255,255,255,0.08); border-color:var(--blue); }
.modal-field textarea { resize:vertical; min-height:80px; }
.modal-btns { display:flex; gap:10px; margin-top:20px; }
.modal-btns button { flex:1; padding:14px; border-radius:12px; border:none; font-size:16px; font-weight:600; cursor:pointer; font-family:inherit; transition:all 0.3s ease; }
.mbtn-cancel { background:rgba(255,255,255,0.06); color:var(--text); border:1px solid var(--card-border); }
.mbtn-cancel:active { transform:scale(0.96); }
.mbtn-delete { background:rgba(255,82,82,0.15); color:var(--red); border:1px solid rgba(255,82,82,0.3); }
.mbtn-delete:active { transform:scale(0.96); }
.mbtn-save { background:linear-gradient(135deg,var(--blue),var(--teal)); color:white; box-shadow:0 4px 15px rgba(79,142,247,0.3); }
.mbtn-save:active { transform:scale(0.96); }
.trip-summary-card { background:rgba(255,255,255,0.04); border-radius:14px; padding:20px; margin-bottom:20px; }
.trip-summary-card .row { display:flex; justify-content:space-between; padding:8px 0; }
.trip-summary-card .row .label { font-size:13px; color:var(--text2); }
.trip-summary-card .row .value { font-size:14px; font-weight:600; }
.trip-summary-card .miles-big { font-size:48px; font-weight:700; text-align:center; color:var(--blue); margin:16px 0; }
.trip-summary-card .miles-lbl { text-align:center; font-size:13px; color:var(--text2); }
.addr-classify { background:rgba(255,255,255,0.04); border-radius:14px; padding:16px; margin-bottom:16px; }
.addr-classify h4 { font-size:15px; font-weight:600; margin-bottom:12px; }
.addr-classify .addr-row { display:flex; align-items:center; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.08); }
.addr-classify .addr-row:last-child { border-bottom:none; }
.addr-classify .addr-name { font-size:14px; font-weight:500; }
.addr-classify .addr-btns { display:flex; gap:8px; }
.addr-classify .addr-btn { padding:6px 12px; border-radius:8px; border:1px solid var(--card-border); background:rgba(255,255,255,0.05); font-size:12px; font-weight:600; cursor:pointer; font-family:inherit; color:var(--text2); transition:all 0.3s ease; }
.addr-classify .addr-btn.sel { border-color:var(--blue); color:var(--blue); background:rgba(79,142,247,0.2); }
.addr-classify .addr-btn.sel-p { border-color:var(--pink); color:var(--pink); background:rgba(255,107,157,0.2); }

/* TOAST */
.toast { position:fixed; top:calc(var(--safe-top)+70px); left:50%; transform:translateX(-50%) translateY(-100px); background:rgba(30,30,50,0.95); backdrop-filter:blur(10px); color:white; padding:14px 28px; border-radius:28px; font-size:14px; font-weight:500; z-index:400; transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1); box-shadow:0 8px 32px rgba(0,0,0,0.4); border:1px solid rgba(255,255,255,0.1); }
.toast.show { transform:translateX(-50%) translateY(0); }

/* NOTIF BANNER */
.notif-banner { position:fixed; top:calc(var(--safe-top)+60px); left:12px; right:12px; background:linear-gradient(135deg,rgba(255,255,255,0.1),rgba(255,255,255,0.08)); backdrop-filter:blur(20px); border:1px solid var(--card-border); border-radius:16px; padding:16px; box-shadow:0 8px 32px rgba(0,0,0,0.4); z-index:500; display:flex; align-items:center; gap:14px; transform:translateY(-200px); transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1); }
.notif-banner.show { transform:translateY(0); }
.notif-banner .n-icon { font-size:32px; flex-shrink:0; }
.notif-banner .n-body { flex:1; }
.notif-banner .n-body h5 { font-size:14px; font-weight:600; }
.notif-banner .n-body p { font-size:12px; color:var(--text2); margin-top:2px; }
.notif-banner .n-close { background:none; border:none; color:var(--text3); font-size:20px; cursor:pointer; padding:4px; }

::-webkit-scrollbar { width:0; }
</style>
</head>
<body>

<!-- ===== LOGIN SCREEN ===== -->
<div id="login-screen">
  <div class="login-logo">
    <svg viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>
  </div>
  <div class="login-title">MileTracker</div>
  <div class="login-sub">Smart mileage tracking for<br>business & tax deductions</div>

  <div class="login-features">
    <div class="login-feature">
      <div class="feat-icon">ðŸ›°ï¸</div>
      <div class="feat-text">
        <h4>Auto-detect trips</h4>
        <p>GPS starts recording when you drive</p>
      </div>
    </div>
    <div class="login-feature">
      <div class="feat-icon">â˜ï¸</div>
      <div class="feat-text">
        <h4>Cloud sync</h4>
        <p>Your trips sync across all devices</p>
      </div>
    </div>
    <div class="login-feature">
      <div class="feat-icon">ðŸ’°</div>
      <div class="feat-text">
        <h4>Tax deductions</h4>
        <p>IRS-ready reports & CSV export</p>
      </div>
    </div>
  </div>

  <button id="signin-btn" onclick="window._signIn()">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
      <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
      <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
      <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
    </svg>
    Sign in with Google
  </button>
  <div class="login-privacy">Your data is private and secure. Trips are stored in your personal cloud account and never shared.</div>
</div>

<!-- ===== APP SHELL ===== -->
<div id="app-shell">

<div class="toast" id="toast"></div>
<div class="notif-banner" id="notif-banner">
  <div class="n-icon" id="nb-icon"></div>
  <div class="n-body"><h5 id="nb-title"></h5><p id="nb-msg"></p></div>
  <button class="n-close" onclick="hideNotifBanner()">&times;</button>
</div>

<!-- HEADER -->
<div class="app-header">
  <div class="header-left">
    <div class="header-logo"><svg viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg></div>
    <div class="header-title">MileTracker</div>
  </div>
  <div class="header-right">
    <div class="sync-dot" id="sync-dot" title="Synced to cloud"></div>
    <div class="user-avatar" id="user-avatar" onclick="openSettings()" title="Account">?</div>
    <button class="header-btn" onclick="openSettings()" title="Settings">&#9881;</button>
  </div>
</div>

<!-- STATUS BAR -->
<div class="status-bar" id="status-bar">
  <span class="status-dot" id="gps-dot"></span>
  <span class="status-text" id="gps-text">Starting GPS...</span>
</div>

<!-- MAP OVERLAY -->
<div class="map-overlay" id="map-overlay">
  <div class="map-header">
    <div style="display:flex;align-items:center;gap:10px">
      <h3>My Trips</h3>
      <span class="map-trip-count" id="map-trip-count">0 trips</span>
    </div>
    <button class="map-close" onclick="closeMap()">&times;</button>
  </div>
  <div class="map-filter-bar" id="map-filter-bar">
    <button class="map-filter-pill active" onclick="setMapFilter('today',this)">Today</button>
    <button class="map-filter-pill" onclick="setMapFilter('week',this)">This Week</button>
    <button class="map-filter-pill" onclick="setMapFilter('month',this)">This Month</button>
    <button class="map-filter-pill" onclick="setMapFilter('all',this)">All</button>
  </div>
  <div class="map-legend">
    <span class="map-legend-item"><span class="map-legend-dot" style="background:#00D4AA"></span>Business</span>
    <span class="map-legend-item"><span class="map-legend-dot" style="background:#FF6B9D"></span>Personal</span>
    <span class="map-legend-item"><span class="map-legend-dot" style="background:#FFB74D"></span>Unclassified</span>
  </div>
  <div id="map-container"></div>
  <div class="map-trips-panel" id="map-trips-panel">
    <div class="map-trips-handle" onclick="toggleMapTripsPanel()"><div class="map-trips-handle-bar"></div></div>
    <div class="map-trips-summary" id="map-trips-summary"></div>
    <div class="map-trips-list" id="map-trips-list"></div>
  </div>
</div>

<!-- DRIVE PAGE -->
<div class="page active" id="page-drive">
  <div class="drive-hero" id="drive-hero">
    <div class="drive-circle monitoring" id="drive-circle">
      <div class="drive-circle-inner" id="drive-icon">&#x1F7E2;</div>
    </div>
    <div class="drive-label" id="drive-label">Always On</div>
    <div class="drive-sublabel" id="drive-sublabel">GPS monitoring active. Trips auto-detect when you drive.</div>
    <div class="drive-speed" id="idle-speed-wrap">
      <span class="num" id="idle-speed">0</span><span class="unit">mph</span>
    </div>
    <div class="drive-accuracy" id="idle-accuracy">GPS accuracy: --</div>
  </div>
  <div class="live-panel" id="live-panel">
    <div class="live-stats">
      <div class="live-stat"><div class="val" id="live-miles">0.0</div><div class="lbl">Miles</div></div>
      <div class="live-stat"><div class="val" id="live-duration">0m</div><div class="lbl">Duration</div></div>
    </div>
    <div class="live-speed-inline" id="live-speed">0 mph</div>
  </div>
  <div class="gps-activate-wrap" id="gps-activate">
    <button class="gps-activate-btn" onclick="activateGPS()">Tap to Activate GPS</button>
    <div style="font-size:11px;color:var(--text3);margin-top:6px;text-align:center">Some browsers need a tap to start location</div>
  </div>
  <div class="map-btn-wrap">
    <button class="map-btn" onclick="switchPage('trips',document.getElementById('nav-trips'))">&#x1F5FA; View My Trips</button>
    <button class="map-btn" onclick="openMap()" style="margin-top:8px">&#127760; Open Full Map</button>
  </div>
  <div class="quick-stats">
    <div class="quick-stat"><div class="icon">&#128188;</div><div class="val biz" id="s-biz">0 mi</div><div class="lbl">Business Miles</div></div>
    <div class="quick-stat"><div class="icon">&#128100;</div><div class="val pers" id="s-pers">0 mi</div><div class="lbl">Personal Miles</div></div>
    <div class="quick-stat"><div class="icon">$</div><div class="val ded" id="s-ded">$0.00</div><div class="lbl">Tax Deduction</div></div>
    <div class="quick-stat"><div class="icon">&#128663;</div><div class="val trips" id="s-trips">0</div><div class="lbl">Total Trips</div></div>
  </div>
  <div class="uncl-banner" id="uncl-banner"><div class="icon">&#9888;&#65039;</div><div class="info"><h4>Unclassified Trips</h4><p id="uncl-text">Tap to classify</p></div></div>
  <div class="manual-btn-wrap"><button class="manual-btn" onclick="openManualTrip()">+ Add Trip Manually</button></div>
  <div class="debug-log" id="gps-debug"></div>
</div>

<!-- TRIPS PAGE -->
<div class="page" id="page-trips">
  <div class="trips-header">
    <h2>Your Trips</h2>
    <div class="filter-row">
      <button class="filter-tab active" onclick="filterTrips('all',this)">All</button>
      <button class="filter-tab" onclick="filterTrips('business',this)">Business</button>
      <button class="filter-tab" onclick="filterTrips('personal',this)">Personal</button>
      <button class="filter-tab" onclick="filterTrips('unclassified',this)">Unclassified</button>
    </div>
  </div>
  <div class="trips-list" id="trips-list"></div>
  <div class="empty-state" id="trips-empty"><div class="icon">&#128663;</div><h3>No trips yet</h3><p>Start driving to see trips here</p></div>
</div>

<!-- DASHBOARD PAGE -->
<div class="page" id="page-dashboard">
  <div class="dash-header">
    <h2>Dashboard</h2>
    <div class="period-pills">
      <button class="period-pill" onclick="setDashPeriod('day',this)">Day</button>
      <button class="period-pill" onclick="setDashPeriod('week',this)">Week</button>
      <button class="period-pill active" onclick="setDashPeriod('month',this)">Month</button>
      <button class="period-pill" onclick="setDashPeriod('year',this)">Year</button>
    </div>
  </div>
  <div class="dash-content" id="dash-content"></div>
</div>

<!-- NOTIFICATIONS -->
<div class="page" id="page-notifs">
  <div class="notif-header"><h2>Notifications</h2></div>
  <div class="notif-list" id="notif-list"></div>
</div>

<!-- SETTINGS -->
<div class="page" id="page-settings">
  <div class="settings-header">
    <button class="settings-back" onclick="goBack()">&larr;</button>
    <h2>Settings</h2>
  </div>
  <div class="settings-content">
    <div id="user-profile-section"></div>
    <div class="settings-section-title">Tracking</div>
    <div class="settings-card">
      <div class="setting-row"><div class="info"><h4>Auto-detect trips</h4><p>Start recording when driving</p></div><button class="toggle on" id="tog-auto" onclick="toggleSetting('autoDetect')"></button></div>
      <div class="setting-row"><div class="info"><h4>Default category</h4><p>New trips default to this</p></div><select class="setting-input" id="set-defcat" onchange="updateSetting('defaultCat')" style="width:120px"><option value="unclassified">Unclassified</option><option value="business">Business</option><option value="personal">Personal</option></select></div>
      <div class="setting-row"><div class="info"><h4>Speed threshold</h4><p>Min mph to count as driving</p></div><input type="number" class="setting-input" id="set-speed" value="5" min="1" max="25" style="width:60px" onchange="updateSetting('speed')"></div>
    </div>
    <div class="settings-section-title">Notifications</div>
    <div class="settings-card">
      <div class="setting-row"><div class="info"><h4>Trip alerts</h4><p>Notify when trips saved</p></div><button class="toggle on" id="tog-tripalert" onclick="toggleSetting('tripAlerts')"></button></div>
      <div class="setting-row"><div class="info"><h4>Classification reminders</h4><p>Remind to classify trips</p></div><button class="toggle on" id="tog-classify" onclick="toggleSetting('classifyReminders')"></button></div>
      <div class="setting-row"><div class="info"><h4>Weekly summary</h4><p>Show weekly mileage summary</p></div><button class="toggle on" id="tog-weekly" onclick="toggleSetting('weeklySummary')"></button></div>
    </div>
    <div class="settings-section-title">IRS Rate</div>
    <div class="settings-card">
      <div class="setting-row"><div class="info"><h4>Business rate per mile</h4><p>2026 IRS standard mileage rate</p></div><div style="display:flex;align-items:center;gap:4px"><span>$</span><input type="number" class="setting-input" id="set-irs" value="0.70" step="0.01" min="0" style="width:70px" onchange="updateSetting('irs')"></div></div>
    </div>
    <div class="settings-section-title">Saved Addresses</div>
    <div class="settings-card" id="saved-addresses-list"></div>
    <div class="settings-section-title">Data</div>
    <div class="settings-card">
      <div class="setting-row"><div class="info"><h4>Total recorded</h4><p id="set-count">0 trips</p></div></div>
      <div class="setting-row"><div class="info"><h4>Clear all data</h4><p>Remove all trip records</p></div><button class="btn-danger" onclick="clearAllData()">Clear</button></div>
    </div>
    <div style="text-align:center;color:var(--text3);font-size:12px;padding:20px">MileTracker v4.1 Â· Cloud Sync Edition</div>
  </div>
</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <button class="nav-item active" onclick="switchPage('drive',this)" id="nav-drive">
    <svg viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg><span>Drive</span>
  </button>
  <button class="nav-item" onclick="switchPage('trips',this)" id="nav-trips">
    <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg><span>Trips</span>
  </button>
  <button class="nav-item" onclick="switchPage('dashboard',this)" id="nav-dashboard">
    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg><span>Dashboard</span>
  </button>
  <button class="nav-item" onclick="switchPage('notifs',this)" id="nav-notifs" style="position:relative">
    <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg><span>Alerts</span>
    <span class="notif-badge" id="notif-badge" style="display:none">0</span>
  </button>
</div>

<!-- MANUAL TRIP MODAL -->
<div class="modal-overlay" id="manual-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3>Add Trip</h3>
    <div class="modal-field"><label>From Address</label><input type="text" id="man-from" placeholder="e.g. 123 Main St or Home"></div>
    <div class="modal-field"><label>To Address</label><input type="text" id="man-to" placeholder="e.g. 456 Oak Ave or Office"></div>
    <div id="man-calc-dist" style="display:none" class="calc-distance"><span>&#x1F4CD;</span><span id="man-calc-text">Calculating distance...</span></div>
    <div class="modal-field"><label>Miles (auto-calculated or manual)</label><input type="number" id="man-miles" step="0.1" min="0" placeholder="Miles"></div>
    <div class="modal-field"><label>Category</label><select id="man-cat"><option value="business">Business</option><option value="personal">Personal</option><option value="unclassified">Unclassified</option></select></div>
    <div class="modal-field"><label>Date</label><input type="date" id="man-date"></div>
    <div class="modal-field"><label>Notes (optional)</label><textarea id="man-notes" placeholder="Meeting with client..."></textarea></div>
    <div class="modal-btns">
      <button class="mbtn-cancel" onclick="closeManualModal()">Cancel</button>
      <button class="mbtn-save" onclick="saveManualTrip()">Save Trip</button>
    </div>
  </div>
</div>

<!-- EDIT TRIP MODAL -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3>Edit Trip</h3>
    <div class="modal-field"><label>Trip Name</label><input type="text" id="ed-name" placeholder="Home to Office"></div>
    <div class="modal-field"><label>Category</label><select id="ed-cat"><option value="business">Business</option><option value="personal">Personal</option><option value="unclassified">Unclassified</option></select></div>
    <div class="modal-field"><label>Miles</label><input type="number" id="ed-miles" step="0.1" min="0"></div>
    <div class="modal-field"><label>Notes</label><textarea id="ed-notes" placeholder="Optional notes..."></textarea></div>
    <div class="modal-btns">
      <button class="mbtn-cancel" onclick="closeModal()">Cancel</button>
      <button class="mbtn-delete" onclick="deleteTrip()">Delete</button>
      <button class="mbtn-save" onclick="saveEditTrip()">Save</button>
    </div>
  </div>
</div>

<!-- TRIP SUMMARY MODAL -->
<div class="modal-overlay" id="summary-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3>Trip Complete!</h3>
    <div class="trip-summary-card">
      <div class="miles-big" id="sum-miles">0.0</div>
      <div class="miles-lbl">miles driven</div>
      <div class="row"><span class="label">From</span><span class="value" id="sum-from">--</span></div>
      <div class="row"><span class="label">To</span><span class="value" id="sum-to">--</span></div>
      <div class="row"><span class="label">Duration</span><span class="value" id="sum-dur">--</span></div>
      <div class="row"><span class="label">Avg Speed</span><span class="value" id="sum-speed">--</span></div>
    </div>
    <div class="addr-classify" id="sum-addr-section">
      <h4>Classify these addresses</h4>
      <div id="sum-addr-rows"></div>
    </div>
    <div class="modal-field"><label>Trip Category</label>
      <select id="sum-cat">
        <option value="business">Business</option>
        <option value="personal">Personal</option>
        <option value="unclassified">Decide Later</option>
      </select>
    </div>
    <div class="modal-btns">
      <button class="mbtn-save" onclick="saveTripSummary()" style="flex:1">Save Trip</button>
    </div>
  </div>
</div>

</div><!-- end app-shell -->

<script>
// ===================== STATE =====================
const IRS_RATE_2026 = 0.70;
let app = {
  trips: [], tracking: false, notifications: [],
  savedAddresses: {},
  settings: {
    autoDetect:true, defaultCat:'unclassified', speedThreshold:5,
    irsRate:IRS_RATE_2026, tripAlerts:true, classifyReminders:true, weeklySummary:true
  },
  dashPeriod:'month', tripFilter:'all', editId:null, lastPage:'drive'
};
let watchId=null, positions=[], trackStart=null, trackTimer=null;
let leafletMap=null, userMarker=null, trackPolyline=null;
let pendingSummaryTrip = null;

// ===================== AUTH UI =====================
function showLogin() {
  document.getElementById('login-screen').classList.add('show');
  document.getElementById('app-shell').classList.remove('show');
}
function showApp(user) {
  document.getElementById('login-screen').classList.remove('show');
  document.getElementById('app-shell').classList.add('show');
  // Set user avatar
  const av = document.getElementById('user-avatar');
  if (user.photoURL) {
    av.innerHTML = `<img src="${user.photoURL}" alt="${user.displayName}">`;
  } else {
    av.textContent = (user.displayName||user.email||'?')[0].toUpperCase();
  }
  load();
  updateHomeStats();
  updateNotifBadge();
  startAlwaysOnMonitor();
  if (!app.notifications.length) {
    addNotification('alert','Welcome to MileTracker!','Trips auto-detect when you drive. Your data syncs to the cloud.',null);
  }
}

// ===================== STORAGE (localStorage fallback + Firestore) =====================
function save() {
  try { localStorage.setItem('mt4', JSON.stringify({
    settings:app.settings, notifications:app.notifications,
    savedAddresses:app.savedAddresses
  })); } catch(e) {}
  // Sync settings/addresses to Firestore
  if (window._saveSettings) window._saveSettings();
}
function load() {
  try {
    const d = JSON.parse(localStorage.getItem('mt4'));
    if (d) {
      app.settings = {...app.settings,...(d.settings||{})};
      app.notifications = d.notifications||[];
      app.savedAddresses = d.savedAddresses||{};
    }
  } catch(e) {}
}

// ===================== SYNC DOT =====================
function setSyncing(syncing) {
  const dot = document.getElementById('sync-dot');
  if (!dot) return;
  dot.className = 'sync-dot' + (syncing ? ' syncing' : '');
  dot.title = syncing ? 'Syncing...' : 'Synced to cloud';
}

// ===================== NAV =====================
function switchPage(p, btn) {
  if (p!=='settings') app.lastPage=p;
  document.querySelectorAll('.page').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
  document.getElementById('page-'+p).classList.add('active');
  if (btn) btn.classList.add('active');
  else { const n=document.getElementById('nav-'+p); if(n) n.classList.add('active'); }
  if (p==='trips') renderTrips();
  if (p==='dashboard') renderDashboard();
  if (p==='settings') renderSettings();
  if (p==='notifs') { renderNotifs(); updateNotifBadge(); }
}
function openSettings() { switchPage('settings'); }
function goBack() { switchPage(app.lastPage||'drive'); }
function showToast(msg) {
  const t=document.getElementById('toast'); t.textContent=msg;
  t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500);
}

// ===================== MAP =====================
let mapFilter = 'today';
let mapTripMarkers = [];
let mapTripLines = [];
let lastMonitorPos = null;

function openMap() {
  document.getElementById('map-overlay').classList.add('show');
  setTimeout(()=>{
    if (!leafletMap) {
      const defaultLat = lastMonitorPos ? lastMonitorPos.lat : 49.8951;
      const defaultLng = lastMonitorPos ? lastMonitorPos.lng : -97.1384;
      leafletMap = L.map('map-container', { zoomControl: false }).setView([defaultLat, defaultLng], 13);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{
        attribution:'&copy; OpenStreetMap &copy; CartoDB', maxZoom:19
      }).addTo(leafletMap);
      L.control.zoom({ position: 'topright' }).addTo(leafletMap);
    }
    leafletMap.invalidateSize();
    if (lastMonitorPos) {
      leafletMap.setView([lastMonitorPos.lat, lastMonitorPos.lng], 13);
      if (userMarker) userMarker.setLatLng([lastMonitorPos.lat, lastMonitorPos.lng]);
      else userMarker = L.circleMarker([lastMonitorPos.lat, lastMonitorPos.lng],{radius:8,fillColor:'#4F8EF7',fillOpacity:1,color:'white',weight:3}).addTo(leafletMap);
    }
    renderMapTrips();
  },150);
}
function closeMap() {
  document.getElementById('map-overlay').classList.remove('show');
  clearMapTripMarkers();
}
function setMapFilter(filter, btn) {
  mapFilter = filter;
  document.querySelectorAll('.map-filter-pill').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  renderMapTrips();
}
function getMapFilteredTrips() {
  const now = new Date();
  if (mapFilter==='today') return app.trips.filter(t=>new Date(t.date).toDateString()===now.toDateString());
  if (mapFilter==='week') { const w=new Date(now); w.setDate(w.getDate()-7); return app.trips.filter(t=>new Date(t.date)>=w); }
  if (mapFilter==='month') return app.trips.filter(t=>{const d=new Date(t.date);return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();});
  return [...app.trips];
}
function clearMapTripMarkers() {
  mapTripMarkers.forEach(m=>{if(leafletMap)leafletMap.removeLayer(m);});
  mapTripLines.forEach(l=>{if(leafletMap)leafletMap.removeLayer(l);});
  mapTripMarkers=[];mapTripLines=[];
}
function getCatColor(cat) { return cat==='business'?'#00D4AA':cat==='personal'?'#FF6B9D':'#FFB74D'; }
function renderMapTrips() {
  clearMapTripMarkers();
  const trips = getMapFilteredTrips();
  const bizMiles=trips.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0);
  const persMiles=trips.filter(t=>t.category==='personal').reduce((s,t)=>s+t.miles,0);
  const totalMiles=trips.reduce((s,t)=>s+t.miles,0);
  document.getElementById('map-trip-count').textContent=trips.length+' trip'+(trips.length!==1?'s':'');
  document.getElementById('map-trips-summary').innerHTML=`
    <div class="map-sum-card"><div class="val" style="color:#00D4AA">${bizMiles.toFixed(1)}</div><div class="lbl">Business mi</div></div>
    <div class="map-sum-card"><div class="val" style="color:#FF6B9D">${persMiles.toFixed(1)}</div><div class="lbl">Personal mi</div></div>
    <div class="map-sum-card"><div class="val">${totalMiles.toFixed(1)}</div><div class="lbl">Total mi</div></div>
    <div class="map-sum-card"><div class="val" style="color:var(--blue)">${trips.length}</div><div class="lbl">Trips</div></div>`;
  const listEl=document.getElementById('map-trips-list');
  if(!trips.length){listEl.innerHTML='<div style="text-align:center;padding:20px;color:#999;font-size:14px">No trips for this period</div>';return;}
  listEl.innerHTML=trips.map((t,i)=>{
    const time=new Date(t.date).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
    const dur=t.duration?Math.round(t.duration/60000):0;
    return `<div class="map-trip-item" id="map-trip-${i}" onclick="focusMapTrip(${i})">
      <div class="map-trip-dot ${t.category}"></div>
      <div class="map-trip-info"><div class="route">${esc(t.startName||'Start')} &rarr; ${esc(t.endName||'Dest')}</div><div class="meta">${time} &middot; ${t.category} &middot; ${dur}min</div></div>
      <div class="map-trip-miles"><div class="mi">${t.miles.toFixed(1)}</div><div class="unit">mi</div></div>
    </div>`;
  }).join('');
  const bounds=[];
  trips.forEach((t,i)=>{
    const color=getCatColor(t.category);
    if(t.startCoord){const m=L.circleMarker([t.startCoord.lat,t.startCoord.lng],{radius:6,fillColor:color,fillOpacity:0.8,color:'white',weight:2}).addTo(leafletMap);m.bindPopup(`<b>Start:</b> ${esc(t.startName||'Unknown')}<br><b>${t.category}</b> - ${t.miles.toFixed(1)} mi`);mapTripMarkers.push(m);bounds.push([t.startCoord.lat,t.startCoord.lng]);}
    if(t.endCoord){const m=L.circleMarker([t.endCoord.lat,t.endCoord.lng],{radius:9,fillColor:color,fillOpacity:1,color:'white',weight:3}).addTo(leafletMap);m.bindPopup(`<b>Dest:</b> ${esc(t.endName||'Unknown')}<br><b>${t.category}</b> - ${t.miles.toFixed(1)} mi`);mapTripMarkers.push(m);bounds.push([t.endCoord.lat,t.endCoord.lng]);}
    if(t.startCoord&&t.endCoord){const l=L.polyline([[t.startCoord.lat,t.startCoord.lng],[t.endCoord.lat,t.endCoord.lng]],{color,weight:4,opacity:0.8,dashArray:'8,5'}).addTo(leafletMap);mapTripLines.push(l);}
  });
  if(bounds.length>1)leafletMap.fitBounds(bounds,{padding:[40,40],maxZoom:13,animate:true});
  else if(bounds.length===1)leafletMap.setView(bounds[0],13);
  else if(lastMonitorPos)leafletMap.setView([lastMonitorPos.lat,lastMonitorPos.lng],13);
}
function focusMapTrip(index) {
  const trips=getMapFilteredTrips();const t=trips[index];if(!t)return;
  document.querySelectorAll('.map-trip-item').forEach(el=>el.classList.remove('selected'));
  const card=document.getElementById('map-trip-'+index);if(card)card.classList.add('selected');
  if(t.endCoord)leafletMap.flyTo([t.endCoord.lat,t.endCoord.lng],15,{duration:0.8});
  else if(t.startCoord)leafletMap.flyTo([t.startCoord.lat,t.startCoord.lng],15,{duration:0.8});
}
function toggleMapTripsPanel(){document.getElementById('map-trips-panel').classList.toggle('collapsed');}
function updateMapPosition(lat,lng){
  if(!leafletMap)return;
  if(userMarker)userMarker.setLatLng([lat,lng]);
  else userMarker=L.circleMarker([lat,lng],{radius:8,fillColor:'#4F8EF7',fillOpacity:1,color:'white',weight:3}).addTo(leafletMap);
  if(app.tracking&&trackPolyline)trackPolyline.addLatLng([lat,lng]);
}

// ===================== NOTIFICATIONS =====================
function addNotification(type,title,message,action){
  const n={id:Date.now().toString(),type,title,message,action:action||null,time:new Date().toISOString(),read:false};
  app.notifications.unshift(n);
  if(app.notifications.length>50)app.notifications=app.notifications.slice(0,50);
  save();updateNotifBadge();showNotifBanner(type,title,message);
}
function showNotifBanner(type,title,message){
  const icons={trip:'&#x1F697;',classify:'&#9888;&#65039;',report:'&#128202;',alert:'&#128276;'};
  document.getElementById('nb-icon').innerHTML=icons[type]||'&#128276;';
  document.getElementById('nb-title').textContent=title;
  document.getElementById('nb-msg').textContent=message;
  const b=document.getElementById('notif-banner');
  b.classList.add('show');setTimeout(()=>b.classList.remove('show'),5000);
}
function hideNotifBanner(){document.getElementById('notif-banner').classList.remove('show');}
function updateNotifBadge(){
  const u=app.notifications.filter(n=>!n.read).length;
  const b=document.getElementById('notif-badge');
  if(u>0){b.style.display='flex';b.textContent=u>9?'9+':u;}else{b.style.display='none';}
}
function renderNotifs(){
  app.notifications.forEach(n=>n.read=true);save();
  const list=document.getElementById('notif-list');
  if(!app.notifications.length){list.innerHTML='<div class="empty-state"><div class="icon">&#128276;</div><h3>No notifications</h3><p>Trip alerts will appear here</p></div>';return;}
  list.innerHTML=app.notifications.map(n=>{
    const icons={trip:'&#x1F697;',classify:'&#9888;&#65039;',report:'&#128202;',alert:'&#128276;'};
    const ago=timeAgo(new Date(n.time));
    let ab='';
    if(n.action==='classify')ab=`<button class="notif-action" onclick="switchPage('trips')">Classify Now</button>`;
    else if(n.action==='dashboard')ab=`<button class="notif-action" onclick="switchPage('dashboard')">View Dashboard</button>`;
    return `<div class="notif-card"><div class="notif-icon ${n.type}">${icons[n.type]||'&#128276;'}</div><div class="notif-body"><h4>${esc(n.title)}</h4><p>${esc(n.message)}</p><div class="time">${ago}</div>${ab}</div></div>`;
  }).join('');
}
function timeAgo(d){const s=Math.floor((Date.now()-d.getTime())/1000);if(s<60)return'Just now';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';}

// ===================== SAVED ADDRESSES =====================
function normalizeAddr(addr){return(addr||'').toLowerCase().trim().replace(/[^a-z0-9 ]/g,'');}
function getAddrCategory(addr){const key=normalizeAddr(addr);return app.savedAddresses[key]?app.savedAddresses[key].category:null;}
function saveAddrCategory(addr,category){
  const key=normalizeAddr(addr);if(!key)return;
  if(!app.savedAddresses[key])app.savedAddresses[key]={name:addr,category,count:1};
  else{app.savedAddresses[key].category=category;app.savedAddresses[key].count++;}
  save();
}
function autoClassifyTrip(trip){return getAddrCategory(trip.endName)||getAddrCategory(trip.startName)||null;}

// ===================== DISTANCE =====================
let calcTimeout=null;
function setupDistanceCalc(){
  const fromEl=document.getElementById('man-from');const toEl=document.getElementById('man-to');
  const handler=()=>{clearTimeout(calcTimeout);calcTimeout=setTimeout(()=>calcDistanceBetween(fromEl.value,toEl.value),800);};
  fromEl.addEventListener('input',handler);toEl.addEventListener('input',handler);
}
function calcDistanceBetween(from,to){
  if(!from||!to||from.length<3||to.length<3){document.getElementById('man-calc-dist').style.display='none';return;}
  document.getElementById('man-calc-dist').style.display='flex';
  document.getElementById('man-calc-text').textContent='Calculating distance...';
  Promise.all([geocodeAddress(from),geocodeAddress(to)]).then(([fc,tc])=>{
    if(fc&&tc){const dist=Math.round(haversine(fc.lat,fc.lon,tc.lat,tc.lon)*1.3*10)/10;document.getElementById('man-calc-text').textContent=`Estimated: ${dist} miles`;document.getElementById('man-miles').value=dist;}
    else document.getElementById('man-calc-text').textContent='Could not find address. Enter miles manually.';
  }).catch(()=>document.getElementById('man-calc-text').textContent='Distance lookup failed.');
}
function geocodeAddress(addr){
  return fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}&limit=1`)
    .then(r=>r.json()).then(d=>d.length?{lat:parseFloat(d[0].lat),lon:parseFloat(d[0].lon)}:null).catch(()=>null);
}

// ===================== GPS =====================
function onPos(p){
  const{latitude,longitude,speed,accuracy}=p.coords;const now=Date.now();
  if(accuracy<150)positions.push({lat:latitude,lng:longitude,time:now,speed,accuracy});
  const dist=calcDistance();
  document.getElementById('live-miles').textContent=dist<1?dist.toFixed(2):dist.toFixed(1);
}
function calcDistance(){if(positions.length<2)return 0;let t=0;for(let i=1;i<positions.length;i++)t+=haversine(positions[i-1].lat,positions[i-1].lng,positions[i].lat,positions[i].lng);return t;}
function haversine(lat1,lon1,lat2,lon2){const R=3959,dLat=rad(lat2-lat1),dLon=rad(lon2-lon1);const a=Math.sin(dLat/2)**2+Math.cos(rad(lat1))*Math.cos(rad(lat2))*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}
function rad(d){return d*Math.PI/180;}
function updateDuration(){if(!trackStart)return;const e=Date.now()-trackStart;const h=Math.floor(e/3600000),m=Math.floor((e%3600000)/60000);document.getElementById('live-duration').textContent=h>0?`${h}h${m}m`:`${m}m`;}
function reverseGeocode(lat,lng,cb){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
    .then(r=>r.json()).then(d=>{const a=d.address||{};const parts=[];if(a.house_number&&a.road)parts.push(a.house_number+' '+a.road);else if(a.road)parts.push(a.road);else if(a.building||a.amenity)parts.push(a.building||a.amenity);if(a.suburb||a.neighbourhood)parts.push(a.suburb||a.neighbourhood);if(a.city||a.town||a.village)parts.push(a.city||a.town||a.village);cb(parts.join(', ')||'Unknown Location');}).catch(()=>cb('Unknown Location'));
}
function updateHomeStats(){
  const now=new Date();
  const mTrips=app.trips.filter(t=>{const d=new Date(t.date);return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();});
  const biz=mTrips.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0);
  const pers=mTrips.filter(t=>t.category==='personal').reduce((s,t)=>s+t.miles,0);
  document.getElementById('s-biz').textContent=biz.toFixed(1)+' mi';
  document.getElementById('s-pers').textContent=pers.toFixed(1)+' mi';
  document.getElementById('s-ded').textContent='$'+(biz*app.settings.irsRate).toFixed(2);
  document.getElementById('s-trips').textContent=mTrips.length;
  const uncl=app.trips.filter(t=>t.category==='unclassified').length;
  const banner=document.getElementById('uncl-banner');
  if(uncl>0){banner.classList.add('show');document.getElementById('uncl-text').textContent=`${uncl} trip${uncl!==1?'s':''} to classify.`;}
  else{banner.classList.remove('show');}
}

// ===================== TRIPS =====================
function filterTrips(f,btn){
  app.tripFilter=f;
  document.querySelectorAll('.filter-tab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  renderTrips();
}
function renderTrips(){
  let trips=[...app.trips];
  if(app.tripFilter!=='all')trips=trips.filter(t=>t.category===app.tripFilter);
  const list=document.getElementById('trips-list');const empty=document.getElementById('trips-empty');
  if(!trips.length){list.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  const groups={};
  trips.forEach(t=>{const d=new Date(t.date);const key=d.toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'});if(!groups[key])groups[key]=[];groups[key].push(t);});
  let html='';
  for(const[date,dayTrips]of Object.entries(groups)){
    const dayTotal=dayTrips.reduce((s,x)=>s+x.miles,0);
    html+=`<div class="trip-date-header">${date} <span style="float:right;color:var(--text3);font-weight:400">${dayTrips.length} trip${dayTrips.length!==1?'s':''} &middot; ${dayTotal.toFixed(1)} mi</span></div>`;
    dayTrips.forEach(t=>{
      const d=new Date(t.date);const timeStr=d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
      const dur=t.duration?Math.round(t.duration/60000):0;
      const fromAddr=t.startName||'Start';const toAddr=t.endName||'Destination';
      const deduction=t.category==='business'?(t.miles*app.settings.irsRate).toFixed(2):'0.00';
      const bizSel=t.category==='business'?' sel-biz':'';const persSel=t.category==='personal'?' sel-pers':'';
      const catLabel=t.category==='business'?'Business':t.category==='personal'?'Personal':'Classify';
      const catColorSolid=t.category==='business'?'#00D4AA':t.category==='personal'?'#FF6B9D':'#FFB74D';
      const catColorAlpha=t.category==='business'?'rgba(0,212,170,':'rgba(255,107,157,';
      const seed=(t.id?parseInt(t.id)%100:50)/100;const curveY=30+seed*40;
      const miniMapHtml=`<div class="trip-mini-map" style="background:linear-gradient(135deg,${catColorAlpha}0.06) 0%,rgba(10,10,26,0.95) 100%)">
        <svg width="100%" height="100%" viewBox="0 0 400 100" preserveAspectRatio="none" style="position:absolute;inset:0">
          <defs><linearGradient id="rg${t.id}" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#00E676;stop-opacity:0.6"/><stop offset="100%" style="stop-color:${catColorSolid};stop-opacity:0.6"/></linearGradient></defs>
          <path d="M 30 70 Q 120 ${curveY} 200 50 Q 280 ${100-curveY} 370 30" fill="none" stroke="url(#rg${t.id})" stroke-width="2.5" stroke-dasharray="6,4" opacity="0.7"/>
          <circle cx="30" cy="70" r="5" fill="#00E676" opacity="0.9"/>
          <circle cx="370" cy="30" r="5" fill="#FF5252" opacity="0.9"/>
        </svg>
        <div style="position:absolute;bottom:8px;left:12px;font-size:10px;color:var(--text3);font-weight:500">${t.miles.toFixed(1)} miles</div>
        <div class="map-category-badge ${t.category}">${catLabel}</div>
      </div>`;
      html+=`<div class="trip-card" onclick="editTrip('${t.id}')">
        ${miniMapHtml}
        <div class="trip-route-section">
          <div class="trip-route-row">
            <div class="trip-route-dots"><div class="route-dot start"></div><div class="route-line"></div><div class="route-dot end"></div></div>
            <div class="trip-route-addrs"><div class="trip-addr from">${esc(fromAddr)}</div><div class="trip-addr to">${esc(toAddr)}</div></div>
            <div class="trip-miles-badge"><div class="mi-val">${t.miles.toFixed(1)}</div><div class="mi-unit">miles</div></div>
          </div>
        </div>
        <div class="trip-meta-row">
          <div class="trip-meta-left">
            <span>${timeStr}</span><span>${dur}min</span>
            ${t.category==='business'?`<span class="trip-deduction">+$${deduction}</span>`:''}
          </div>
        </div>
        <div class="trip-classify" onclick="event.stopPropagation()">
          <button class="classify-btn${bizSel}" onclick="setCat('${t.id}','business')"><span class="dot"></span> Business</button>
          <button class="classify-btn${persSel}" onclick="setCat('${t.id}','personal')"><span class="dot"></span> Personal</button>
        </div>
      </div>`;
    });
  }
  list.innerHTML=html;
}
function setCat(id,cat){
  const t=app.trips.find(x=>x.id===id);if(!t)return;
  t.category=cat;
  setSyncing(true);
  if(window._saveTrip){window._saveTrip(t).then(()=>setSyncing(false));}
  save();renderTrips();updateHomeStats();
}
function editTrip(id){
  const t=app.trips.find(x=>x.id===id);if(!t)return;
  app.editId=id;
  document.getElementById('ed-name').value=t.name||`${t.startName||'Start'} \u2192 ${t.endName||'Destination'}`;
  document.getElementById('ed-cat').value=t.category;
  document.getElementById('ed-miles').value=t.miles;
  document.getElementById('ed-notes').value=t.notes||'';
  document.getElementById('edit-modal').classList.add('show');
}
function closeModal(){document.getElementById('edit-modal').classList.remove('show');}
function openManualTrip(){
  document.getElementById('man-from').value='';document.getElementById('man-to').value='';
  document.getElementById('man-miles').value='';
  document.getElementById('man-cat').value=app.settings.defaultCat||'business';
  document.getElementById('man-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('man-notes').value='';
  document.getElementById('man-calc-dist').style.display='none';
  document.getElementById('manual-modal').classList.add('show');
}
function closeManualModal(){document.getElementById('manual-modal').classList.remove('show');}
function saveManualTrip(){
  const miles=parseFloat(document.getElementById('man-miles').value);
  if(!miles||miles<=0){showToast('Please enter miles');return;}
  const from=document.getElementById('man-from').value||'Start';
  const to=document.getElementById('man-to').value||'Destination';
  const dateVal=document.getElementById('man-date').value;
  const d=dateVal?new Date(dateVal+'T12:00:00'):new Date();
  const dur=Math.round(miles*2.5*60000);
  let cat=document.getElementById('man-cat').value;
  const savedCat=getAddrCategory(to)||getAddrCategory(from);
  if(savedCat&&cat==='unclassified')cat=savedCat;
  const trip={id:Date.now().toString(),category:cat,miles,date:d.toISOString(),duration:dur,startTime:d.toISOString(),endTime:new Date(d.getTime()+dur).toISOString(),startName:from,endName:to,name:'',notes:document.getElementById('man-notes').value,startCoord:null,endCoord:null};
  app.trips.unshift(trip);
  setSyncing(true);
  if(window._saveTrip)window._saveTrip(trip).then(()=>setSyncing(false));
  save();closeManualModal();updateHomeStats();
  showToast(`Trip added: ${miles} miles`);
  if(app.settings.tripAlerts)addNotification('trip','Trip Added',`${from} \u2192 ${to}: ${miles} miles`,null);
}
function saveEditTrip(){
  const t=app.trips.find(x=>x.id===app.editId);if(!t)return;
  t.name=document.getElementById('ed-name').value;t.category=document.getElementById('ed-cat').value;
  t.miles=parseFloat(document.getElementById('ed-miles').value)||t.miles;t.notes=document.getElementById('ed-notes').value;
  setSyncing(true);
  if(window._saveTrip)window._saveTrip(t).then(()=>setSyncing(false));
  save();closeModal();renderTrips();updateHomeStats();showToast('Trip updated');
}
function deleteTrip(){
  if(!confirm('Delete this trip?'))return;
  const id=app.editId;
  app.trips=app.trips.filter(x=>x.id!==id);
  setSyncing(true);
  if(window._deleteTrip)window._deleteTrip(id).then(()=>setSyncing(false));
  save();closeModal();renderTrips();updateHomeStats();showToast('Trip deleted');
}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}

// ===================== DASHBOARD =====================
function setDashPeriod(p,btn){
  app.dashPeriod=p;document.querySelectorAll('.period-pill').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');renderDashboard();
}
function renderDashboard(){
  const now=new Date();const dc=document.getElementById('dash-content');let filtered=[];
  if(app.dashPeriod==='day'){filtered=app.trips.filter(t=>new Date(t.date).toDateString()===now.toDateString());renderDayView(dc,filtered,now);return;}
  else if(app.dashPeriod==='week'){const wa=new Date(now);wa.setDate(wa.getDate()-7);filtered=app.trips.filter(t=>new Date(t.date)>=wa);}
  else if(app.dashPeriod==='month')filtered=app.trips.filter(t=>{const d=new Date(t.date);return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();});
  else filtered=app.trips.filter(t=>new Date(t.date).getFullYear()===now.getFullYear());
  const biz=filtered.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0);
  const pers=filtered.filter(t=>t.category==='personal').reduce((s,t)=>s+t.miles,0);
  const uncl=filtered.filter(t=>t.category==='unclassified').reduce((s,t)=>s+t.miles,0);
  const total=biz+pers+uncl;
  const periodLabel=app.dashPeriod==='week'?'This Week':app.dashPeriod==='month'?now.toLocaleDateString('en-US',{month:'long',year:'numeric'}):'Year '+now.getFullYear();
  let html=`<div class="dash-card"><div class="dash-card-title">${periodLabel} Summary</div><div class="summary-row"><div class="summary-item"><div class="val biz">${Math.round(biz)}</div><div class="lbl">Business mi</div></div><div class="summary-item"><div class="val pers">${Math.round(pers)}</div><div class="lbl">Personal mi</div></div><div class="summary-item"><div class="val total">${Math.round(total)}</div><div class="lbl">Total mi</div></div></div></div>`;
  html+=`<div class="dash-card"><div class="dash-card-title">Breakdown</div><div class="breakdown-bar">${total>0?`<div class="seg biz" style="width:${(biz/total*100).toFixed(0)}%"></div><div class="seg pers" style="width:${(pers/total*100).toFixed(0)}%"></div><div class="seg uncl" style="width:${(uncl/total*100).toFixed(0)}%"></div>`:'<div class="seg" style="width:100%;background:var(--bg)"></div>'}</div><div class="breakdown-legend">${total>0?`<div class="legend-item"><span class="legend-dot" style="background:var(--blue)"></span>Business ${(biz/total*100).toFixed(0)}%</div><div class="legend-item"><span class="legend-dot" style="background:var(--purple)"></span>Personal ${(pers/total*100).toFixed(0)}%</div>`:'<div class="legend-item" style="color:var(--text3)">No data</div>'}</div></div>`;
  html+=`<div class="dash-card tax-card"><h4>&#x1F4B0; Estimated Tax Deduction</h4><div class="tax-amount">$${(biz*app.settings.irsRate).toFixed(2)}</div><div class="tax-detail">${biz.toFixed(1)} business miles at $${app.settings.irsRate.toFixed(2)}/mile</div></div>`;
  // Top destinations
  const destCounts={};
  filtered.forEach(t=>{const dest=t.endName||'Unknown';if(!destCounts[dest])destCounts[dest]={count:0,miles:0,cat:t.category};destCounts[dest].count++;destCounts[dest].miles+=t.miles;});
  const topDests=Object.entries(destCounts).sort((a,b)=>b[1].count-a[1].count).slice(0,5);
  if(topDests.length){html+=`<div class="dash-card"><div class="dash-card-title">Top Destinations</div>`;topDests.forEach(([dest,info])=>{const cc=info.cat==='business'?'var(--blue)':info.cat==='personal'?'var(--purple)':'var(--orange)';html+=`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--card-border)"><div style="width:8px;height:8px;border-radius:50%;background:${cc};flex-shrink:0"></div><div style="flex:1"><div style="font-size:14px;font-weight:500">${esc(dest)}</div><div style="font-size:11px;color:var(--text2)">${info.count} trips &middot; ${info.miles.toFixed(1)} mi</div></div></div>`;});html+=`</div>`;}
  html+=`<div class="dash-card"><div class="dash-card-title">${app.dashPeriod==='year'?'Monthly Breakdown':'Mileage Chart'}</div><div class="chart-area" id="chart-area"></div><div style="display:flex;justify-content:space-around;margin-top:4px" id="chart-xlabels"></div><div style="display:flex;justify-content:center;gap:16px;margin-top:10px;font-size:12px;color:var(--text2)"><span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--blue);margin-right:4px"></span>Business</span><span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--purple);margin-right:4px"></span>Personal</span></div></div>`;
  html+=`<div class="dash-card"><div class="dash-card-title">Export Report</div><div class="export-btns"><button class="btn-exp" onclick="exportCSV()">&#128196; CSV</button><button class="btn-exp" onclick="exportPDF()">&#128462; PDF</button></div></div>`;
  dc.innerHTML=html;renderChart(filtered);
}
function renderDayView(dc,trips,date){
  const biz=trips.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0);
  const pers=trips.filter(t=>t.category==='personal').reduce((s,t)=>s+t.miles,0);
  const total=biz+pers+trips.filter(t=>t.category==='unclassified').reduce((s,t)=>s+t.miles,0);
  let html=`<div class="dash-card"><div class="dash-card-title">${date.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'})}</div><div class="summary-row"><div class="summary-item"><div class="val biz">${biz.toFixed(1)}</div><div class="lbl">Business</div></div><div class="summary-item"><div class="val pers">${pers.toFixed(1)}</div><div class="lbl">Personal</div></div><div class="summary-item"><div class="val total">${total.toFixed(1)}</div><div class="lbl">Total mi</div></div></div></div>`;
  html+=`<div class="add-trip-form"><h4>&#x2795; Quick Add Trip</h4><div class="form-row"><label>From</label><input type="text" id="day-from" placeholder="From address"></div><div class="form-row"><label>To</label><input type="text" id="day-to" placeholder="To address"></div><div id="day-calc-dist" style="display:none" class="calc-distance"><span>&#x1F4CD;</span><span id="day-calc-text">Calculating...</span></div><div class="form-row-inline"><div class="form-row"><label>Miles</label><input type="number" id="day-miles" step="0.1" placeholder="Auto or manual"></div><div class="form-row"><label>Category</label><select id="day-cat"><option value="business">Business</option><option value="personal">Personal</option></select></div></div><div class="form-btns"><button class="fbtn-save" onclick="addDayTrip()">Add Trip</button></div></div>`;
  if(trips.length){html+=`<div class="dash-card-title" style="padding:8px 4px">Today's Trips (${trips.length})</div>`;trips.forEach(t=>{const timeStr=new Date(t.date).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});const cc=t.category==='business'?'biz':t.category==='personal'?'pers':'uncl';html+=`<div class="day-trip-row"><div class="cat-dot ${cc}"></div><div class="route-info"><div class="addr">${esc(t.startName||'Start')} &rarr; ${esc(t.endName||'Dest')}</div><div class="meta">${timeStr} &middot; ${t.category} &middot; ${t.duration?Math.round(t.duration/60000)+'min':'--'}</div></div><div class="miles-col"><div class="mi">${t.miles.toFixed(1)}</div><div class="lbl">miles</div></div></div>`;});}
  else html+=`<div class="empty-state" style="padding:30px"><div class="icon">&#128663;</div><h3>No trips today</h3><p>Add a trip above or start driving</p></div>`;
  dc.innerHTML=html;
  setTimeout(()=>{const fe=document.getElementById('day-from');const te=document.getElementById('day-to');if(fe&&te){let dt=null;const h=()=>{clearTimeout(dt);dt=setTimeout(()=>calcDayDist(fe.value,te.value),800);};fe.addEventListener('input',h);te.addEventListener('input',h);}},100);
}
function calcDayDist(from,to){
  if(!from||!to||from.length<3||to.length<3){document.getElementById('day-calc-dist').style.display='none';return;}
  document.getElementById('day-calc-dist').style.display='flex';document.getElementById('day-calc-text').textContent='Calculating distance...';
  Promise.all([geocodeAddress(from),geocodeAddress(to)]).then(([fc,tc])=>{if(fc&&tc){const dist=Math.round(haversine(fc.lat,fc.lon,tc.lat,tc.lon)*1.3*10)/10;document.getElementById('day-calc-text').textContent=`Estimated: ${dist} miles`;document.getElementById('day-miles').value=dist;}else document.getElementById('day-calc-text').textContent='Address not found.';}).catch(()=>document.getElementById('day-calc-text').textContent='Lookup failed.');
}
function addDayTrip(){
  const miles=parseFloat(document.getElementById('day-miles').value);if(!miles||miles<=0){showToast('Enter miles');return;}
  const from=document.getElementById('day-from').value||'Start';const to=document.getElementById('day-to').value||'Destination';
  let cat=document.getElementById('day-cat').value;const savedCat=getAddrCategory(to)||getAddrCategory(from);if(savedCat)cat=savedCat;
  const now=new Date();
  const trip={id:Date.now().toString(),category:cat,miles,date:now.toISOString(),duration:Math.round(miles*2.5*60000),startTime:now.toISOString(),endTime:new Date(now.getTime()+Math.round(miles*2.5*60000)).toISOString(),startName:from,endName:to,name:'',notes:'',startCoord:null,endCoord:null};
  app.trips.unshift(trip);
  setSyncing(true);if(window._saveTrip)window._saveTrip(trip).then(()=>setSyncing(false));
  save();updateHomeStats();showToast(`Added: ${from} \u2192 ${to} (${miles} mi)`);renderDashboard();
}
function renderChart(trips){
  const chart=document.getElementById('chart-area');const labels=document.getElementById('chart-xlabels');if(!chart)return;
  let buckets=[];
  if(app.dashPeriod==='week'){const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const dt=trips.filter(t=>new Date(t.date).toDateString()===d.toDateString());buckets.push({label:days[d.getDay()],biz:dt.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0),pers:dt.filter(t=>t.category!=='business').reduce((s,t)=>s+t.miles,0)});}}
  else if(app.dashPeriod==='month'){const now=new Date();const weeks=Math.ceil(new Date(now.getFullYear(),now.getMonth()+1,0).getDate()/7);for(let w=0;w<weeks;w++){const wt=trips.filter(t=>Math.floor((new Date(t.date).getDate()-1)/7)===w);buckets.push({label:'W'+(w+1),biz:wt.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0),pers:wt.filter(t=>t.category!=='business').reduce((s,t)=>s+t.miles,0)});}}
  else{const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];for(let m=0;m<12;m++){const mt=trips.filter(t=>new Date(t.date).getMonth()===m);buckets.push({label:months[m],biz:mt.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0),pers:mt.filter(t=>t.category!=='business').reduce((s,t)=>s+t.miles,0)});}}
  const maxH=150,maxVal=Math.max(...buckets.map(b=>b.biz+b.pers),1);
  chart.innerHTML=buckets.map(b=>`<div class="chart-col"><div class="chart-stack"><div class="chart-seg pers" style="height:${(b.pers/maxVal)*maxH}px"></div><div class="chart-seg biz" style="height:${(b.biz/maxVal)*maxH}px"></div></div></div>`).join('');
  labels.innerHTML=buckets.map(b=>`<span style="flex:1;text-align:center;font-size:9px;color:var(--text3)">${b.label}</span>`).join('');
}

// ===================== EXPORT =====================
function exportCSV(){
  if(!app.trips.length){showToast('No trips');return;}
  const h='Date,Start Time,End Time,Category,Miles,Duration (min),From,To,Notes';
  const rows=app.trips.map(t=>{const d=new Date(t.date);return[d.toLocaleDateString(),t.startTime?new Date(t.startTime).toLocaleTimeString():'',t.endTime?new Date(t.endTime).toLocaleTimeString():'',t.category,t.miles.toFixed(2),t.duration?Math.round(t.duration/60000):'',`"${(t.startName||'').replace(/"/g,'""')}"`,`"${(t.endName||'').replace(/"/g,'""')}"`,`"${(t.notes||'').replace(/"/g,'""')}"`].join(',');});
  dl('MileTracker_Export.csv',h+'\n'+rows.join('\n'),'text/csv');showToast('CSV exported');
}
function exportPDF(){
  if(!app.trips.length){showToast('No trips');return;}
  const biz=app.trips.filter(t=>t.category==='business').reduce((s,t)=>s+t.miles,0);
  const pers=app.trips.filter(t=>t.category==='personal').reduce((s,t)=>s+t.miles,0);
  const ded=biz*app.settings.irsRate;
  let html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>MileTracker Report</title><style>body{font-family:-apple-system,sans-serif;padding:40px;color:#1a1a2e;max-width:800px;margin:0 auto}h1{color:#007AFF;border-bottom:3px solid #007AFF;padding-bottom:10px}.sum{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin:24px 0;padding:24px;background:#f0f4ff;border-radius:12px}.si{text-align:center}.sv{font-size:32px;font-weight:800}.sl{font-size:12px;color:#666;text-transform:uppercase;margin-top:4px}table{width:100%;border-collapse:collapse;margin:20px 0}th{background:#007AFF;color:white;padding:10px;text-align:left;font-size:12px}td{padding:8px 10px;border-bottom:1px solid #eee;font-size:13px}tr:nth-child(even){background:#f8f9ff}</style></head><body><h1>MileTracker Report</h1><p>Generated: ${new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}</p><div class="sum"><div class="si"><div class="sv" style="color:#007AFF">${biz.toFixed(1)}</div><div class="sl">Business Miles</div></div><div class="si"><div class="sv" style="color:#AF52DE">${pers.toFixed(1)}</div><div class="sl">Personal Miles</div></div><div class="si"><div class="sv" style="color:#34C759">$${ded.toFixed(2)}</div><div class="sl">Tax Deduction</div></div></div><table><thead><tr><th>Date</th><th>Category</th><th>From</th><th>To</th><th>Miles</th><th>Duration</th></tr></thead><tbody>`;
  app.trips.forEach(t=>{const d=new Date(t.date);html+=`<tr><td>${d.toLocaleDateString()}</td><td>${t.category}</td><td>${esc(t.startName||'')}</td><td>${esc(t.endName||'')}</td><td>${t.miles.toFixed(2)}</td><td>${t.duration?Math.round(t.duration/60000)+'m':'--'}</td></tr>`;});
  html+='</tbody></table></body></html>';
  const w=window.open('','_blank');w.document.write(html);w.document.close();setTimeout(()=>w.print(),500);
}
function dl(name,content,type){const b=new Blob([content],{type});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=name;a.click();URL.revokeObjectURL(u);}

// ===================== SETTINGS =====================
function renderSettings(){
  // User profile section
  const user = window._currentUser;
  const profileSection = document.getElementById('user-profile-section');
  if (user) {
    const initials = (user.displayName||user.email||'?').split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
    const avatarHtml = user.photoURL ? `<img src="${user.photoURL}" alt="${user.displayName}">` : initials;
    profileSection.innerHTML = `
      <div class="user-profile-card">
        <div class="user-profile-avatar">${avatarHtml}</div>
        <div class="user-profile-info" style="flex:1">
          <h4>${esc(user.displayName||'User')}</h4>
          <p>${esc(user.email||'')}</p>
          <div class="sync-badge">Synced to cloud</div>
        </div>
        <button class="btn-signout" onclick="window._signOut()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
          Sign Out
        </button>
      </div>`;
  }
  document.getElementById('tog-auto').className='toggle'+(app.settings.autoDetect?' on':'');
  document.getElementById('tog-tripalert').className='toggle'+(app.settings.tripAlerts?' on':'');
  document.getElementById('tog-classify').className='toggle'+(app.settings.classifyReminders?' on':'');
  document.getElementById('tog-weekly').className='toggle'+(app.settings.weeklySummary?' on':'');
  document.getElementById('set-defcat').value=app.settings.defaultCat;
  document.getElementById('set-speed').value=app.settings.speedThreshold;
  document.getElementById('set-irs').value=app.settings.irsRate.toFixed(2);
  document.getElementById('set-count').textContent=app.trips.length+' trips';
  const sal=document.getElementById('saved-addresses-list');
  const addrs=Object.entries(app.savedAddresses);
  if(!addrs.length)sal.innerHTML='<div class="setting-row"><div class="info"><h4>No saved addresses</h4><p>Addresses are learned from your trips</p></div></div>';
  else sal.innerHTML=addrs.map(([k,v])=>`<div class="setting-row"><div class="info"><h4>${esc(v.name)}</h4><p>${v.category} &middot; ${v.count} trips</p></div><button class="btn-danger" onclick="deleteAddr('${k}')" style="padding:4px 10px;font-size:12px">Remove</button></div>`).join('');
}
function deleteAddr(key){delete app.savedAddresses[key];save();renderSettings();}
function toggleSetting(key){app.settings[key]=!app.settings[key];save();renderSettings();}
function updateSetting(type){
  if(type==='defaultCat')app.settings.defaultCat=document.getElementById('set-defcat').value;
  if(type==='speed')app.settings.speedThreshold=parseInt(document.getElementById('set-speed').value)||5;
  if(type==='irs')app.settings.irsRate=parseFloat(document.getElementById('set-irs').value)||IRS_RATE_2026;
  save();
}
function clearAllData(){
  if(!confirm('Delete ALL trips?'))return;
  app.trips=[];app.notifications=[];app.savedAddresses={};
  if(window._clearAllFirestore)window._clearAllFirestore();
  save();updateHomeStats();renderSettings();showToast('All data cleared');
}

// ===================== ALWAYS-ON GPS MONITOR =====================
let monitorWatchId=null,pollTimer=null,speedHistory=[],stopCounter=0;
let lastMonitorTime=null,gpsReady=false,positionCount=0;
const DRIVE_DETECT_COUNT=2,STOP_DETECT_COUNT=12;

function debugLog(msg){const el=document.getElementById('gps-debug');if(!el)return;const t=new Date().toLocaleTimeString();el.innerHTML=`[${t}] ${msg}<br>`+el.innerHTML;if(el.children.length>20)el.innerHTML=el.innerHTML.split('<br>').slice(0,15).join('<br>');}
function calcSpeedBetween(lat1,lon1,t1,lat2,lon2,t2){const d=haversine(lat1,lon1,lat2,lon2);const h=(t2-t1)/3600000;return h<=0?0:d/h;}
function setGPS(status){
  const dot=document.getElementById('gps-dot'),text=document.getElementById('gps-text');
  dot.className='status-dot';dot.style.background='';
  if(status==='monitoring'){dot.classList.add('active');text.textContent='GPS Active \u2022 Always On';}
  else if(status==='recording'){dot.style.background='var(--red)';text.textContent='Recording Trip...';}
  else if(status==='searching'){dot.classList.add('searching');text.textContent='Acquiring GPS...';}
  else if(status==='error'){dot.classList.add('error');text.textContent='GPS Error';}
}
function startAlwaysOnMonitor(){
  if(!navigator.geolocation){setGPS('error');debugLog('No Geolocation API');return;}
  debugLog('Starting GPS...');setGPS('searching');
  document.getElementById('drive-sublabel').textContent='Requesting GPS access...';
  try{monitorWatchId=navigator.geolocation.watchPosition(handlePosition,handleError,{enableHighAccuracy:true,maximumAge:2000,timeout:10000});debugLog('watchPosition ID:'+monitorWatchId);}catch(e){debugLog('watchPosition failed:'+e.message);}
  startPolling();
  setTimeout(()=>{if(!gpsReady){debugLog('No GPS 5s - show button');document.getElementById('gps-activate').style.display='block';document.getElementById('drive-sublabel').textContent='Tap button below to activate GPS.';}},5000);
}
function startPolling(){if(pollTimer)clearInterval(pollTimer);pollTimer=setInterval(()=>{navigator.geolocation.getCurrentPosition(handlePosition,(e)=>{debugLog('Poll:'+e.message);},{enableHighAccuracy:true,maximumAge:1000,timeout:8000});},3000);debugLog('Polling started');}
function activateGPS(){
  debugLog('Manual activate');document.getElementById('gps-activate').style.display='none';
  document.getElementById('drive-sublabel').textContent='Activating GPS...';
  if(monitorWatchId!==null)navigator.geolocation.clearWatch(monitorWatchId);
  if(pollTimer)clearInterval(pollTimer);
  navigator.geolocation.getCurrentPosition(
    (pos)=>{debugLog('Manual OK');handlePosition(pos);monitorWatchId=navigator.geolocation.watchPosition(handlePosition,handleError,{enableHighAccuracy:true,maximumAge:2000,timeout:10000});startPolling();},
    (err)=>{debugLog('Manual FAIL:'+err.message);if(err.code===1)updateDriveUI('denied');else{document.getElementById('drive-sublabel').textContent='GPS error. Try again.';document.getElementById('gps-activate').style.display='block';}},
    {enableHighAccuracy:true,maximumAge:0,timeout:15000}
  );
}
function updateDriveUI(state){
  const circle=document.getElementById('drive-circle'),icon=document.getElementById('drive-icon'),label=document.getElementById('drive-label'),sub=document.getElementById('drive-sublabel');
  circle.className='drive-circle';
  if(state==='monitoring'){circle.classList.add('monitoring');icon.innerHTML='&#x1F7E2;';label.textContent='Always On';label.style.color='var(--green)';sub.textContent='GPS monitoring active. Trips auto-detect when you drive.';}
  else if(state==='recording'){circle.classList.add('recording');icon.innerHTML='&#x1F534;';label.textContent='Recording Trip';label.style.color='var(--red)';sub.textContent='Driving detected. Will auto-save when you stop.';}
  else if(state==='saved'){circle.classList.add('monitoring');icon.innerHTML='&#x2705;';label.textContent='Trip Saved!';label.style.color='var(--green)';}
  else if(state==='denied'){circle.classList.add('inactive');icon.innerHTML='&#x274C;';label.textContent='Location Denied';label.style.color='var(--red)';sub.textContent='Allow location in browser settings and refresh.';}
}
function handlePosition(pos){
  const{latitude,longitude,speed,accuracy}=pos.coords;const now=Date.now();positionCount++;
  if(!gpsReady){gpsReady=true;document.getElementById('gps-activate').style.display='none';debugLog('GPS READY');updateDriveUI('monitoring');}
  let gpsSpeed=(speed!==null&&speed>=0)?speed*2.237:0;let calcSpeed=0;
  if(lastMonitorPos&&lastMonitorTime&&(now-lastMonitorTime)>500){calcSpeed=calcSpeedBetween(lastMonitorPos.lat,lastMonitorPos.lng,lastMonitorTime,latitude,longitude,now);if(calcSpeed>200)calcSpeed=0;}
  const mph=Math.max(gpsSpeed,calcSpeed);
  if(accuracy>300){debugLog('Skip acc:'+Math.round(accuracy));return;}
  lastMonitorPos={lat:latitude,lng:longitude};lastMonitorTime=now;
  document.getElementById('idle-speed').textContent=Math.round(mph);
  document.getElementById('idle-accuracy').textContent=`GPS: \u00B1${Math.round(accuracy)}m | #${positionCount}`;
  updateMapPosition(latitude,longitude);
  if(!app.tracking){
    setGPS('monitoring');
    if(mph>app.settings.speedThreshold){speedHistory.push(mph);if(speedHistory.length>=DRIVE_DETECT_COUNT){speedHistory=[];stopCounter=0;showToast('Driving detected!');debugLog('=== TRIP START ===');autoStartTracking(pos);}}
    else{if(mph<app.settings.speedThreshold*0.5)speedHistory=[];}
  } else {
    onPos(pos);document.getElementById('live-speed').textContent=Math.round(mph)+' mph';
    if(mph<3){stopCounter++;if(stopCounter>=STOP_DETECT_COUNT){stopCounter=0;debugLog('=== TRIP END ===');stopTracking();}}else{stopCounter=0;}
  }
}
function handleError(err){
  debugLog('GPS Error:'+err.code+' '+err.message);
  if(err.code===1){setGPS('error');updateDriveUI('denied');}
  else{document.getElementById('drive-sublabel').textContent='GPS unavailable. Try again.';document.getElementById('gps-activate').style.display='block';}
}
function autoStartTracking(initialPos){
  app.tracking=true;positions=[];trackStart=Date.now();
  const{latitude,longitude,speed,accuracy}=initialPos.coords;
  if(accuracy<150)positions.push({lat:latitude,lng:longitude,time:Date.now(),speed,accuracy});
  updateDriveUI('recording');setGPS('recording');
  document.getElementById('idle-speed-wrap').style.display='none';document.getElementById('idle-accuracy').style.display='none';
  document.getElementById('live-panel').classList.add('show');
  document.getElementById('live-miles').textContent='0.0';document.getElementById('live-duration').textContent='0m';
  trackTimer=setInterval(updateDuration,1000);
  if(leafletMap){trackPolyline=L.polyline([],{color:'#FF5252',weight:4}).addTo(leafletMap);trackPolyline.addLatLng([latitude,longitude]);}
  if(app.settings.tripAlerts)addNotification('trip','Trip Started','Driving detected. Auto-recording.',null);
}
function stopTracking(){
  app.tracking=false;
  if(watchId!==null){navigator.geolocation.clearWatch(watchId);watchId=null;}
  if(trackTimer){clearInterval(trackTimer);trackTimer=null;}
  const miles=calcDistance();const dur=Date.now()-trackStart;
  const startPt=positions.length>0?positions[0]:null;const endPt=positions.length>1?positions[positions.length-1]:null;
  const saveMiles=miles>0?Math.round(miles*100)/100:0;
  const trip={id:Date.now().toString(),category:'unclassified',miles:saveMiles,date:new Date().toISOString(),duration:dur,startTime:new Date(trackStart).toISOString(),endTime:new Date().toISOString(),startName:'Locating...',endName:'Locating...',name:'',notes:'',startCoord:startPt?{lat:startPt.lat,lng:startPt.lng}:null,endCoord:endPt?{lat:endPt.lat,lng:endPt.lng}:null};
  if(saveMiles<0.1){debugLog('Trip too short, discarding');document.getElementById('live-panel').classList.remove('show');document.getElementById('idle-speed-wrap').style.display='';document.getElementById('idle-accuracy').style.display='';updateDriveUI('monitoring');setGPS('monitoring');stopCounter=0;speedHistory=[];return;}
  closeMap();
  let resolved=0;
  const checkReady=()=>{resolved++;if(resolved>=2)showTripSummary(trip);};
  if(startPt)reverseGeocode(startPt.lat,startPt.lng,name=>{trip.startName=name;checkReady();});else{trip.startName='Unknown';checkReady();}
  if(endPt)reverseGeocode(endPt.lat,endPt.lng,name=>{trip.endName=name;checkReady();});else{trip.endName='Unknown';checkReady();}
  document.getElementById('live-panel').classList.remove('show');document.getElementById('idle-speed-wrap').style.display='';document.getElementById('idle-accuracy').style.display='';
  updateDriveUI('saved');document.getElementById('drive-sublabel').textContent=`${saveMiles.toFixed(1)} miles recorded.`;
  setTimeout(()=>updateDriveUI('monitoring'),3000);setGPS('monitoring');stopCounter=0;speedHistory=[];
}

// ===================== TRIP SUMMARY =====================
function showTripSummary(trip){
  pendingSummaryTrip=trip;
  document.getElementById('sum-miles').textContent=trip.miles.toFixed(1);
  document.getElementById('sum-from').textContent=trip.startName;
  document.getElementById('sum-to').textContent=trip.endName;
  const durMin=trip.duration?Math.round(trip.duration/60000):0;
  document.getElementById('sum-dur').textContent=durMin>60?Math.floor(durMin/60)+'h '+durMin%60+'m':durMin+'min';
  document.getElementById('sum-speed').textContent=(trip.duration>0?(trip.miles/(trip.duration/3600000)).toFixed(0):'0')+' mph';
  const autoCat=autoClassifyTrip(trip);document.getElementById('sum-cat').value=autoCat||'unclassified';
  const addrRows=document.getElementById('sum-addr-rows');let addrHtml='';
  [trip.startName,trip.endName].forEach((addr,i)=>{
    if(!addr||addr==='Unknown'||addr==='Locating...')return;
    const saved=getAddrCategory(addr);const bizSel=saved==='business'?' sel':'';const persSel=saved==='personal'?' sel-p':'';
    addrHtml+=`<div class="addr-row"><div class="addr-name">${esc(addr.length>30?addr.substring(0,30)+'...':addr)}</div><div class="addr-btns"><button class="addr-btn${bizSel}" onclick="classifyAddr(this,'${i}','business')">&#128188; Biz</button><button class="addr-btn${persSel}" onclick="classifyAddr(this,'${i}','personal')">&#128100; Personal</button></div></div>`;
  });
  addrRows.innerHTML=addrHtml||'<div style="color:var(--text3);font-size:13px">No addresses to classify</div>';
  document.getElementById('summary-modal').classList.add('show');
}
function classifyAddr(btn,idx,cat){
  const row=btn.parentElement;row.querySelectorAll('.addr-btn').forEach(b=>{b.classList.remove('sel');b.classList.remove('sel-p');});
  btn.classList.add(cat==='business'?'sel':'sel-p');
  const addr=idx==='0'?pendingSummaryTrip.startName:pendingSummaryTrip.endName;
  saveAddrCategory(addr,cat);document.getElementById('sum-cat').value=cat;
}
function saveTripSummary(){
  if(!pendingSummaryTrip)return;
  pendingSummaryTrip.category=document.getElementById('sum-cat').value;
  app.trips.unshift(pendingSummaryTrip);
  setSyncing(true);
  if(window._saveTrip)window._saveTrip(pendingSummaryTrip).then(()=>setSyncing(false));
  save();
  document.getElementById('summary-modal').classList.remove('show');
  updateHomeStats();showToast(`Trip saved: ${pendingSummaryTrip.miles.toFixed(1)} mi`);
  if(app.settings.tripAlerts)addNotification('trip','Trip Saved',`${pendingSummaryTrip.startName} \u2192 ${pendingSummaryTrip.endName}: ${pendingSummaryTrip.miles.toFixed(1)} mi`,'classify');
  pendingSummaryTrip=null;
}

// ===================== MODAL CLOSE ON BACKDROP =====================
document.getElementById('edit-modal').addEventListener('click',function(e){if(e.target===this)closeModal();});
document.getElementById('manual-modal').addEventListener('click',function(e){if(e.target===this)closeManualModal();});
setupDistanceCalc();
// Start with login screen shown (Firebase will trigger showApp when auth state is ready)
showLogin();
</script>
</body>
</html>
